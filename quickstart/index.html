
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Engine for Build Multimodal AI Workflows">
      
      
        <meta name="author" content="Vilson Rodrigues">
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../models/model/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>QuickStart - msgflux</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@8.5.1/dist/mermaid.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#quickstart-pix-voice-text" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="msgflux" class="md-header__button md-logo" aria-label="msgflux" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            msgflux
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              QuickStart
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="indigo"  aria-label="Night"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Night" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="indigo"  aria-label="Sunny"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Sunny" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href=".." class="md-tabs__link">
          
  
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
    
  
  Docs

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../blog/" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="msgflux" class="md-nav__button md-logo" aria-label="msgflux" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    msgflux
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href=".." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Docs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Docs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    QuickStart
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    QuickStart
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-model-class" class="md-nav__link">
    <span class="md-ellipsis">
      The Model Class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Model Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefilling" class="md-nav__link">
    <span class="md-ellipsis">
      Prefilling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typed-parsers" class="md-nav__link">
    <span class="md-ellipsis">
      Typed Parsers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moderation" class="md-nav__link">
    <span class="md-ellipsis">
      Moderation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-embedder" class="md-nav__link">
    <span class="md-ellipsis">
      Text Embedder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-to-image" class="md-nav__link">
    <span class="md-ellipsis">
      Text To Image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#image-text-to-image" class="md-nav__link">
    <span class="md-ellipsis">
      Image Text To Image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-to-speech" class="md-nav__link">
    <span class="md-ellipsis">
      Text To Speech
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speech-to-text" class="md-nav__link">
    <span class="md-ellipsis">
      Speech To Text
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#databases" class="md-nav__link">
    <span class="md-ellipsis">
      DataBases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataBases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kv" class="md-nav__link">
    <span class="md-ellipsis">
      KV
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dotdict" class="md-nav__link">
    <span class="md-ellipsis">
      dotdict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inline" class="md-nav__link">
    <span class="md-ellipsis">
      inline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="inline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditional-boolean" class="md-nav__link">
    <span class="md-ellipsis">
      Conditional Boolean
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#none-check" class="md-nav__link">
    <span class="md-ellipsis">
      None check
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#or-and" class="md-nav__link">
    <span class="md-ellipsis">
      OR, AND
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#not" class="md-nav__link">
    <span class="md-ellipsis">
      NOT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async" class="md-nav__link">
    <span class="md-ellipsis">
      Async
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nn" class="md-nav__link">
    <span class="md-ellipsis">
      nn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="nn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module" class="md-nav__link">
    <span class="md-ellipsis">
      Module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message" class="md-nav__link">
    <span class="md-ellipsis">
      Message
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functional" class="md-nav__link">
    <span class="md-ellipsis">
      Functional
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Learn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Learn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_2_1" id="__nav_2_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ✧ Models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_1">
            <span class="md-nav__icon md-icon"></span>
            ✧ Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model — Unified Interface for AI Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/model_gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ModelGateway — Resilient Model Manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/chat_completion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chat Completion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/moderation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Moderation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/text_embedder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Text embedder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/text_to_speech/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Text to speech
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/speech_to_text/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Speech to text
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/text_to_image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/image_text_to_image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image Edit
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2_2" id="__nav_2_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ⛁ DataBases
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            ⛁ DataBases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/database.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    None
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../databases/vector.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vector
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_2_3" id="__nav_2_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ⟳ Retrievers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_3">
            <span class="md-nav__icon md-icon"></span>
            ⟳ Retrievers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../retrievers/retriever/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Retriever
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../parsers/parser/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ⎙ Parsers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_2_5" id="__nav_2_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ⟢ nn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_5">
            <span class="md-nav__icon md-icon"></span>
            ⟢ nn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../module.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    None
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dependency-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ⇄ Dependency Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_1" >
        
          
          <label class="md-nav__link" for="__nav_2_4_1" id="__nav_2_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_1">
            <span class="md-nav__icon md-icon"></span>
            Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/models/model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/models/model_gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model gateway
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_4_1_3" id="__nav_2_4_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Types
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_4_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_1_3">
            <span class="md-nav__icon md-icon"></span>
            Types
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/models/types/chat_completion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ChatCompletion
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_2" >
        
          
          <label class="md-nav__link" for="__nav_2_4_2" id="__nav_2_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    DataBases
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_2">
            <span class="md-nav__icon md-icon"></span>
            DataBases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/databases/database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_4_2_2" id="__nav_2_4_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Types
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            Types
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/databases/types/kv/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KV
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/databases/types/vector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vector
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_3" >
        
          
          <label class="md-nav__link" for="__nav_2_4_3" id="__nav_2_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    nn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_3">
            <span class="md-nav__icon md-icon"></span>
            nn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/nn/functional/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functional
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/nn/modules/agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../blog/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blog/archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blog/archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blog/category/agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blog/category/multimodal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MultiModal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blog/category/rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blog/category/search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-model-class" class="md-nav__link">
    <span class="md-ellipsis">
      The Model Class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Model Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefilling" class="md-nav__link">
    <span class="md-ellipsis">
      Prefilling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typed-parsers" class="md-nav__link">
    <span class="md-ellipsis">
      Typed Parsers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moderation" class="md-nav__link">
    <span class="md-ellipsis">
      Moderation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-embedder" class="md-nav__link">
    <span class="md-ellipsis">
      Text Embedder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-to-image" class="md-nav__link">
    <span class="md-ellipsis">
      Text To Image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#image-text-to-image" class="md-nav__link">
    <span class="md-ellipsis">
      Image Text To Image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-to-speech" class="md-nav__link">
    <span class="md-ellipsis">
      Text To Speech
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speech-to-text" class="md-nav__link">
    <span class="md-ellipsis">
      Speech To Text
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#databases" class="md-nav__link">
    <span class="md-ellipsis">
      DataBases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataBases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kv" class="md-nav__link">
    <span class="md-ellipsis">
      KV
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dotdict" class="md-nav__link">
    <span class="md-ellipsis">
      dotdict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inline" class="md-nav__link">
    <span class="md-ellipsis">
      inline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="inline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditional-boolean" class="md-nav__link">
    <span class="md-ellipsis">
      Conditional Boolean
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#none-check" class="md-nav__link">
    <span class="md-ellipsis">
      None check
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#or-and" class="md-nav__link">
    <span class="md-ellipsis">
      OR, AND
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#not" class="md-nav__link">
    <span class="md-ellipsis">
      NOT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async" class="md-nav__link">
    <span class="md-ellipsis">
      Async
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nn" class="md-nav__link">
    <span class="md-ellipsis">
      nn
    </span>
  </a>
  
    <nav class="md-nav" aria-label="nn">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module" class="md-nav__link">
    <span class="md-ellipsis">
      Module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message" class="md-nav__link">
    <span class="md-ellipsis">
      Message
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functional" class="md-nav__link">
    <span class="md-ellipsis">
      Functional
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="quickstart-pix-voice-text">Quickstart: PIX --- [Voice, Text]</h1>
<p>This example demonstrates how to create a simple PIX transaction workflow that can handle both text and audio inputs.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">msgflux</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mf</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">msgflux.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">userdata</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">mf</span><span class="o">.</span><span class="n">set_envs</span><span class="p">(</span><span class="n">OPENAI_API_KEY</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="n">chat_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="n">stt_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">speech_to_text</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4o-mini-transcribe&quot;</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">transcriber_configs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;transcriber&quot;</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">stt_model</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="s2">&quot;response_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="s2">&quot;task_multimodal_inputs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;audio&quot;</span><span class="p">:</span> <span class="s2">&quot;user_audio&quot;</span><span class="p">},</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="p">}</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;text -&gt; amount: float, key_type: Literal[&#39;cpf&#39;, &#39;cnpj&#39;, &#39;email&#39;, &#39;phone_number&#39;, &#39;name&#39;], key_id: str&quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="n">agent_configs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;extractor&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">chat_model</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="s2">&quot;signature&quot;</span><span class="p">:</span> <span class="n">signature</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="s2">&quot;response_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;extraction&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="s2">&quot;task_inputs&quot;</span><span class="p">:</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="s2">&quot;task_multimodal_inputs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;user_image&quot;</span><span class="p">}</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="p">}</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="k">class</span><span class="w"> </span><span class="nc">PIX</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_configs</span><span class="p">,</span> <span class="n">transcriber_configs</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">({</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>            <span class="s2">&quot;extractor&quot;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="o">**</span><span class="n">agent_configs</span><span class="p">),</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>            <span class="s2">&quot;transcriber&quot;</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Transcriber</span><span class="p">(</span><span class="o">**</span><span class="n">transcriber_configs</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="p">})</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;{user_audio is not None? transcriber} -&gt; extractor&quot;</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="k">return</span> <span class="n">mf</span><span class="o">.</span><span class="n">inline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="n">pix</span> <span class="o">=</span> <span class="n">PIX</span><span class="p">(</span><span class="n">agent_configs</span><span class="p">,</span> <span class="n">transcriber_configs</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="n">pix</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="n">pix</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="n">pix</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="c1">### Text Input</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="c1"># en: Send 22.40 to 123.456.789-00</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="c1"># cpf: person id at Brazil</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Envie 22,40 para 123.456.789-00&quot;</span><span class="p">})</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">pix</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="n">msg</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="c1">### Audio Input</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="c1"># audio en: &quot;Transfer twenty-three fifty to eighty-four, nine, nine nine, twenty-four, eleven, twenty-one&quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="n">msg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user_audio&quot;</span><span class="p">,</span> <span class="s2">&quot;audio-pix-direct-pt-br.ogg&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">pix</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="n">msg</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a><span class="c1">### Text, Image Input</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
</code></pre></div>
<h2 id="the-model-class">The <code>Model</code> Class</h2>
<p>The <code>Model</code> class in <code>msgFlux</code> serves as a <strong>high-level factory and registry</strong> for loading AI models across various providers and modalities.</p>
<p>It abstracts away boilerplate code and offers a <strong>simple, consistent API</strong> to instantiate models like chatbots, text embedders, speakers, image and video generators, and more.</p>
<p>No need to memorize individual client APIs or custom wrappers. Just specify the model type, path and parameters.</p>
<p><strong>Supported Types</strong></p>
<p>Supports a wide range of AI capabilities:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>chat_completion</code></td>
<td>Understanding and multimodal generation</td>
</tr>
<tr>
<td><code>image_embedder</code></td>
<td>Generates a vector representation of an images</td>
</tr>
<tr>
<td><code>image_text_to_image</code></td>
<td>Image edit</td>
</tr>
<tr>
<td><code>moderation</code></td>
<td>Checks if the content is safe</td>
</tr>
<tr>
<td><code>speech_to_text</code></td>
<td>Voice transcription</td>
</tr>
<tr>
<td><code>text_classifier</code></td>
<td>Classify text</td>
</tr>
<tr>
<td><code>text_embedder</code></td>
<td>Generates a vector representation of a text</td>
</tr>
<tr>
<td><code>text_reranker</code></td>
<td>Rerank text options given a query</td>
</tr>
<tr>
<td><code>text_to_image</code></td>
<td>Image Generation</td>
</tr>
<tr>
<td><code>text_to_speech</code></td>
<td>Generates voice from text</td>
</tr>
</tbody>
</table>
<p><strong>Resilience</strong></p>
<p>API-based models are protected by a decorator (<code>@model_retry</code>) that applies retry in case of failures.</p>
<p>Can manage multiple keys, this is useful in case a key becomes invalid. Separate with commas.</p>
<p><strong>Async</strong></p>
<p>Wait in a non-blocking manner for the model to respond. Use the <code>.acall</code> method to access async mode.</p>
<p><strong>Responses</strong></p>
<p>Each model returns a model response instance. Making the model response type explicit helps manage that response because you already know what's in that object.</p>
<p>The model response which can be one of:</p>
<ol>
<li>
<p><strong>ModelResponse</strong>: Ideal for non-streaming tasks like embeddings, classification, etc.</p>
</li>
<li>
<p><strong>ModelStreamResponse</strong>: Designed for tasks where data is generated in real time — such as text and speech generation, tool-calling, etc.</p>
</li>
</ol>
<p><strong>Serialization</strong></p>
<p>You can export the internal state of an object from a Model.</p>
<p>So re-create a model from a serialized object:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>### **Chat Completion**
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>The `chat_completion` model is the most common and versatile model for natural language interactions.
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>It processes messages in a conversational format and supports advanced features such as multimodal input and output, structured data generation, and tool (function) calls.
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>**Stateless**
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>Chat completion models do **not maintain** state between calls.
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>All context information (previous messages, system_prompt, etc.) must be provided on each new call.
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>```python
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a># init schema pass &quot;provider/model_id&quot;
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a># optionally pass class initialization parameters
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>chat_model = mf.Model.chat_completion(&quot;openai/gpt-4.1-nano&quot;)
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>chat_model.get_model_info()
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>chat_model.instance_type()
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>model_state = chat_model.serialize()
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>model_state
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>mf.save(model_state, &quot;model_state.json&quot;)
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a># Basic input
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>response = chat_model(messages=&quot;Hello!&quot;, system_prompt=&quot;You are a helpful assistant.&quot;)
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>response.metadata
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>response.response_type
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a># alias to response.data
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>response.consume()
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>#### **Async**
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>reponse = await chat_model.acall(&quot;Tell me a joke&quot;)
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>response.consume()
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>#### **Stream**
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>`stream` allows you to stream tokens as they are generated.
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>You can use `stream` mode with both `generation_schema` and tools.
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>response = chat_model(&quot;Hi, how are you?&quot;, stream=True)
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>print(type(response))
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>print(response.response_type)
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a># fastapi.StreamingResponse compatible
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>async for chunk in response.consume():
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>    print(chunk, end=&quot;&quot;, flush=True)
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>response.metadata
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>#### **MultiModal**
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a># @title **Flow**
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>mermaid_code = &quot;&quot;&quot;
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>flowchart LR
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>    Text[&quot;Text&quot;]
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>    Image[&quot;Image&quot;]
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>    Video[&quot;Video&quot;]
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>    Sound[&quot;Sound&quot;]
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>    Code[&quot;Code&quot;]
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>    LM[&quot;LM&quot;]
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>    OutText[&quot;Text&quot;]
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>    OutImage[&quot;Image&quot;]
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>    OutVideo[&quot;Video&quot;]
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>    OutSound[&quot;Sound&quot;]
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>    OutCode[&quot;Code&quot;]
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>    Text e1@==&gt; LM
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>    e1@{animate: true}
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>    Image e2@==&gt; LM
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>    e2@{animate: true}
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>    Video e3@==&gt; LM
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>    e3@{animate: true}
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>    Sound e4@==&gt; LM
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>    e4@{animate: true}
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>    Code e5@==&gt; LM
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>    e5@{animate: true}
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>    LM e6@==&gt; OutText
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>    e6@{animate: true}
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>    LM e7@==&gt; OutImage
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>    e7@{animate: true}
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>from msgflux.utils.mermaid import plot_mermaid
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>plot_mermaid(mermaid_code)
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>messages=[{
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>        &quot;role&quot;: &quot;user&quot;,
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>        &quot;content&quot;: [
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>            {&quot;type&quot;: &quot;text&quot;, &quot;text&quot;: &quot;What&#39;s in this image?&quot;},
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>            {
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>                &quot;type&quot;: &quot;image_url&quot;,
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>                &quot;image_url&quot;: {
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>                    &quot;url&quot;: &quot;https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Gfp-wisconsin-madison-the-nature-boardwalk.jpg/2560px-Gfp-wisconsin-madison-the-nature-boardwalk.jpg&quot;,
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a>                },
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>            },
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>        ],
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>    }]
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a># or using chat blocks
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>from msgflux import ChatBlock
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>messages = [
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>    ChatBlock.user(
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>        &quot;What&#39;s in this image?&quot;,
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>        media=ChatBlock.image(&quot;https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Gfp-wisconsin-madison-the-nature-boardwalk.jpg/2560px-Gfp-wisconsin-madison-the-nature-boardwalk.jpg&quot;)
<a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>    )
<a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>]
<a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>
<a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>messages
<a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a>
<a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a>response = chat_model(messages=messages)
<a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>
<a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>response.metadata
<a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>
<a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>response.consume()
<a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>
<a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a>For other modalities, see the `task multimodal inputs` section in `nn.Agent`
<a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a>
<a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a>#### **Generation Schemas**
<a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a>
<a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a>**Structured Generation**
<a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a>
<a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a>The model can be guided to produce structured responses according to a user-defined schema.
<a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a>
<a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>In msgFlux this is called `generation_schema`.
<a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a>
<a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>The name shows not only that the model produces a `structured output`, but also that it follows a schema.
<a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a>
<a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a>The models write an encoded JSON that is decoded by the Struct and then transformed into a dict.
<a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a>
<a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a>For this, we use `msgspec.Struct` as the structure format:
<a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a>
<a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a>```python
<a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a># structured response
<a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a># https://jcristharif.com/msgspec/benchmarks.html
<a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a>from msgspec import Struct
<a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a>
<a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a>class CalendarEvent(Struct):
<a id="__codelineno-1-153" name="__codelineno-1-153" href="#__codelineno-1-153"></a>    name: str
<a id="__codelineno-1-154" name="__codelineno-1-154" href="#__codelineno-1-154"></a>    date: str
<a id="__codelineno-1-155" name="__codelineno-1-155" href="#__codelineno-1-155"></a>    participants: list[str]
<a id="__codelineno-1-156" name="__codelineno-1-156" href="#__codelineno-1-156"></a>
<a id="__codelineno-1-157" name="__codelineno-1-157" href="#__codelineno-1-157"></a>response = chat_model(
<a id="__codelineno-1-158" name="__codelineno-1-158" href="#__codelineno-1-158"></a>    messages=&quot;Alice and Bob are going to a science fair on Friday.&quot;,
<a id="__codelineno-1-159" name="__codelineno-1-159" href="#__codelineno-1-159"></a>    system_prompt=&quot;Extract the event information.&quot;,
<a id="__codelineno-1-160" name="__codelineno-1-160" href="#__codelineno-1-160"></a>    generation_schema=CalendarEvent
<a id="__codelineno-1-161" name="__codelineno-1-161" href="#__codelineno-1-161"></a>)
<a id="__codelineno-1-162" name="__codelineno-1-162" href="#__codelineno-1-162"></a>
<a id="__codelineno-1-163" name="__codelineno-1-163" href="#__codelineno-1-163"></a>response.metadata
<a id="__codelineno-1-164" name="__codelineno-1-164" href="#__codelineno-1-164"></a>
<a id="__codelineno-1-165" name="__codelineno-1-165" href="#__codelineno-1-165"></a>response.consume()
</code></pre></div>
<p><code>generation_schema</code> maybe the most important feature in <code>chat_completion</code> models.</p>
<p>This feature enables things like <code>ReAct</code>, <code>CoT</code>, new content generation, guided data extraction, etc.</p>
<p>In this framework following tutorials we make extensive use of it.</p>
<h4 id="tools"><strong>Tools</strong></h4>
<p>When we provide a set of tools (<code>tool_schemas</code>), the model may <strong>suggest</strong> that one of them be called—but it does not automatically execute them.</p>
<p>Instead, it returns a call intent, which is captured and processed by an internal component called the <code>ToolCallAggregator</code>.</p>
<p>This class collects and organizes tool calls suggested by the model, especially in streaming mode, where arguments arrive in fragmented form.</p>
<p>Main responsibilities:</p>
<ul>
<li>
<p>Reassemble parts of calls during the stream (<code>process</code>)</p>
</li>
<li>
<p>Convert raw data into complete functional calls (<code>get_calls</code>)</p>
</li>
<li>
<p>Insert tool results (<code>insert_results</code>)</p>
</li>
<li>
<p>Generate messages in the correct format to follow the flow with the model (<code>get_messages</code>)</p>
</li>
</ul>
<p>Use <code>tool_choice</code> to control tool calling mode:</p>
<div class="highlight"><pre><span></span><code>By default the model will determine when and how many tools to use.
You can force specific behavior with the tool_choice parameter.
    1. auto:
        Call zero, one, or multiple functions. tool_choice: &quot;auto&quot;
    2. required:
        Call one or more functions. tool_choice: &quot;required&quot;
    3. Forced Function:
        Call exactly one specific function. E.g. &quot;add&quot;.
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;get_weather&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Get current temperature for a given location.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>                <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;City and country e.g. Bogotá, Colombia&quot;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>                <span class="p">}</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>            <span class="p">},</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>                <span class="s2">&quot;location&quot;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>            <span class="p">],</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>            <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="p">},</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="c1"># Model client change to True in runtime</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>    <span class="p">}</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="p">}]</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="n">response</span> <span class="o">=</span> <span class="n">chat_model</span><span class="p">(</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="n">messages</span><span class="o">=</span><span class="s2">&quot;What is the weather like in Paris today?&quot;</span><span class="p">,</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>    <span class="n">tool_schemas</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>    <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&quot;required&quot;</span><span class="p">,</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="p">)</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="n">response</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="n">tool_call_agg</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="n">tool_call_agg</span><span class="o">.</span><span class="n">get_calls</span><span class="p">()</span>
</code></pre></div>
<h4 id="prefilling"><strong>Prefilling</strong></h4>
<p>Prefilling in <code>chat_completion</code> models is the process of inserting a partial message from the assistant itself into the conversation history <em>before</em> the model continues generating.</p>
<p>Unlike simply adding a complete response, prefilling forces the model to begin its output from a predefined initial text.</p>
<ol>
<li>
<p>Normal case:</p>
</li>
<li>
<p>User: <code>&lt;task&gt;</code></p>
</li>
<li>
<p>Assistant: <code>&lt;response&gt;</code></p>
</li>
<li>
<p>Prefilling enabled:</p>
</li>
<li>
<p>User: <code>&lt;task&gt;</code></p>
</li>
<li>
<p>Assistant: <code>&lt;prefilling_content&gt;</code> (Not visible to user)</p>
</li>
<li>
<p>Assistant: <code>&lt;response&gt;</code></p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">response</span> <span class="o">=</span> <span class="n">chat_model</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="s2">&quot;how much is (30x3 + 33)?&quot;</span><span class="p">,</span> <span class="n">prefilling</span><span class="o">=</span><span class="s2">&quot;Let&#39;s think step by step&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">response</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
</code></pre></div>
<h4 id="typed-parsers"><strong>Typed Parsers</strong></h4>
<p>For structured generation, the common way to get a response from a model is to have it write an encoded JSON, as we saw earlier.</p>
<p>Models need to be trained to generate output in this format.</p>
<p>In contrast, most models are excellent at writing XML.</p>
<p>In <code>msgFlux</code>, we introduce a typed-XML paradigm, where the model specifies the type of data it is generating.</p>
<p>We just need to demonstrate how to write it.</p>
<p><strong>Note</strong>: By default XML consumes more tokens than JSON</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.dsl.typed_parsers</span><span class="w"> </span><span class="kn">import</span> <span class="n">typed_parser_registry</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">typed_xml</span> <span class="o">=</span> <span class="n">typed_parser_registry</span><span class="p">[</span><span class="s2">&quot;typed_xml&quot;</span><span class="p">]</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">typed_xml</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
</code></pre></div>
<h3 id="moderation"><strong>Moderation</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">moderation_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">moderation</span><span class="p">(</span><span class="s2">&quot;openai/omni-moderation-latest&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">moderation_model</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">moderation_model</span><span class="o">.</span><span class="n">instance_type</span><span class="p">()</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">moderation_model</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="n">response</span> <span class="o">=</span> <span class="n">moderation_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;wars are the best way to live&quot;</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="n">model_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="c1"># moderation models returns a &#39;safe&#39; flag</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="n">model_response</span><span class="o">.</span><span class="n">safe</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="n">model_response</span>
</code></pre></div>
<h3 id="text-embedder"><strong>Text Embedder</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">embedder_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">text_embedder</span><span class="p">(</span><span class="s2">&quot;openai/text-embedding-3-small&quot;</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">embedder_model</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">embedder_model</span><span class="o">.</span><span class="n">instance_type</span><span class="p">()</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="n">embedder_model</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="n">response</span> <span class="o">=</span> <span class="n">embedder_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;wars are the best way to live&quot;</span><span class="p">)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="n">response</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
</code></pre></div>
<h3 id="text-to-image"><strong>Text To Image</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">imagegen_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">text_to_image</span><span class="p">(</span><span class="s2">&quot;openai/gpt-image-1&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;1024x1024&quot;</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">imagegen_model</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">imagegen_model</span><span class="o">.</span><span class="n">instance_type</span><span class="p">()</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">imagegen_model</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="s2">A children&#39;s book drawing of a veterinarian using a stethoscope to</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="s2">listen to the heartbeat of a baby otter.</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="n">response</span> <span class="o">=</span> <span class="n">imagegen_model</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="n">metadata</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="n">metadata</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="n">images</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
</code></pre></div>
<h3 id="image-text-to-image"><strong>Image Text To Image</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">imageedit_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">image_text_to_image</span><span class="p">(</span><span class="s2">&quot;openai/gpt-image-1&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;1024x1024&quot;</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="s2">&quot;https://cdn.openai.com/API/docs/images/body-lotion.png&quot;</span><span class="p">,</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="s2">&quot;https://cdn.openai.com/API/docs/images/bath-bomb.png&quot;</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="s2">&quot;https://cdn.openai.com/API/docs/images/incense-kit.png&quot;</span><span class="p">,</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="s2">&quot;https://cdn.openai.com/API/docs/images/soap.png&quot;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="p">]</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="s2">Generate a photorealistic image of a gift basket on a white background</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="s2">labeled &#39;Relax &amp; Unwind&#39; with a ribbon and handwriting-like font,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="s2">containing all the items in the reference pictures.</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="n">response</span> <span class="o">=</span> <span class="n">imageedit_model</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">urls</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="n">metadata</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="n">metadata</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="n">image</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="n">image_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image_edit.</span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">output_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="c1"># image edit with mask</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;https://cdn.openai.com/API/docs/images/sunlit_lounge.png&quot;</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="n">mask</span> <span class="o">=</span> <span class="s2">&quot;https://cdn.openai.com/API/docs/images/mask.png&quot;</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;A sunlit indoor lounge area with a pool containing a flamingo&quot;</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="n">response</span> <span class="o">=</span> <span class="n">imageedit_model</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="n">response</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="n">image</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="n">image_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image_edit_with_mask.</span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">output_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">)</span>
</code></pre></div>
<h3 id="text-to-speech"><strong>Text To Speech</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">speech_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">text_to_speech</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4o-mini-tts&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">voice</span><span class="o">=</span><span class="s2">&quot;coral&quot;</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">speech_model</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">speech_model</span><span class="o">.</span><span class="n">instance_type</span><span class="p">()</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">speech_model</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="n">response</span> <span class="o">=</span> <span class="n">speech_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;Today is a wonderful day to build something people love!&quot;</span><span class="p">)</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">()</span>
</code></pre></div>
<h3 id="speech-to-text"><strong>Speech To Text</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">transcriber_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">speech_to_text</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4o-mini-transcribe&quot;</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">transcriber_model</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">transcriber_model</span><span class="o">.</span><span class="n">instance_type</span><span class="p">()</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">transcriber_model</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="n">response</span> <span class="o">=</span> <span class="n">transcriber_model</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;local/audio.mp3&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="databases"><strong>DataBases</strong></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">mf</span><span class="o">.</span><span class="n">DataBase</span><span class="o">.</span><span class="n">supported_db_types</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">mf</span><span class="o">.</span><span class="n">DataBase</span><span class="o">.</span><span class="n">providers_by_db_type</span>
</code></pre></div>
<h3 id="kv"><strong>KV</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">cachetools_kv</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">DataBase</span><span class="o">.</span><span class="n">kv</span><span class="p">(</span><span class="s2">&quot;cachetools&quot;</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">hash_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c1"># or</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c1"># !pip install diskcache</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># diskcache_kv = mf.DataBase.kv(&quot;diskcache&quot;)</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">cachetools_kv</span><span class="o">.</span><span class="n">instance_type</span><span class="p">()</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="n">cachetools_kv</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="c1"># add single document</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="n">cachetools_kv</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s2">&quot;user:1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}})</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="c1"># add a list of documents</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="n">cachetools_kv</span><span class="o">.</span><span class="n">add</span><span class="p">([</span>
</code></pre></div>
<h2 id="dotdict"><strong>dotdict</strong></h2>
<p>A dictionary with dot access and nested path support.</p>
<p>dotdict allows you to access and modify values as attributes (e.g., <code>obj.key</code>) and also allows reading and writing nested paths using strings with dot separators (e.g., <code>obj.get("user.profile.name")</code>).</p>
<div class="highlight"><pre><span></span><code>Main features:
- Dot access (`obj.key`)
- Traditional square bracket access (`obj[&#39;key&#39;]`)
- Nested reading via `.get(&quot;a.b.c&quot;)`
- Nested writing via `.set(&quot;a.b.c&quot;, value)`
- Conversion to standard dict with `.to_dict()`
- Support for Msgspec serialization (`__json__`)
- Support for lists with path indices (e.g., `&quot;items.0.name&quot;`)
- Optional immutability (`frozen=True`)
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux</span><span class="w"> </span><span class="kn">import</span> <span class="n">dotdict</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">dotdict</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">container</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">({</span><span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;valor1&quot;</span><span class="p">,</span> <span class="s2">&quot;valor2&quot;</span><span class="p">]})</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">)</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="c1"># nested</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="n">container</span><span class="o">.</span><span class="n">agent</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="n">container</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent.0&quot;</span><span class="p">)</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="c1"># does not work if the last value is a position in the list</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="c1"># container.agent.0</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="c1"># nested set</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="n">container</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Hello World!&quot;</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="n">container</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Diana&quot;</span><span class="p">})</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="n">container</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="n">container</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">user_name</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="c1"># multi-level insert</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="n">msg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;texts.inputs.first&quot;</span><span class="p">,</span> <span class="s2">&quot;A long time ago&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="inline"><strong>inline</strong></h2>
<p><strong><em>inline</em></strong> allows orchestrate modules using a simple statement-based <em>declarative</em> language.</p>
<p>With <strong><em>inline</em></strong> you can change your workflow at runtime <em>without</em> changing script.</p>
<p>See below everything you can do with her:</p>
<p>➡️ <strong>Sequential Execution</strong></p>
<p>Use "-&gt;" to define the execution order of the modules.</p>
<blockquote>
<p>"prep -&gt; transform -&gt; output"</p>
</blockquote>
<p>🔀 <strong>Parallel Execution</strong></p>
<p>Use watches [...] to perform modules in parallel.</p>
<blockquote>
<p>"prep -&gt; [feat_a, feat_b] -&gt; combine"</p>
</blockquote>
<p>❓ <strong>Condition (if-else)</strong></p>
<p>Use keys with notation {condition? So if not} for branches.</p>
<blockquote>
<p>"{user.age &gt; 18 ? adult_module, child_module}"</p>
</blockquote>
<p>You can also omit the "if not" module:</p>
<blockquote>
<p>"{user.is_active ? send_email}"</p>
</blockquote>
<p>⚙️  <strong>Logical Operators under Conditions</strong></p>
<p>You can combine multiple conditions with logical operators:</p>
<table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&amp;</code></td>
<td>AND</td>
<td><code>is_admin == true &amp; is_active == true</code></td>
</tr>
<tr>
<td><code>\|\|</code></td>
<td>OR</td>
<td><code>is_premium == true \|\| has_coupon == true</code></td>
</tr>
<tr>
<td><code>!</code></td>
<td>NOT</td>
<td><code>!(user.is_banned == true)</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>"{user.is_active == true &amp; !user.is_banned == true ? grant_access, deny_access}"</p>
</blockquote>
<p>🚫 <strong>None Verification</strong></p>
<p>You can also check if a field is None or not:</p>
<blockquote>
<p>"user.name is None"</p>
<p>"user.name is not None"</p>
<p>"{user.name is None ? ask_name, greet_user}"</p>
</blockquote>
<p>In addition to a notation, you must pass a mapping containing the name of the module that will be called within the notation and as value the chamable object.
You must also pass a <code>dotdict</code> (or <code>Message</code>) object.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">dotdict</span><span class="p">,</span> <span class="n">inline</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1">#### **Sequential pipeline**</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="c1"># pass an empty message and enrich during execution</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">prep</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">prep_done</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prep_done&quot;</span><span class="p">):</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="n">msg</span><span class="o">.</span><span class="n">transformed</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">transformed</span><span class="p">)</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="s2">&quot;prep&quot;</span><span class="p">:</span> <span class="n">prep</span><span class="p">,</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="p">}</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="n">message</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="n">inline</span><span class="p">(</span><span class="s2">&quot;prep -&gt; transform -&gt; output&quot;</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="c1">#### **Parallel Execution**</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="n">Parallel</span> <span class="n">use</span> <span class="err">`</span><span class="n">msg_bcast_gather</span><span class="err">`</span><span class="o">.</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="n">It</span> <span class="ow">is</span> <span class="n">essential</span> <span class="n">that</span> <span class="n">you</span> <span class="n">do</span> <span class="o">**</span><span class="ow">not</span> <span class="n">modify</span><span class="o">**</span> <span class="n">the</span> <span class="n">message</span> <span class="n">within</span> <span class="n">the</span> <span class="n">function</span><span class="o">.</span> <span class="n">This</span> <span class="n">can</span> <span class="n">cause</span> <span class="n">race</span> <span class="n">condition</span><span class="o">.</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="n">You</span> <span class="n">can</span> <span class="n">still</span> <span class="n">access</span> <span class="n">the</span> <span class="n">message</span> <span class="n">values</span><span class="o">.</span> <span class="n">To</span> <span class="n">make</span> <span class="n">modifications</span> <span class="n">you</span> <span class="n">must</span> <span class="k">return</span> <span class="n">the</span> <span class="n">value</span><span class="o">.</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="s1">&#39;msg_bcast_gather&#39;</span> <span class="n">will</span> <span class="n">save</span> <span class="k">as</span> <span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;module_name&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">ingestion</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>    <span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;features.a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>    <span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;features.b&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>    <span class="k">return</span> <span class="n">message</span>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">feat_a</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>    <span class="n">new_features</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;new_features&quot;</span><span class="p">:</span> <span class="n">new_features</span><span class="p">}</span>
<a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a>
<a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a><span class="k">def</span><span class="w"> </span><span class="nf">feat_b</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>    <span class="n">new_features</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;new_features&quot;</span><span class="p">:</span> <span class="n">new_features</span><span class="p">}</span>
<a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>
<a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a><span class="k">def</span><span class="w"> </span><span class="nf">combine</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">feat_a</span><span class="o">.</span><span class="n">new_features</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">feat_b</span><span class="o">.</span><span class="n">new_features</span>
<a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a>
<a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a><span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a>    <span class="s2">&quot;prep&quot;</span><span class="p">:</span> <span class="n">ingestion</span><span class="p">,</span>
<a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a>    <span class="s2">&quot;feat_a&quot;</span><span class="p">:</span> <span class="n">feat_a</span><span class="p">,</span>
<a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>    <span class="s2">&quot;feat_b&quot;</span><span class="p">:</span> <span class="n">feat_b</span><span class="p">,</span>
<a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>    <span class="s2">&quot;combine&quot;</span><span class="p">:</span> <span class="n">combine</span><span class="p">,</span>
<a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a><span class="p">}</span>
<a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>
<a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a><span class="n">message</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a><span class="n">inline</span><span class="p">(</span><span class="s2">&quot;prep -&gt; [feat_a, feat_b] -&gt; combine&quot;</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>
<a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a><span class="c1">#### **Simple Conditional**</span>
<a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a>
<a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">adult</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;Welcome, adult&quot;</span>
<a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-14-70" name="__codelineno-14-70" href="#__codelineno-14-70"></a>
<a id="__codelineno-14-71" name="__codelineno-14-71" href="#__codelineno-14-71"></a><span class="k">def</span><span class="w"> </span><span class="nf">child</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-14-72" name="__codelineno-14-72" href="#__codelineno-14-72"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;Hi, young one&quot;</span>
<a id="__codelineno-14-73" name="__codelineno-14-73" href="#__codelineno-14-73"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-14-74" name="__codelineno-14-74" href="#__codelineno-14-74"></a>
<a id="__codelineno-14-75" name="__codelineno-14-75" href="#__codelineno-14-75"></a><span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-14-76" name="__codelineno-14-76" href="#__codelineno-14-76"></a>    <span class="s2">&quot;adult_module&quot;</span><span class="p">:</span> <span class="n">adult</span><span class="p">,</span>
<a id="__codelineno-14-77" name="__codelineno-14-77" href="#__codelineno-14-77"></a>    <span class="s2">&quot;child_module&quot;</span><span class="p">:</span> <span class="n">child</span><span class="p">,</span>
<a id="__codelineno-14-78" name="__codelineno-14-78" href="#__codelineno-14-78"></a><span class="p">}</span>
<a id="__codelineno-14-79" name="__codelineno-14-79" href="#__codelineno-14-79"></a>
<a id="__codelineno-14-80" name="__codelineno-14-80" href="#__codelineno-14-80"></a><span class="n">message</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-14-81" name="__codelineno-14-81" href="#__codelineno-14-81"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.age&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<a id="__codelineno-14-82" name="__codelineno-14-82" href="#__codelineno-14-82"></a>
<a id="__codelineno-14-83" name="__codelineno-14-83" href="#__codelineno-14-83"></a><span class="n">inline</span><span class="p">(</span><span class="s2">&quot;{user.age &gt; 18 ? adult_module, child_module}&quot;</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-14-84" name="__codelineno-14-84" href="#__codelineno-14-84"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>  <span class="c1"># &quot;Welcome, adult&quot;</span>
</code></pre></div>
<h4 id="conditional-boolean"><strong>Conditional Boolean</strong></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">grant</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;granted&quot;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">deny</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">access</span> <span class="o">=</span> <span class="s2">&quot;denied&quot;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="s2">&quot;grant_access&quot;</span><span class="p">:</span> <span class="n">grant</span><span class="p">,</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="s2">&quot;deny_access&quot;</span><span class="p">:</span> <span class="n">deny</span><span class="p">,</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="p">}</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="n">message</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.is_active&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.is_banned&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="n">inline</span><span class="p">(</span><span class="s2">&quot;{user.is_active == True &amp; !user.is_banned  == True ? grant_access, deny_access}&quot;</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">access</span><span class="p">)</span>  <span class="c1"># &quot;granted&quot;</span>
</code></pre></div>
<h4 id="none-check"><strong>None check</strong></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">ask_name</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;Please enter your name&quot;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">greeting</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="s2">&quot;ask_name&quot;</span><span class="p">:</span> <span class="n">ask_name</span><span class="p">,</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="s2">&quot;greet_user&quot;</span><span class="p">:</span> <span class="n">greet</span><span class="p">,</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="p">}</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="n">message</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="n">inline</span><span class="p">(</span><span class="s2">&quot;{user.name is None ? ask_name, greet_user}&quot;</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span>  <span class="c1"># &quot;Please enter your name&quot;</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="n">message</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Bruce&quot;</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="n">inline</span><span class="p">(</span><span class="s2">&quot;{user.name is None ? ask_name, greet_user}&quot;</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">greeting</span><span class="p">)</span>  <span class="c1"># &quot;Hello, Bruce&quot;</span>
</code></pre></div>
<h4 id="or-and"><strong>OR, AND</strong></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">premium_flow</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="s2">&quot;premium&quot;</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">standard_flow</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="s2">&quot;premium_flow&quot;</span><span class="p">:</span> <span class="n">premium_flow</span><span class="p">,</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="s2">&quot;standard_flow&quot;</span><span class="p">:</span> <span class="n">standard_flow</span><span class="p">,</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="p">}</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="n">message</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.type&quot;</span><span class="p">,</span> <span class="s2">&quot;premium&quot;</span><span class="p">)</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.credits&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.status&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">)</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="c1"># OR</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="n">inline</span><span class="p">(</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>    <span class="s2">&quot;{user.type == &#39;premium&#39; || user.credits &gt; 100 ? premium_flow, standard_flow}&quot;</span><span class="p">,</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>    <span class="n">modules</span><span class="p">,</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>    <span class="n">message</span><span class="p">,</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="p">)</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>  <span class="c1"># &quot;premium&quot;</span>
</code></pre></div>
<h4 id="not"><strong>NOT</strong></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;processed&quot;</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">deny_request</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;denied&quot;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="n">modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="s2">&quot;process_request&quot;</span><span class="p">:</span> <span class="n">process_request</span><span class="p">,</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    <span class="s2">&quot;deny_request&quot;</span><span class="p">:</span> <span class="n">deny_request</span><span class="p">,</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="p">}</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="n">message</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.banned&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="n">message</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;user.credits&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="n">inline</span><span class="p">(</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>    <span class="s2">&quot;{!(user.banned == true || user.credits &lt;= 0) ? process_request, deny_request}&quot;</span><span class="p">,</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>    <span class="n">modules</span><span class="p">,</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>    <span class="n">message</span><span class="p">,</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="p">)</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>  <span class="c1"># &quot;processed&quot;</span>
</code></pre></div>
<h4 id="async"><strong>Async</strong></h4>
<p>Waitable version of <code>inline</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux</span><span class="w"> </span><span class="kn">import</span> <span class="n">ainline</span><span class="p">,</span> <span class="n">dotdict</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">prep</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">dotdict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dotdict</span><span class="p">:</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing prep, current msg: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="s1">&#39;xpto&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">}</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;counter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">dotdict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dotdict</span><span class="p">:</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing increment, current msg: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;counter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">feat_a</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">dotdict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dotdict</span><span class="p">:</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing feat_a, current msg: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;feat_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;result_a&#39;</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">feat_b</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">dotdict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dotdict</span><span class="p">:</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing feat_b, current msg: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;feat_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;result_b&#39;</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">final</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">dotdict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dotdict</span><span class="p">:</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing final, current msg: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>    <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;done&#39;</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="n">my_modules</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>    <span class="s2">&quot;prep&quot;</span><span class="p">:</span> <span class="n">prep</span><span class="p">,</span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>    <span class="s2">&quot;increment&quot;</span><span class="p">:</span> <span class="n">increment</span><span class="p">,</span>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>    <span class="s2">&quot;feat_a&quot;</span><span class="p">:</span> <span class="n">feat_a</span><span class="p">,</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>    <span class="s2">&quot;feat_b&quot;</span><span class="p">:</span> <span class="n">feat_b</span><span class="p">,</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>    <span class="s2">&quot;final&quot;</span><span class="p">:</span> <span class="n">final</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="p">}</span>
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="n">input_msg</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
<a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>
<a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="c1"># Example with while loop</span>
<a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ainline</span><span class="p">(</span>
<a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>    <span class="s2">&quot;prep -&gt; @{counter &lt; 5}: increment; -&gt; final&quot;</span><span class="p">,</span>
<a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>    <span class="n">modules</span><span class="o">=</span><span class="n">my_modules</span><span class="p">,</span>
<a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>    <span class="n">message</span><span class="o">=</span><span class="n">input_msg</span>
<a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="p">)</span>
<a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a><span class="n">result</span>
<a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>
<a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a><span class="c1"># Example with nested while loop and other constructs</span>
<a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ainline</span><span class="p">(</span>
<a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>    <span class="s2">&quot;prep -&gt; @{counter &lt; 3}: increment -&gt; [feat_a, feat_b]; -&gt; final&quot;</span><span class="p">,</span>
<a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>    <span class="n">modules</span><span class="o">=</span><span class="n">my_modules</span><span class="p">,</span>
<a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>    <span class="n">message</span><span class="o">=</span><span class="n">input_msg</span>
<a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a><span class="p">)</span>
<a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a><span class="n">result</span>
</code></pre></div>
<h2 id="nn"><strong>nn</strong></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">msgflux.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</code></pre></div>
<h3 id="module"><strong>Module</strong></h3>
<p><strong>Main features</strong>:</p>
<ul>
<li>
<p>Advanced param serialization</p>
</li>
<li>
<p>Update params with zero reload</p>
</li>
<li>
<p>Built-in atomic Modules for fast workflow build</p>
</li>
<li>
<p>OpenTelemetry integration</p>
</li>
<li>
<p>Async interface (<code>.acall</code>). The module will look for an implementation of <code>aforward</code>, if it doesn't find one it will direct to <code>forward</code>.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># similar pytorch api</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="c1"># advanced state_dict</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="c1"># able to create/update components in runtime</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c1"># each buffer or parameter is registred in state dict</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Workflow</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instructions</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s2">&quot;&lt;param_content&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;spec&gt;&quot;</span><span class="p">)</span> <span class="c1"># will can be optimized</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;expected_output&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;expected_output&gt;&quot;</span><span class="p">)</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="n">Workflow</span><span class="p">()</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="c1"># logic is difined in &#39;forward&#39;</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="c1"># able hooks pre and post forward</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes I did.&quot;</span><span class="p">)</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>        <span class="n">user_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>        <span class="k">if</span> <span class="n">user_name</span><span class="p">:</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>            <span class="n">model_response</span> <span class="o">=</span> <span class="s2">&quot; Hi &quot;</span> <span class="o">+</span> <span class="n">user_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>            <span class="n">model_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">model_response</span>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">retrieve_user_name</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a>    <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="s2">&quot;123&quot;</span><span class="p">:</span>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>        <span class="k">return</span> <span class="s2">&quot;Clark&quot;</span>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="k">def</span><span class="w"> </span><span class="nf">pre_hook</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>    <span class="c1"># enhance context</span>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">):</span>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>        <span class="n">user_name</span> <span class="o">=</span> <span class="n">retrieve_user_name</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;user_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_name</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>
<a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">post_hook</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
<a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inpect output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>    <span class="k">return</span> <span class="n">output</span>
<a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>
<a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
<a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>
<a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="c1"># plot mermaid flow</span>
<a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>
<a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a><span class="c1"># note that flows are still **experimental** and can be wrong</span>
<a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a><span class="c1"># if they have too many if and else statements inside others.</span>
<a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a>
<a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a><span class="c1"># By default, &quot;.self&quot; characters are suppressed to make plots</span>
<a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a><span class="c1"># more readable. But you can pass `remove_self=False`</span>
<a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a><span class="n">model</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a>
<a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a><span class="c1"># hooks returns a handle object</span>
<a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a><span class="n">pre_hook_handle</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">register_forward_pre_hook</span><span class="p">(</span><span class="n">pre_hook</span><span class="p">)</span>
<a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a><span class="n">post_hook_handle</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">post_hook</span><span class="p">)</span>
<a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a>
<a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a><span class="n">model</span><span class="o">.</span><span class="n">_forward_pre_hooks</span>
<a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a>
<a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a><span class="n">model</span><span class="o">.</span><span class="n">_forward_hooks</span>
<a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a>
<a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a><span class="n">input_x</span> <span class="o">=</span> <span class="s2">&quot;You did the work?&quot;</span>
<a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">}</span>
<a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a><span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a>
<a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a><span class="c1"># remove hooks (optional)</span>
<a id="__codelineno-21-75" name="__codelineno-21-75" href="#__codelineno-21-75"></a><span class="n">pre_hook_handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<a id="__codelineno-21-76" name="__codelineno-21-76" href="#__codelineno-21-76"></a><span class="n">post_hook_handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<a id="__codelineno-21-77" name="__codelineno-21-77" href="#__codelineno-21-77"></a>
<a id="__codelineno-21-78" name="__codelineno-21-78" href="#__codelineno-21-78"></a><span class="n">result_without_hooks</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-21-79" name="__codelineno-21-79" href="#__codelineno-21-79"></a><span class="nb">print</span><span class="p">(</span><span class="n">result_without_hooks</span><span class="p">)</span>
<a id="__codelineno-21-80" name="__codelineno-21-80" href="#__codelineno-21-80"></a>
<a id="__codelineno-21-81" name="__codelineno-21-81" href="#__codelineno-21-81"></a><span class="c1"># save state dict</span>
<a id="__codelineno-21-82" name="__codelineno-21-82" href="#__codelineno-21-82"></a><span class="c1"># format: default is toml but json also</span>
<a id="__codelineno-21-83" name="__codelineno-21-83" href="#__codelineno-21-83"></a><span class="n">mf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;state_dict.toml&quot;</span><span class="p">)</span>
<a id="__codelineno-21-84" name="__codelineno-21-84" href="#__codelineno-21-84"></a>
<a id="__codelineno-21-85" name="__codelineno-21-85" href="#__codelineno-21-85"></a><span class="n">state_dict</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;state_dict.toml&quot;</span><span class="p">)</span>
<a id="__codelineno-21-86" name="__codelineno-21-86" href="#__codelineno-21-86"></a>
<a id="__codelineno-21-87" name="__codelineno-21-87" href="#__codelineno-21-87"></a><span class="n">state_dict</span>
<a id="__codelineno-21-88" name="__codelineno-21-88" href="#__codelineno-21-88"></a>
<a id="__codelineno-21-89" name="__codelineno-21-89" href="#__codelineno-21-89"></a><span class="c1"># update param</span>
<a id="__codelineno-21-90" name="__codelineno-21-90" href="#__codelineno-21-90"></a><span class="n">state_dict</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No, I didn&#39;t.&quot;</span>
<a id="__codelineno-21-91" name="__codelineno-21-91" href="#__codelineno-21-91"></a>
<a id="__codelineno-21-92" name="__codelineno-21-92" href="#__codelineno-21-92"></a><span class="c1"># update model state dict</span>
<a id="__codelineno-21-93" name="__codelineno-21-93" href="#__codelineno-21-93"></a><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
<a id="__codelineno-21-94" name="__codelineno-21-94" href="#__codelineno-21-94"></a>
<a id="__codelineno-21-95" name="__codelineno-21-95" href="#__codelineno-21-95"></a><span class="n">input_x</span> <span class="o">=</span> <span class="s2">&quot;You did the work?&quot;</span>
<a id="__codelineno-21-96" name="__codelineno-21-96" href="#__codelineno-21-96"></a><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">}</span>
<a id="__codelineno-21-97" name="__codelineno-21-97" href="#__codelineno-21-97"></a><span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-21-98" name="__codelineno-21-98" href="#__codelineno-21-98"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="message"><strong>Message</strong></h3>
<p>The <code>msgflux.Message</code> class, inspired by <code>torch.Tensor</code>, and implements on top of 'dotdict', was designed to facilitate the flow of information in computational graphs created with <code>nn</code> modules.</p>
<p>One of the central principles of its design is to allow each Module to have specific permissions to read and write to predefined fields of the Message.</p>
<p>This provides an organized structure for the flow of data between different components of a system.</p>
<p>The class implements the <code>set</code> and <code>get</code> methods, which allow creating and accessing data in the Message through strings, offering a flexible and intuitive interface. In addition, default fields are provided to structure the data in a consistent way.</p>
<p><code>Message</code> is integrated into built-in <code>Modules</code> so that you <em>declare</em> how the module should read and write information.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">msg</span>
</code></pre></div>
<p>Each message receives an <code>user_id</code>, <code>user_name</code> and <code>chat_id</code>.Message auto generates an <code>execution_id</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">msg_metadata</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="n">user_name</span><span class="o">=</span><span class="s2">&quot;Bruce Wayne&quot;</span><span class="p">,</span> <span class="n">chat_id</span><span class="o">=</span><span class="s2">&quot;456&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="functional"><strong>Functional</strong></h3>
<p>Functional are a set of functions developed for concurrent processing.</p>
<p>Functional offers a sync API for executing multiple concurrent tasks.</p>
<p>Functional calls the <code>Executor</code> a class that manages an async event loop and a threadpool, distributing tasks among them and returning futures.</p>
<p>Although they are inside <code>nn</code>, the functions to be used are not limited to <code>nn.Module</code> and can be used for any function.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">msgflux.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">F</span><span class="o">.</span><span class="n">__all__</span>
</code></pre></div>
<p>from msgflux.utils.mermaid import plot_mermaid</p>
<h1 id="title-map_gather">@title <strong>map_gather</strong></h1>
<h1 id="map-a-list-of-inputs-in-a-single-f">map a list of inputs in a single f</h1>
<h1 id="input1-input2">input1, input2</h1>
<h1 id="input1-f-r1">input1 -&gt; f -&gt; r1</h1>
<h1 id="input2-f-r2">input2 -&gt; f -&gt; r2</h1>
<h1 id="r1-r2">(r1, r2)</h1>
<p>mermaid_code = """
flowchart TD
    subgraph map_gather ["map_gather"]
        input1["input1"]
        input2["input2"]</p>
<div class="highlight"><pre><span></span><code>    f[&quot;f&quot;]

    r1[&quot;r1&quot;]
    r2[&quot;r2&quot;]

    input1 --&gt; f --&gt; r1
    input2 --&gt; f --&gt; r2

    r1 -.-&gt; results[&quot;r1, r2&quot;]
    r2 -.-&gt; results
end
</code></pre></div>
<p>"""
plot_mermaid(mermaid_code)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">F</span><span class="o">.</span><span class="n">map_gather</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">map_gather</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">args_list</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)])</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1"># (3, 7, 11)</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">map_gather</span><span class="p">(</span><span class="n">multiply</span><span class="p">,</span> <span class="n">args_list</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,)],</span> <span class="n">kwargs_list</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}])</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1"># (3, 12, 25)</span>
</code></pre></div>
<h1 id="title-scatter_gather">@title <strong>scatter_gather</strong></h1>
<h1 id="map-a-list-of-inputs-to-a-list-of-f">map a list of inputs to a list of f</h1>
<h1 id="input1-input2_1">input1, input2</h1>
<h1 id="input1-f1-r1">input1 -&gt; f1 -&gt; r1</h1>
<h1 id="input2-f2-r2">input2 -&gt; f2 -&gt; r2</h1>
<h1 id="r1-r2_1">(r1, r2)</h1>
<p>mermaid_code = """
flowchart TD
    subgraph scatter_gather ["scatter_gather"]</p>
<div class="highlight"><pre><span></span><code>    input1[&quot;input1&quot;]
    input2[&quot;input2&quot;]

    f1[&quot;f1&quot;]
    f2[&quot;f2&quot;]

    r1[&quot;r1&quot;]
    r2[&quot;r2&quot;]

    input1 --&gt; f1 --&gt; r1
    input2 --&gt; f2 --&gt; r2

    r1 -.-&gt; results[&quot;r1, r2&quot;]
    r2 -.-&gt; results
end
</code></pre></div>
<p>"""
plot_mermaid(mermaid_code)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">F</span><span class="o">.</span><span class="n">scatter_gather</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="n">callables</span> <span class="o">=</span> <span class="p">[</span><span class="n">add</span><span class="p">,</span> <span class="n">multiply</span><span class="p">,</span> <span class="n">add</span><span class="p">]</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="c1"># Example 1: Using only args_list</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="p">]</span> <span class="c1"># multiply will use its default y</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">scatter_gather</span><span class="p">(</span><span class="n">callables</span><span class="p">,</span> <span class="n">args_list</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1"># (3, 6, 30)</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="c1"># Example 2: Using args_list e kwargs_list</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,)</span> <span class="p">]</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="n">kwargs</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span> <span class="p">]</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">scatter_gather</span><span class="p">(</span><span class="n">callables</span><span class="p">,</span> <span class="n">args_list</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs_list</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1"># (3, 9, 30)</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="c1"># Example 3: Using only kwargs_list (useful if functions have defaults or don&#39;t need positional args)</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;World&quot;</span><span class="p">):</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">farewell</span><span class="p">(</span><span class="n">person_name</span><span class="p">):</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Goodbye, </span><span class="si">{</span><span class="n">person_name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">greet</span><span class="p">,</span> <span class="n">greet</span><span class="p">,</span> <span class="n">farewell</span><span class="p">]</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="n">kwargs_for_funcs</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Earth&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;person_name&#39;</span><span class="p">:</span> <span class="s2">&quot;Commander&quot;</span><span class="p">}]</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">scatter_gather</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">kwargs_list</span><span class="o">=</span><span class="n">kwargs_for_funcs</span><span class="p">)</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1"># (&quot;Hello, World&quot;, &quot;Hello, Earth&quot;, &quot;Goodbye, Commander&quot;)</span>
</code></pre></div>
<p><strong>msg_scatter_gather</strong></p>
<p>Similarly, you can use the <code>msg_scatter_gather</code> version where you use a <code>dotdict</code>-based object to pass and modify information in the object itself.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">F</span><span class="o">.</span><span class="n">msg_scatter_gather</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">msg1</span><span class="p">,</span> <span class="n">msg2</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">(),</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="n">msg1</span><span class="o">.</span><span class="n">user_input</span> <span class="o">=</span> <span class="s2">&quot;hi, how are you?&quot;</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="n">msg2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;I want to visit Dortmund&quot;</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">agent</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">user_input</span><span class="p">)</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;I am fine, thank you!&quot;</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">retriever</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="s2">&quot;The user likes to travel.&quot;</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="n">msg1</span><span class="p">,</span> <span class="n">msg2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">msg_scatter_gather</span><span class="p">([</span><span class="n">agent</span><span class="p">,</span> <span class="n">retriever</span><span class="p">],</span> <span class="p">[</span><span class="n">msg1</span><span class="p">,</span> <span class="n">msg2</span><span class="p">])</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="n">msg1</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="n">msg2</span>
</code></pre></div>
<h1 id="title-bcast_gather">@title <strong>bcast_gather</strong></h1>
<h1 id="map-a-input-to-a-list-of-f">map a input to a list of f</h1>
<h1 id="input1">input1</h1>
<h1 id="input1-f1-r1_1">input1 -&gt; f1 -&gt; r1</h1>
<h1 id="input1-f2-r2">input1 -&gt; f2 -&gt; r2</h1>
<h1 id="r1-r2_2">(r1, r2)</h1>
<p>mermaid_code = """
flowchart TD
    subgraph bcast_gather ["bcast_gather"]</p>
<div class="highlight"><pre><span></span><code>    input1[&quot;input1&quot;]

    f1[&quot;f1&quot;]
    f2[&quot;f2&quot;]

    r1[&quot;r1&quot;]
    r2[&quot;r2&quot;]

    input1 --&gt; f1 --&gt; r1
    input1 --&gt; f2 --&gt; r2

    r1 -.-&gt; results[&quot;r1, r2&quot;]
    r2 -.-&gt; results
end
</code></pre></div>
<p>"""
plot_mermaid(mermaid_code)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">F</span><span class="o">.</span><span class="n">bcast_gather</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">cube</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">fail</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Intentional error&quot;</span><span class="p">)</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="c1"># Example 1</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">bcast_gather</span><span class="p">([</span><span class="n">square</span><span class="p">,</span> <span class="n">cube</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>  <span class="c1"># (9, 27)</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="c1"># Example 2: Simulate error</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">bcast_gather</span><span class="p">([</span><span class="n">square</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">cube</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>  <span class="c1"># (4, None, 8)</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="c1"># Example 3: Timeout</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">bcast_gather</span><span class="p">([</span><span class="n">square</span><span class="p">,</span> <span class="n">cube</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="c1"># (16, 64)</span>
</code></pre></div>
<p><strong>msg_bcast_gather</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">F</span><span class="o">.</span><span class="n">msg_bcast_gather</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">msg</span><span class="o">.</span><span class="n">user_input</span> <span class="o">=</span> <span class="s2">&quot;I want to visit Natal&quot;</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">web_search</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">web_search</span> <span class="o">=</span> <span class="s2">&quot;Natal is the capital of the sun...&quot;</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">memory</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>    <span class="n">msg</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="s2">&quot;The user likes to travel.&quot;</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>    <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">msg_bcast_gather</span><span class="p">([</span><span class="n">web_search</span><span class="p">,</span> <span class="n">memory</span><span class="p">],</span> <span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="n">msg</span>
</code></pre></div>
<h1 id="title-background_task">@title <strong>background_task</strong></h1>
<h1 id="map-a-input-to-a-f-and-forget">map a input to a f and forget</h1>
<h1 id="input-f">input -&gt; f</h1>
<p>mermaid_code = """
flowchart TD
    subgraph background_task ["background_task"]</p>
<div class="highlight"><pre><span></span><code>    input[&quot;input&quot;]
    f[&quot;f&quot;]

    input --&gt; f
end
</code></pre></div>
<p>"""
plot_mermaid(mermaid_code)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1"># Example 1:</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Sync] Message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="n">F</span><span class="o">.</span><span class="n">background_task</span><span class="p">(</span><span class="n">print_message</span><span class="p">,</span> <span class="s2">&quot;Hello from sync function&quot;</span><span class="p">)</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="c1"># Example 2:</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_print_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Async] Message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="n">F</span><span class="o">.</span><span class="n">background_task</span><span class="p">(</span><span class="n">async_print_message</span><span class="p">,</span> <span class="s2">&quot;Hello from async function&quot;</span><span class="p">)</span>
</code></pre></div>
<h1 id="title-wait_for">@title <strong>wait_for</strong></h1>
<h1 id="map-a-input-to-a-f">map a input to a f</h1>
<h1 id="input1_1">input1</h1>
<h1 id="input1-f1-r1_2">input1 -&gt; f1 -&gt; r1</h1>
<h1 id="r1">r1</h1>
<p>mermaid_code = """
flowchart TD
    subgraph wait_for ["wait_for"]</p>
<div class="highlight"><pre><span></span><code>    input1[&quot;input1&quot;]
    f1[&quot;f1&quot;]
    r1[&quot;r1&quot;]

    input1 --&gt; f1 --&gt; r1
end
</code></pre></div>
<p>"""
plot_mermaid(mermaid_code)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">F</span><span class="o">.</span><span class="n">wait_for</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="c1"># Example 1:</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="n">results</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>
<h1 id="title-wait_for_event">@title <strong>wait_for_event</strong></h1>
<h1 id="wait-for-a-asyncioevent">wait for a asyncio.Event</h1>
<h1 id="event-wait">event -&gt; wait</h1>
<p>mermaid_code = """
flowchart TD
    subgraph wait_for_event ["wait_for_event"]
        event["asyncio.Event"]
        wait["wait"]</p>
<div class="highlight"><pre><span></span><code>    event --&gt; wait
end
</code></pre></div>
<p>"""
plot_mermaid(mermaid_code)</p>
<h3 id="moduledict"><strong>ModuleDict</strong></h3>
<p>Holds submodules in a dict.</p>
<p><code>nn.ModuleDict</code> can be indexed like a regular Python dictionary, but modules it contains are properly registered, and will be visible by all Module methods.</p>
<p><code>nn.ModuleDict</code> is an <strong>ordered</strong> dictionary that respects</p>
<ul>
<li>
<p>the order of insertion, and</p>
</li>
<li>
<p>in update(), the order of the merged <code>OrderedDict</code>, dict (started from Python 3.6) or another <code>nn.ModuleDict</code> (the argument to update()).</p>
</li>
</ul>
<p>Note that update() with other unordered mapping types (e.g., Python's plain dict before Python version 3.6) does not preserve the order of the merged mapping.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpertSales</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;Hi, let&#39;s talk?&quot;</span><span class="p">)</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpertSupport</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;Hi, call 190&quot;</span><span class="p">)</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a>        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">draw_choice</span><span class="p">(</span><span class="n">choices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a>    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="k">class</span><span class="w"> </span><span class="nc">Router</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">({</span>
<a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a>            <span class="s2">&quot;sales&quot;</span><span class="p">:</span> <span class="n">ExpertSales</span><span class="p">(),</span>
<a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a>            <span class="s2">&quot;support&quot;</span><span class="p">:</span> <span class="n">ExpertSupport</span><span class="p">()</span>
<a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a>        <span class="p">})</span>
<a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a>
<a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a>        <span class="n">choice</span> <span class="o">=</span> <span class="n">draw_choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="n">choice</span><span class="p">](</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a>        <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a>
<a id="__codelineno-32-37" name="__codelineno-32-37" href="#__codelineno-32-37"></a><span class="n">router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">()</span>
<a id="__codelineno-32-38" name="__codelineno-32-38" href="#__codelineno-32-38"></a>
<a id="__codelineno-32-39" name="__codelineno-32-39" href="#__codelineno-32-39"></a><span class="n">router</span>
<a id="__codelineno-32-40" name="__codelineno-32-40" href="#__codelineno-32-40"></a>
<a id="__codelineno-32-41" name="__codelineno-32-41" href="#__codelineno-32-41"></a><span class="n">router</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<a id="__codelineno-32-42" name="__codelineno-32-42" href="#__codelineno-32-42"></a>
<a id="__codelineno-32-43" name="__codelineno-32-43" href="#__codelineno-32-43"></a><span class="n">router</span><span class="p">(</span><span class="s2">&quot;I need help with my tv.&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="modulelist"><strong>ModuleList</strong></h3>
<p>Holds submodules in a list.</p>
<p><code>nn.ModuleList</code> can be indexed like a regular Python list, but modules it contains are properly registered, and will be visible by all <code>nn.Module</code> methods.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpertSales</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;Hi, let&#39;s talk?&quot;</span><span class="p">)</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpertSupport</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;Hi, call 190&quot;</span><span class="p">)</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a>        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">Expert</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">experts</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">ExpertSales</span><span class="p">(),</span> <span class="n">ExpertSupport</span><span class="p">()])</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a>        <span class="c1"># ModuleList can act as an iterable, or be indexed using ints</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experts</span><span class="p">):</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experts</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>        <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="n">expert</span> <span class="o">=</span> <span class="n">Expert</span><span class="p">()</span>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="n">expert</span>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a>
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="n">expert</span><span class="p">(</span><span class="s2">&quot;I need help with my tv.&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="sequential"><strong>Sequential</strong></h3>
<p>A sequential container.</p>
<p>Modules will be added to it in the order they are passed in the constructor.</p>
<p>Alternatively, an <code>OrderedDict</code> of modules can be passed in. The <code>forward()</code> method of <code>nn.Sequential</code> accepts any input and forwards it to the first module it contains. It then "chains" outputs to inputs sequentially for each subsequent module, finally returning the output of the last module.</p>
<p>The value a <code>nn.Sequential</code> provides over manually calling a sequence of modules is that it allows treating the whole container as a single module, such that performing a transformation on the <code>nn.Sequential</code> applies to each of the modules it stores (which are each a registered submodule of the <code>nn.Sequential</code>).</p>
<p>What's the difference between a <code>nn.Sequential</code> and a
<code>nn.ModuleList</code>?</p>
<p>A <code>ModuleList</code> is exactly what it sounds like--a list for storing <code>nn.Module</code>s! On the other hand,
the layers in a <code>nn.Sequential</code> are connected in a cascading way.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpertSales</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;Hi, let&#39;s talk?&quot;</span><span class="p">)</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpertSupport</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;Hi, call 190&quot;</span><span class="p">)</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>        <span class="k">return</span> <span class="n">msg</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="c1"># Using Sequential to create a small workflow. When **expert** is run,</span>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="c1"># input will first be passed to **ExpertSales**. The output of</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="c1"># **ExpertSales** will be used as the input to the first</span>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="c1"># **ExpertSupport**; Finally, the output of</span>
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="c1"># **ExpertSupport** will be the experts response.</span>
<a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a><span class="n">experts</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">ExpertSales</span><span class="p">(),</span> <span class="n">ExpertSupport</span><span class="p">())</span>
<a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>
<a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="n">experts</span>
<a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>
<a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a><span class="n">experts</span><span class="p">(</span><span class="s2">&quot;I need help with my tv.&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Using Sequential with OrderedDict.</p>
<p>This is functionally the same as the above code.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="n">experts_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>    <span class="p">(</span><span class="s2">&quot;expert_sales&quot;</span><span class="p">,</span> <span class="n">ExpertSales</span><span class="p">()),</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>    <span class="p">(</span><span class="s2">&quot;expert_support&quot;</span><span class="p">,</span> <span class="n">ExpertSupport</span><span class="p">())</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="p">]))</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="n">experts_dict</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="n">experts_dict</span><span class="p">(</span><span class="s2">&quot;I need help with my tv.&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="agent"><strong>Agent</strong></h3>
<p><code>nn.Agent</code> is a powerful <code>nn.Module</code> that can handle multimodal data and tool calling.</p>
<p>A <code>nn.Agent</code> is composed of a language model with instructions and tools. The Agent module adopts a task decomposition strategy, allowing each part of a task to be treated in isolation and independently.</p>
<p>A <code>nn.ToolLibrary</code> is integrated into the Agent to manage and run the tools.</p>
<p>The agent (and other built-in modules) has a parameter called <code>response_mode</code>, which defines how the class's response should be returned.</p>
<p>The default is <code>plain_response</code>, where the output is returned directly to the user. Any other option results in logging to the passed Message object.</p>
<p>By default, the class returns only the model output. But if you want the agent's internal state, <code>model_state</code>, to be returned, you must pass <code>return_model_state=True</code>. Then the class output will be a dotdict containing the keys <code>model_response</code> and <code>model_state</code>.</p>
<p>The <code>nn.Agent</code> class divides the <em>system prompt</em> and <em>task</em> into different components so they can be handled and optimized in a compositional manner.</p>
<p>The <strong>system prompt</strong> is separated into 6 variables:</p>
<ul>
<li>
<p><strong>system_message</strong>: The Agent behaviour. E.g. "You are a agent specilist in ...".</p>
</li>
<li>
<p><strong>instructions</strong>: What the Agent should do. E.g. "You MUST respond to the user ...".</p>
</li>
<li>
<p><strong>expected_output</strong>: What the response should be like. E.g. "Your answer must be concise ..."</p>
</li>
<li>
<p><strong>examples</strong>: Examples of inputs, reasoning and outputs.</p>
</li>
<li>
<p><strong>system_extra_message</strong>: Any extra message to the system prompt.</p>
</li>
<li>
<p><strong>include_date</strong>: If True, include the current date in the system prompt.</p>
</li>
</ul>
<p>All these components are put together within the system prompt (Jinja) template</p>
<p>The <strong>task</strong> is separated into 6 variables:</p>
<ul>
<li>
<p><strong>context_cache:</strong> A fixed context to Agent.</p>
</li>
<li>
<p><strong>context_inputs (*):</strong> Field of the Message object that will be the context to the task.</p>
</li>
<li>
<p><strong>context_inputs_template:</strong> A Jinja template for formatting <em>context_inputs</em>.</p>
</li>
<li>
<p><strong>task_inputs (*):</strong> Field of the Message object that will be the input to the task.</p>
</li>
<li>
<p><strong>task_template:</strong> A Jinja template to format task.</p>
</li>
<li>
<p><strong>task_multimodal_inputs (*):</strong> Field of the Message object that will be the multimodal input to the task.</p>
</li>
<li>
<p><strong>task_messages (*):</strong> Field of the Message object that will be a list of chats in ChatML format.</p>
</li>
<li>
<p><strong>vars (*):</strong> Field of the Message object that will be the <em>vars</em> to templates and tools.</p>
</li>
</ul>
<p><strong>(*) It can also be passed during agent call as a named argument.</strong></p>
<p><strong>Guardrails</strong></p>
<p>Agent has 2 guardrail options:</p>
<ul>
<li>
<p><strong>input_guardrail:</strong> Before execution.</p>
</li>
<li>
<p><strong>output_guardrail:</strong> After execution.</p>
</li>
</ul>
<p>Both guardians receive a <code>data</code> parameter containing a list of conversations in ChatML format.</p>
<p>Moderation-type models are the common choice for guardrail.</p>
<p>That's enough to get you started 🤠. More below.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">nn</span><span class="o">.</span><span class="n">Agent</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="o">.</span><span class="fm">__init__</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">userdata</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="n">mf</span><span class="o">.</span><span class="n">set_envs</span><span class="p">(</span><span class="n">OPENAI_API_KEY</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="c1"># an nn.Agent requires at least a name and a model</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="n">agent</span>
</code></pre></div>
<h4 id="debugging-an-agent"><strong>Debugging an Agent</strong></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># Prompt components and the agent config</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="c1"># can be easily viewed through the state dict</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="c1"># using inspect</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="s2">&quot;User name is {{user_name}}&quot;</span><span class="p">,</span> <span class="n">return_model_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Hi&quot;</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="nb">vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Clark&quot;</span><span class="p">}</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="n">agent</span><span class="o">.</span><span class="n">inspect_model_execution_params</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="n">response</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="c1"># set verbose=True</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h4 id="async_1"><strong>Async</strong></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">acall</span><span class="p">(</span><span class="s2">&quot;Tell me about Dirac delta&quot;</span><span class="p">)</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<h4 id="stream"><strong>Stream</strong></h4>
<p>In streaming mode, the agent returns the model output as a <code>ModelStreamResponse</code> object.</p>
<p>This mode can be combined with <code>tools</code> usage.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="c1"># stream</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="s2">&quot;Tell me a funny history&quot;</span><span class="p">)</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">response_type</span><span class="p">)</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="c1"># fastapi.StreamingResponse compatible</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h4 id="vars"><strong>Vars</strong></h4>
<p>Language Models are secretly computers that makes context-based decisions when acting in an environment. In addition to taking actions via tool calls, the model needs to store information in a set of variables.</p>
<p>In <strong>msgFlux</strong>, this is called <code>vars</code>.</p>
<p><code>vars</code> are a dictionary that is injected into various parts of the agent class.</p>
<p>They are useful for bringing external information to agent components.</p>
<p>Currently, they appear in the following fields:</p>
<div class="highlight"><pre><span></span><code>* system_prompt_template

* task_template

* context_inputs_template

* tool calls

* response_template
</code></pre></div>
<p>Within tools, <code>vars</code> can provide and receive data. Think of it as a set of variables available at runtime.</p>
<h4 id="system-prompt"><strong>System Prompt</strong></h4>
<p>The <strong>system prompt</strong> defines the agent's behavior while performing a task.</p>
<p>The Agent class organizes the behavior of a model into different layers of the system prompt, allowing for <strong>granularity</strong> and <strong>clarity</strong> in design.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">system_message</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="s2">You are a business development assistant focused on helping sales teams qualify leads</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="s2">and craft compelling value propositions.</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="s2">Always keep a professional and persuasive tone.</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="n">instructions</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="s2">When given a short company description, identify its potential needs,</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="s2">suggest an initial outreach strategy, and provide a tailored value proposition.</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="n">expected_output</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="s2">Respond in three bullet points:</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="s2">    - Identified Needs</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="s2">    - Outreach Strategy</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="s2">    - Value Proposition</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="n">system_extra_message</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="s2">Ensure recommendations align with ethical sales practices</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="s2">and avoid making unverifiable claims about the product.</span>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="n">sales_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a>    <span class="s2">&quot;sales-agent&quot;</span><span class="p">,</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a>    <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a>    <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span>
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a>    <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
<a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a>    <span class="n">expected_output</span><span class="o">=</span><span class="n">expected_output</span><span class="p">,</span>
<a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a>    <span class="n">system_extra_message</span><span class="o">=</span><span class="n">system_extra_message</span><span class="p">,</span>
<a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a>    <span class="n">include_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a><span class="p">)</span>
<a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a>
<a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a><span class="c1"># The system prompt is encapsulated within the &lt;developer_note&gt; tags</span>
<a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a><span class="nb">print</span><span class="p">(</span><span class="n">sales_agent</span><span class="o">.</span><span class="n">_get_system_prompt</span><span class="p">())</span>
<a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a>
<a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a><span class="c1">#### **Task and Context**</span>
<a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a>
<a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a><span class="n">We</span> <span class="n">can</span> <span class="n">define</span> <span class="n">a</span> <span class="o">**</span><span class="n">task</span><span class="o">**</span> <span class="k">as</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">objective</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">an</span> <span class="n">agent</span><span class="p">,</span> <span class="n">consisting</span> <span class="n">of</span> <span class="n">a</span> <span class="n">clear</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">possible</span> <span class="n">restrictions</span><span class="p">,</span> <span class="n">a</span> <span class="n">success</span> <span class="n">criterion</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">the</span> <span class="n">task</span> <span class="ow">is</span> <span class="n">inserted</span><span class="o">.</span>
<a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a>
<a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a><span class="n">Language</span> <span class="n">models</span> <span class="n">have</span> <span class="n">emerged</span> <span class="k">with</span> <span class="n">the</span> <span class="n">ability</span> <span class="n">to</span> <span class="n">learn</span> <span class="n">new</span> <span class="n">knowledge</span> <span class="n">without</span> <span class="n">updating</span> <span class="n">their</span> <span class="n">parameters</span><span class="o">.</span>
<a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a>
<a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a><span class="n">This</span> <span class="n">ability</span> <span class="ow">is</span> <span class="n">formally</span> <span class="n">known</span> <span class="k">as</span> <span class="o">**</span><span class="n">In</span><span class="o">-</span><span class="n">Context</span> <span class="n">Learning</span><span class="o">**</span> <span class="p">(</span><span class="n">ICL</span><span class="p">)</span><span class="o">.</span>
<a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a>
<a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a><span class="c1">##### **Task**</span>
<a id="__codelineno-40-44" name="__codelineno-40-44" href="#__codelineno-40-44"></a>
<a id="__codelineno-40-45" name="__codelineno-40-45" href="#__codelineno-40-45"></a><span class="n">A</span> <span class="n">task</span> <span class="n">can</span> <span class="n">be</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">few</span> <span class="n">ways</span><span class="o">.</span> <span class="n">The</span> <span class="n">first</span> <span class="ow">is</span> <span class="n">by</span> <span class="n">passing</span> <span class="n">a</span> <span class="n">direct</span> <span class="n">message</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Agent</span><span class="o">.</span>
<a id="__codelineno-40-46" name="__codelineno-40-46" href="#__codelineno-40-46"></a>
<a id="__codelineno-40-47" name="__codelineno-40-47" href="#__codelineno-40-47"></a><span class="err">```</span><span class="n">python</span>
<a id="__codelineno-40-48" name="__codelineno-40-48" href="#__codelineno-40-48"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-49" name="__codelineno-40-49" href="#__codelineno-40-49"></a>
<a id="__codelineno-40-50" name="__codelineno-40-50" href="#__codelineno-40-50"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;I need help with my tv.&quot;</span>
<a id="__codelineno-40-51" name="__codelineno-40-51" href="#__codelineno-40-51"></a><span class="n">agent</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
</code></pre></div>
<h5 id="task-template"><strong>Task Template</strong></h5>
<p>A task template is used to format agent task inputs.</p>
<h6 id="string-based-input"><strong>String-based Input</strong></h6>
<p>If the task has only a simple <strong>string</strong> as input, insert {}</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;Who was </span><span class="si">{}</span><span class="s2">?&quot;</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Nikola Tesla&quot;</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="n">agent</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
<h6 id="dict-based-inputs"><strong>Dict-based Inputs</strong></h6>
<p>For dict-based inputs you should use Jinja blocks, write {{field_name}}</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;Who was {{person}}?&quot;</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="s2">&quot;Nikola Tesla&quot;</span><span class="p">}</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="n">agent</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
<h6 id="task-template-as-fixed-task"><strong>Task Template as Fixed-Task</strong></h6>
<p>If a <code>task_template</code> is passed but a task is not, the class will maintain the <code>task_template</code> as a task.</p>
<p>This is particularly useful for multimodal applications where the task prompt doesn't vary, just the media content.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;Who was Nikola Tesla?&quot;</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="n">agent</span><span class="p">()</span>
</code></pre></div>
<h6 id="combine-with-vars"><strong>Combine with Vars</strong></h6>
<p>Combine <code>task_template</code> with <code>vars</code> to build dynamic task_templates</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">instructions</span> <span class="o">=</span> <span class="s2">&quot;Help the user with whatever they need. Address them by name if they provide it.&quot;</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="s2">{</span><span class="si">% i</span><span class="s2">f user_name %}</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="s2">My name is {{ user_name }}.</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="s2">{</span><span class="si">% e</span><span class="s2">ndif %}</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="s2">{{ user_input }}</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="n">agent</span><span class="p">(</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>    <span class="n">message</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_input&quot;</span><span class="p">:</span> <span class="s2">&quot;Who was Nikola Tesla?&quot;</span><span class="p">},</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>    <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bruce Wayne&quot;</span><span class="p">}</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="p">)</span>
</code></pre></div>
<h5 id="task-messages"><strong>Task Messages</strong></h5>
<p>You can also pass a list of conversations to the agent. This makes the <code>message</code> optional.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">chat</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ChatML</span><span class="p">()</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="n">chat</span><span class="o">.</span><span class="n">add_user_message</span><span class="p">(</span><span class="s2">&quot;Hi, my name is Peter Parker, and I&#39;m a photographer. Could you recommend some cameras?&quot;</span><span class="p">)</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="n">chat</span><span class="o">.</span><span class="n">get_messages</span><span class="p">()</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="n">task_messages</span><span class="o">=</span><span class="n">chat</span><span class="o">.</span><span class="n">get_messages</span><span class="p">())</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="n">response</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="n">chat</span><span class="o">.</span><span class="n">add_assist_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;I need a low-cost, compact camera to start my new freelance job for J. Jonah Jameson.&quot;</span><span class="p">,</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a>    <span class="n">task_messages</span><span class="o">=</span><span class="n">chat</span><span class="o">.</span><span class="n">get_messages</span><span class="p">()</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="p">)</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="n">response</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="n">chat</span><span class="o">.</span><span class="n">add_assist_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<h5 id="fixed-messages"><strong>Fixed Messages</strong></h5>
<p>You can keep a set of pinned conversations within the agent</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>    <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fixed_messages</span><span class="o">=</span><span class="n">chat</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(),</span> <span class="n">return_model_state</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="p">)</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="n">agent</span><span class="p">(</span><span class="s2">&quot;What is the cheapest camera between Canon PowerShot G9 X Mark II and Sony Cyber-shot DSC-HX80?&quot;</span><span class="p">)</span>
</code></pre></div>
<h5 id="multimodal-task"><strong>MultiModal Task</strong></h5>
<p>Multimodal models are capable of handling multiple media types such as images, audio, and files.</p>
<p>The Agent class currently supports:</p>
<table>
<thead>
<tr>
<th>midia</th>
<th>input</th>
<th>multi inputs</th>
</tr>
</thead>
<tbody>
<tr>
<td>image</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>audio</td>
<td>✅</td>
<td>⛔️</td>
</tr>
<tr>
<td>file</td>
<td>✅</td>
<td>⛔️</td>
</tr>
</tbody>
</table>
<h6 id="image"><strong>Image</strong></h6>
<p>For images you can pass a local image or an url</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;Describe this image.&quot;</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="n">agent</span><span class="p">(</span><span class="n">task_multimodal_inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Gfp-wisconsin-madison-the-nature-boardwalk.jpg/2560px-Gfp-wisconsin-madison-the-nature-boardwalk.jpg&quot;</span><span class="p">})</span>
</code></pre></div>
<p>Or a list of images</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">agent</span><span class="p">(</span><span class="n">task_multimodal_inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;file:///path/to/image1.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;file:///path/to/image2.jpg&quot;</span><span class="p">]})</span>
</code></pre></div>
<h6 id="file"><strong>File</strong></h6>
<p>Pass raw <code>.pdf</code> files to the provider.</p>
<p>Only <code>OpenAI</code> and <code>OpenRouter</code> supports it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;https://arxiv.org/pdf/1706.03762.pdf&quot;</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;Summarize the paper&quot;</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="n">agent</span><span class="p">(</span><span class="n">task_multimodal_inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
</code></pre></div>
<h6 id="audio"><strong>Audio</strong></h6>
<p>Pass raw <code>audio</code> files to the provider.</p>
<p>Only <code>OpenAI</code>, <code>vLLM</code> and <code>OpenRouter</code> supports it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">userdata</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENROUTER_API_KEY&quot;</span><span class="p">)</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="n">mf</span><span class="o">.</span><span class="n">set_envs</span><span class="p">(</span><span class="n">OPENROUTER_API_KEY</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openrouter/google/gemini-2.5-flash&quot;</span><span class="p">)</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/you/local/audio.wav&quot;</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;Please transcribe this audio file.&quot;</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="n">task_multimodal_inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;audio&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a><span class="n">response</span>
</code></pre></div>
<h5 id="context-inputs"><strong>Context Inputs</strong></h5>
<p><code>context</code> is a block that brings together a set of knowlegde that the model has available at the time of inference to make decisions, answer questions or perform actions.</p>
<p><code>context_inputs</code> refers to the knowledge passed to the agent during task definition. This knowledge can come from databases, documents, conversation summaries, etc.</p>
<h6 id="str-based"><strong>Str-based</strong></h6>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">agent_configs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sales-agent&quot;</span><span class="p">,</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>    <span class="s2">&quot;include_date&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>    <span class="s2">&quot;system_message&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a sales assistant that helps craft personalized pitches.&quot;</span><span class="p">,</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>    <span class="s2">&quot;instructions&quot;</span><span class="p">:</span> <span class="s2">&quot;Always generate responses tailored to the client context stored in memory.&quot;</span><span class="p">,</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>    <span class="s2">&quot;expected_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Write a short persuasive pitch (max 120 words). Returns only the message.&quot;</span><span class="p">,</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>    <span class="s2">&quot;system_extra_message&quot;</span><span class="p">:</span> <span class="s2">&quot;Avoid exaggerations and ensure the tone remains professional.&quot;</span><span class="p">,</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>    <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="p">}</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="n">sales_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="o">**</span><span class="n">agent_configs</span><span class="p">)</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;Can you help me create an initial message for this customer?&quot;</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="n">context_inputs</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="s2">Company name: FinData Analytics</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="s2">Industry Financial Technology (FinTech)</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="s2">Product: AI-powered risk analysis platform for banks</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="s2">Target market: Mid-sized regional banks in South America</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="s2">Unique value: Automated detection of fraud patterns in real-time</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">model_execution_params</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">inspect_model_execution_params</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_execution_params</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="n">response</span> <span class="o">=</span> <span class="n">sales_agent</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
</code></pre></div>
<h6 id="list-based"><strong>List-based</strong></h6>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">context_inputs</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>    <span class="s2">&quot;Company name: DataFlow Analytics&quot;</span><span class="p">,</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>    <span class="s2">&quot;Product: StreamVision — a real-time analytics platform&quot;</span><span class="p">,</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>    <span class="s2">&quot;Key value_proposition: Helps businesses monitor live data streams and detect anomalies instantly.&quot;</span><span class="p">,</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>    <span class="s2">&quot;Support policy: Support is available 24/7 for enterprise clients via chat and email.&quot;</span><span class="p">,</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="p">]</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="n">model_execution_params</span> <span class="o">=</span> <span class="n">sales_agent</span><span class="o">.</span><span class="n">inspect_model_execution_params</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_execution_params</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="n">response</span> <span class="o">=</span> <span class="n">sales_agent</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
</code></pre></div>
<h6 id="dict-based"><strong>Dict-based</strong></h6>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">context_inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>    <span class="s2">&quot;client_name&quot;</span><span class="p">:</span> <span class="s2">&quot;EcoSupply Ltd.&quot;</span><span class="p">,</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>    <span class="s2">&quot;industry&quot;</span><span class="p">:</span> <span class="s2">&quot;Sustainable packaging&quot;</span><span class="p">,</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>    <span class="s2">&quot;pain_points&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;High logistics costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Need for eco-friendly certification&quot;</span><span class="p">],</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>    <span class="s2">&quot;current_solution&quot;</span><span class="p">:</span> <span class="s2">&quot;Using generic suppliers with limited green compliance&quot;</span><span class="p">,</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="p">}</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="n">model_execution_params</span> <span class="o">=</span> <span class="n">sales_agent</span><span class="o">.</span><span class="n">inspect_model_execution_params</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_execution_params</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="n">response</span> <span class="o">=</span> <span class="n">sales_agent</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
</code></pre></div>
<h5 id="context-inputs-template"><strong>Context Inputs Template</strong></h5>
<p>use a <code>context_inputs_template</code> to format <code>context_inputs</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">agent_configs</span><span class="p">[</span><span class="s2">&quot;context_inputs_template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="s2">The client is **{{ client_name }}**, a company in the **{{ industry }}** sector.</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="s2">They are currently relying on {{ current_solution }},</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="s2">but face the following main challenges:</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="s2">{</span><span class="si">%- f</span><span class="s2">or pain in pain_points %}</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="s2">- {{ pain }}</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="s2">{</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="s2">This background should always be considered when tailoring answers,</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="s2">ensuring relevance to the client’s industry and specific needs.</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="n">sales_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="o">**</span><span class="n">agent_configs</span><span class="p">)</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="n">context_inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>    <span class="s2">&quot;client_name&quot;</span><span class="p">:</span> <span class="s2">&quot;EcoSupply Ltd.&quot;</span><span class="p">,</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>    <span class="s2">&quot;industry&quot;</span><span class="p">:</span> <span class="s2">&quot;Sustainable packaging&quot;</span><span class="p">,</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a>    <span class="s2">&quot;pain_points&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;High logistics costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Need for eco-friendly certification&quot;</span><span class="p">],</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a>    <span class="s2">&quot;current_solution&quot;</span><span class="p">:</span> <span class="s2">&quot;Using generic suppliers with limited green compliance&quot;</span><span class="p">,</span>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="p">}</span>
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;Can you help me create an initial message for this customer?&quot;</span>
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a><span class="n">model_execution_params</span> <span class="o">=</span> <span class="n">sales_agent</span><span class="o">.</span><span class="n">inspect_model_execution_params</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a>
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_execution_params</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a>
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a><span class="n">response</span> <span class="o">=</span> <span class="n">sales_agent</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context_inputs</span><span class="o">=</span><span class="n">context_inputs</span><span class="p">)</span>
</code></pre></div>
<h5 id="context-cache"><strong>Context Cache</strong></h5>
<p><code>context_cache</code> allows you to store a set of knowledge within the agent's <code>context</code> block.</p>
<p>This is useful when certain information is always passed to the agent before performing a task.</p>
<h4 id="tools_1"><strong>Tools</strong></h4>
<p>Tools are interfaces that allow LLM to perform actions or query information outside the model itself.</p>
<ol>
<li>
<p>Funtion calling – A tool is usually exposed as a function with a defined name, parameters, and types.</p>
</li>
<li>
<p>Example: get_weather(location: str, unit: str)</p>
</li>
<li>
<p>The model decides whether to call this tool and provides the arguments.</p>
</li>
<li>
<p>Extending the Model's Capabilities – Since LLM can't know everything or do everything, these tools allow you to:</p>
</li>
<li>
<p>Search for real-time data (e.g., weather, stock market, databases).</p>
</li>
<li>
<p>Perform precise calculations (mathematical, statistical).</p>
</li>
<li>
<p>Manipulate systems (e.g., send emails, schedule events).</p>
</li>
<li>
<p>Integrate with external APIs.</p>
</li>
<li>
<p>Agent-based orchestration – Often, the LLM acts as an agent that decides:</p>
</li>
<li>
<p>When to use a tool.</p>
</li>
<li>
<p>Which tool to use.</p>
</li>
<li>
<p>How to interpret the tool's output.</p>
</li>
</ol>
<p>In msgFlux a Tool can be <strong>any</strong> callable.</p>
<p>Although more tools allow the agent to perform more actions, if the number is too <strong>high</strong> the model may get confused about which one to use.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">tool_schemas</span> <span class="o">=</span> <span class="p">[{</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>  <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;generate_music&quot;</span><span class="p">,</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Generate a music from a prompt.&quot;</span><span class="p">,</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>      <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Text prompt to describe the music to generate.&quot;</span>
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>        <span class="p">},</span>
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>            <span class="s2">&quot;tempo&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Tempo da música, ex: &#39;rápido&#39;, &#39;lento&#39;.&quot;</span> <span class="p">},</span>
<a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>            <span class="s2">&quot;instrumentos&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
<a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span> <span class="p">},</span>
<a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a>            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Lista de instrumentos principais&quot;</span>
<a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a>            <span class="p">}</span>
<a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a>        <span class="p">},</span>
<a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tempo&quot;</span><span class="p">,</span> <span class="s2">&quot;instrumentos&quot;</span><span class="p">],</span>
<a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a>        <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a>        <span class="p">},</span>
<a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a>      <span class="p">},</span>
<a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a>      <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">],</span>  <span class="c1"># 👈 agora vai</span>
<a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a>      <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a>    <span class="p">}</span>
<a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a>  <span class="p">}</span>
<a id="__codelineno-56-33" name="__codelineno-56-33" href="#__codelineno-56-33"></a><span class="p">}]</span>
<a id="__codelineno-56-34" name="__codelineno-56-34" href="#__codelineno-56-34"></a>
<a id="__codelineno-56-35" name="__codelineno-56-35" href="#__codelineno-56-35"></a><span class="n">r</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="s2">&quot;pode gerar uma música para mim usando a tool, faça um pop?&quot;</span><span class="p">,</span> <span class="n">tool_schemas</span><span class="o">=</span><span class="n">tool_schemas</span><span class="p">)</span>
<a id="__codelineno-56-36" name="__codelineno-56-36" href="#__codelineno-56-36"></a>
<a id="__codelineno-56-37" name="__codelineno-56-37" href="#__codelineno-56-37"></a><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="c1">#.get_calls()</span>
<a id="__codelineno-56-38" name="__codelineno-56-38" href="#__codelineno-56-38"></a>
<a id="__codelineno-56-39" name="__codelineno-56-39" href="#__codelineno-56-39"></a><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_calls</span><span class="p">()</span>
<a id="__codelineno-56-40" name="__codelineno-56-40" href="#__codelineno-56-40"></a>
<a id="__codelineno-56-41" name="__codelineno-56-41" href="#__codelineno-56-41"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-56-42" name="__codelineno-56-42" href="#__codelineno-56-42"></a>
<a id="__codelineno-56-43" name="__codelineno-56-43" href="#__codelineno-56-43"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">call_as_response</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-56-44" name="__codelineno-56-44" href="#__codelineno-56-44"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_music</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-56-45" name="__codelineno-56-45" href="#__codelineno-56-45"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a music from a prompt.&quot;&quot;&quot;</span>
<a id="__codelineno-56-46" name="__codelineno-56-46" href="#__codelineno-56-46"></a>    <span class="k">return</span> <span class="s2">&quot;music&quot;</span>
<a id="__codelineno-56-47" name="__codelineno-56-47" href="#__codelineno-56-47"></a>
<a id="__codelineno-56-48" name="__codelineno-56-48" href="#__codelineno-56-48"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-56-49" name="__codelineno-56-49" href="#__codelineno-56-49"></a>    <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">generate_music</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-56-50" name="__codelineno-56-50" href="#__codelineno-56-50"></a><span class="p">)</span>
<a id="__codelineno-56-51" name="__codelineno-56-51" href="#__codelineno-56-51"></a>
<a id="__codelineno-56-52" name="__codelineno-56-52" href="#__codelineno-56-52"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="s2">&quot;você pode gerar uma música para mim?&quot;</span><span class="p">)</span>
<a id="__codelineno-56-53" name="__codelineno-56-53" href="#__codelineno-56-53"></a>
<a id="__codelineno-56-54" name="__codelineno-56-54" href="#__codelineno-56-54"></a><span class="n">agent</span><span class="o">.</span><span class="n">tool_library</span><span class="o">.</span><span class="n">get_tool_json_schemas</span><span class="p">()</span>
<a id="__codelineno-56-55" name="__codelineno-56-55" href="#__codelineno-56-55"></a>
<a id="__codelineno-56-56" name="__codelineno-56-56" href="#__codelineno-56-56"></a><span class="n">agent</span><span class="o">.</span><span class="n">tool_library</span><span class="o">.</span><span class="n">get_tool_json_schemas</span><span class="p">()</span>
</code></pre></div>
<h5 id="web-scraping-agent"><strong>Web-Scraping Agent</strong></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">scrape_website</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Receives a URL and returns the page content.&quot;&quot;&quot;</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="p">([</span><span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">]):</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a>            <span class="n">tag</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a>        <span class="n">clean_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>        <span class="k">return</span> <span class="n">clean_text</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error accessing </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">userdata</span>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GROQ_API_KEY&quot;</span><span class="p">)</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="n">mf</span><span class="o">.</span><span class="n">set_envs</span><span class="p">(</span><span class="n">GROQ_API_KEY</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="c1"># enable &#39;think&#39;, by default is used in &#39;tool call reasoning&#39;</span>
<a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span>
<a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a>    <span class="s2">&quot;groq/openai/gpt-oss-120b&quot;</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="s2">&quot;low&quot;</span>
<a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a><span class="p">)</span>
<a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a>
<a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a><span class="c1"># return_model_state=True to get the internal state of the agent during execution</span>
<a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a><span class="n">scraper_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a>    <span class="s2">&quot;scraper-agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">scrape_website</span><span class="p">],</span> <span class="n">return_model_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a><span class="p">)</span>
<a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a>
<a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a><span class="n">scraper_agent</span>
<a id="__codelineno-57-34" name="__codelineno-57-34" href="#__codelineno-57-34"></a>
<a id="__codelineno-57-35" name="__codelineno-57-35" href="#__codelineno-57-35"></a><span class="n">site</span> <span class="o">=</span> <span class="s2">&quot;https://bbc.com&quot;</span>
<a id="__codelineno-57-36" name="__codelineno-57-36" href="#__codelineno-57-36"></a>
<a id="__codelineno-57-37" name="__codelineno-57-37" href="#__codelineno-57-37"></a><span class="n">response</span> <span class="o">=</span> <span class="n">scraper_agent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summarize the news on this website: </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-38" name="__codelineno-57-38" href="#__codelineno-57-38"></a>
<a id="__codelineno-57-39" name="__codelineno-57-39" href="#__codelineno-57-39"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">model_state</span><span class="p">)</span>
<a id="__codelineno-57-40" name="__codelineno-57-40" href="#__codelineno-57-40"></a>
<a id="__codelineno-57-41" name="__codelineno-57-41" href="#__codelineno-57-41"></a><span class="n">response</span><span class="o">.</span><span class="n">model_response</span>
<a id="__codelineno-57-42" name="__codelineno-57-42" href="#__codelineno-57-42"></a>
<a id="__codelineno-57-43" name="__codelineno-57-43" href="#__codelineno-57-43"></a><span class="c1"># We&#39;ll have a certain pattern in the task</span>
<a id="__codelineno-57-44" name="__codelineno-57-44" href="#__codelineno-57-44"></a><span class="c1"># where we just want to find out the website summary</span>
<a id="__codelineno-57-45" name="__codelineno-57-45" href="#__codelineno-57-45"></a><span class="c1"># We can simplify it by applying a task_template</span>
<a id="__codelineno-57-46" name="__codelineno-57-46" href="#__codelineno-57-46"></a>
<a id="__codelineno-57-47" name="__codelineno-57-47" href="#__codelineno-57-47"></a><span class="c1"># Define a task_template in jinja format</span>
<a id="__codelineno-57-48" name="__codelineno-57-48" href="#__codelineno-57-48"></a><span class="c1"># In this case we are passing a string directly, insert an empty placeholder {{}}</span>
<a id="__codelineno-57-49" name="__codelineno-57-49" href="#__codelineno-57-49"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;Summarize the news on this site: {{}}&quot;</span>
<a id="__codelineno-57-50" name="__codelineno-57-50" href="#__codelineno-57-50"></a><span class="n">scraper_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-57-51" name="__codelineno-57-51" href="#__codelineno-57-51"></a>    <span class="s2">&quot;scraper&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">scrape_website</span><span class="p">],</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-57-52" name="__codelineno-57-52" href="#__codelineno-57-52"></a><span class="p">)</span>
<a id="__codelineno-57-53" name="__codelineno-57-53" href="#__codelineno-57-53"></a><span class="n">response</span> <span class="o">=</span> <span class="n">scraper_agent</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
<a id="__codelineno-57-54" name="__codelineno-57-54" href="#__codelineno-57-54"></a><span class="n">response</span>
<a id="__codelineno-57-55" name="__codelineno-57-55" href="#__codelineno-57-55"></a>
<a id="__codelineno-57-56" name="__codelineno-57-56" href="#__codelineno-57-56"></a><span class="c1"># use the agent in declarative mode with Message</span>
<a id="__codelineno-57-57" name="__codelineno-57-57" href="#__codelineno-57-57"></a><span class="c1"># define where to read the task in the message</span>
<a id="__codelineno-57-58" name="__codelineno-57-58" href="#__codelineno-57-58"></a><span class="c1"># and where to write the response</span>
<a id="__codelineno-57-59" name="__codelineno-57-59" href="#__codelineno-57-59"></a><span class="n">scraper_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-57-60" name="__codelineno-57-60" href="#__codelineno-57-60"></a>    <span class="s2">&quot;scraper&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">scrape_website</span><span class="p">],</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span><span class="p">,</span>
<a id="__codelineno-57-61" name="__codelineno-57-61" href="#__codelineno-57-61"></a>    <span class="n">task_inputs</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">response_mode</span><span class="o">=</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-57-62" name="__codelineno-57-62" href="#__codelineno-57-62"></a><span class="p">)</span>
<a id="__codelineno-57-63" name="__codelineno-57-63" href="#__codelineno-57-63"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
<a id="__codelineno-57-64" name="__codelineno-57-64" href="#__codelineno-57-64"></a><span class="n">msg</span> <span class="o">=</span> <span class="n">scraper_agent</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-57-65" name="__codelineno-57-65" href="#__codelineno-57-65"></a><span class="n">msg</span>
</code></pre></div>
<h5 id="agent-as-a-tool"><strong>Agent-as-a-Tool</strong></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">userdata</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="n">mf</span><span class="o">.</span><span class="n">set_envs</span><span class="p">(</span><span class="n">OPENAI_API_KEY</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="n">chat_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-nano&quot;</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;Quero um plano alimentar para ganhar massa muscular. Sou homem, tenho 27 anos e 1.78cm.&quot;</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a><span class="n">system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are the General Support Agent.</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="s2">Your job is to handle general user requests, understand their intentions, and decide whether to respond yourself or consult an external tool (expert).</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="n">instructions</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a><span class="s2">Your responsibilities:</span>
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a><span class="s2">- Understand the user&#39;s intent.</span>
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a><span class="s2">- Decide whether you can respond independently or whether you need to call a tool.</span>
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a><span class="s2">- If using a tool, formulate the request in clear, objective language for the expert.</span>
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a><span class="s2">- When the expert responds, formulate a friendly, well-structured final response for the user.</span>
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a><span class="s2">Limitations:</span>
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a><span class="s2">- Don&#39;t invent advanced technical information if you&#39;re not confident.</span>
<a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a><span class="s2">- Whenever possible, use the appropriate expert to provide reliable recommendations.</span>
<a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a>
<a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a><span class="n">tool_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a><span class="s2">Specialist in nutrition, diets, and meal plans.</span>
<a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a><span class="s2">Should be used whenever the user requests:</span>
<a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a><span class="s2">- Diet recommendations.</span>
<a id="__codelineno-58-29" name="__codelineno-58-29" href="#__codelineno-58-29"></a><span class="s2">- Personalized meal plans (e.g., gaining muscle mass, losing weight).</span>
<a id="__codelineno-58-30" name="__codelineno-58-30" href="#__codelineno-58-30"></a><span class="s2">- Balanced meal suggestions.</span>
<a id="__codelineno-58-31" name="__codelineno-58-31" href="#__codelineno-58-31"></a><span class="s2">- Nutritional guidelines for sports or general health.</span>
<a id="__codelineno-58-32" name="__codelineno-58-32" href="#__codelineno-58-32"></a>
<a id="__codelineno-58-33" name="__codelineno-58-33" href="#__codelineno-58-33"></a><span class="s2">Expected inputs:</span>
<a id="__codelineno-58-34" name="__codelineno-58-34" href="#__codelineno-58-34"></a><span class="s2">- User&#39;s goal (e.g., gaining muscle mass, losing weight).</span>
<a id="__codelineno-58-35" name="__codelineno-58-35" href="#__codelineno-58-35"></a><span class="s2">- Dietary restrictions or preferences (if provided).</span>
<a id="__codelineno-58-36" name="__codelineno-58-36" href="#__codelineno-58-36"></a><span class="s2">- Basic contextual information (age, weight, activity level, if available).</span>
<a id="__codelineno-58-37" name="__codelineno-58-37" href="#__codelineno-58-37"></a>
<a id="__codelineno-58-38" name="__codelineno-58-38" href="#__codelineno-58-38"></a><span class="s2">Outputs:</span>
<a id="__codelineno-58-39" name="__codelineno-58-39" href="#__codelineno-58-39"></a><span class="s2">- Structured and practical meal plan.</span>
<a id="__codelineno-58-40" name="__codelineno-58-40" href="#__codelineno-58-40"></a><span class="s2">- Clear meal suggestions (breakfast, lunch, dinner, snacks).</span>
<a id="__codelineno-58-41" name="__codelineno-58-41" href="#__codelineno-58-41"></a><span class="s2">- Notes on possible adjustments if user data is missing.</span>
<a id="__codelineno-58-42" name="__codelineno-58-42" href="#__codelineno-58-42"></a>
<a id="__codelineno-58-43" name="__codelineno-58-43" href="#__codelineno-58-43"></a><span class="s2">Restrictions:</span>
<a id="__codelineno-58-44" name="__codelineno-58-44" href="#__codelineno-58-44"></a><span class="s2">- Not a substitute for medical advice in clinical cases.</span>
<a id="__codelineno-58-45" name="__codelineno-58-45" href="#__codelineno-58-45"></a><span class="s2">- If important information is not provided, return a default plan</span>
<a id="__codelineno-58-46" name="__codelineno-58-46" href="#__codelineno-58-46"></a><span class="s2">and indicate the data that would be necessary for customization.</span>
<a id="__codelineno-58-47" name="__codelineno-58-47" href="#__codelineno-58-47"></a>
<a id="__codelineno-58-48" name="__codelineno-58-48" href="#__codelineno-58-48"></a><span class="s2">Examples of when to use:</span>
<a id="__codelineno-58-49" name="__codelineno-58-49" href="#__codelineno-58-49"></a><span class="s2">- User: &quot;I want a meal plan to gain muscle mass.&quot;</span>
<a id="__codelineno-58-50" name="__codelineno-58-50" href="#__codelineno-58-50"></a>
<a id="__codelineno-58-51" name="__codelineno-58-51" href="#__codelineno-58-51"></a><span class="s2">- User: &quot;What diet should I follow to lose weight quickly?&quot;</span>
<a id="__codelineno-58-52" name="__codelineno-58-52" href="#__codelineno-58-52"></a><span class="s2">- User: &quot;I&#39;m a vegetarian, can you create a diet?&quot;</span>
<a id="__codelineno-58-53" name="__codelineno-58-53" href="#__codelineno-58-53"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-58-54" name="__codelineno-58-54" href="#__codelineno-58-54"></a><span class="n">tool_system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are the Nutrition Expert Agent.&quot;&quot;&quot;</span>
<a id="__codelineno-58-55" name="__codelineno-58-55" href="#__codelineno-58-55"></a><span class="n">tool_instructions</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Your responsibilities:</span>
<a id="__codelineno-58-56" name="__codelineno-58-56" href="#__codelineno-58-56"></a><span class="s2">- Receive instructions from the General Agent regarding the user&#39;s needs.</span>
<a id="__codelineno-58-57" name="__codelineno-58-57" href="#__codelineno-58-57"></a><span class="s2">- Create a clear and practical meal plan tailored to the stated goal.</span>
<a id="__codelineno-58-58" name="__codelineno-58-58" href="#__codelineno-58-58"></a><span class="s2">- Be objective, technical, and structured.</span>
<a id="__codelineno-58-59" name="__codelineno-58-59" href="#__codelineno-58-59"></a><span class="s2">- Return only the requested result, without greetings or additional explanations.</span>
<a id="__codelineno-58-60" name="__codelineno-58-60" href="#__codelineno-58-60"></a><span class="s2">Restrictions:</span>
<a id="__codelineno-58-61" name="__codelineno-58-61" href="#__codelineno-58-61"></a><span class="s2">- Do not provide medical recommendations based on clinical conditions without this information.</span>
<a id="__codelineno-58-62" name="__codelineno-58-62" href="#__codelineno-58-62"></a><span class="s2">- If data is missing (e.g., weight, age, allergies), create a standard plan and indicate what additional information would be needed to customize it..&quot;&quot;&quot;</span>
<a id="__codelineno-58-63" name="__codelineno-58-63" href="#__codelineno-58-63"></a>
<a id="__codelineno-58-64" name="__codelineno-58-64" href="#__codelineno-58-64"></a><span class="n">nutritionist</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-58-65" name="__codelineno-58-65" href="#__codelineno-58-65"></a>    <span class="s2">&quot;nutritionist&quot;</span><span class="p">,</span>
<a id="__codelineno-58-66" name="__codelineno-58-66" href="#__codelineno-58-66"></a>    <span class="n">chat_model</span><span class="p">,</span>
<a id="__codelineno-58-67" name="__codelineno-58-67" href="#__codelineno-58-67"></a>    <span class="c1">#verbose=True,</span>
<a id="__codelineno-58-68" name="__codelineno-58-68" href="#__codelineno-58-68"></a>    <span class="n">system_message</span><span class="o">=</span><span class="n">tool_system_message</span><span class="p">,</span>
<a id="__codelineno-58-69" name="__codelineno-58-69" href="#__codelineno-58-69"></a>    <span class="n">instructions</span><span class="o">=</span><span class="n">tool_instructions</span><span class="p">,</span>
<a id="__codelineno-58-70" name="__codelineno-58-70" href="#__codelineno-58-70"></a>    <span class="n">description</span><span class="o">=</span><span class="n">tool_description</span>
<a id="__codelineno-58-71" name="__codelineno-58-71" href="#__codelineno-58-71"></a><span class="p">)</span>
<a id="__codelineno-58-72" name="__codelineno-58-72" href="#__codelineno-58-72"></a>
<a id="__codelineno-58-73" name="__codelineno-58-73" href="#__codelineno-58-73"></a><span class="n">nutritionist</span>
<a id="__codelineno-58-74" name="__codelineno-58-74" href="#__codelineno-58-74"></a>
<a id="__codelineno-58-75" name="__codelineno-58-75" href="#__codelineno-58-75"></a><span class="n">generalist</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-58-76" name="__codelineno-58-76" href="#__codelineno-58-76"></a>    <span class="s2">&quot;generalist&quot;</span><span class="p">,</span>
<a id="__codelineno-58-77" name="__codelineno-58-77" href="#__codelineno-58-77"></a>    <span class="n">chat_model</span><span class="p">,</span>
<a id="__codelineno-58-78" name="__codelineno-58-78" href="#__codelineno-58-78"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-58-79" name="__codelineno-58-79" href="#__codelineno-58-79"></a>    <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span>
<a id="__codelineno-58-80" name="__codelineno-58-80" href="#__codelineno-58-80"></a>    <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
<a id="__codelineno-58-81" name="__codelineno-58-81" href="#__codelineno-58-81"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">nutritionist</span><span class="p">]</span>
<a id="__codelineno-58-82" name="__codelineno-58-82" href="#__codelineno-58-82"></a><span class="p">)</span>
<a id="__codelineno-58-83" name="__codelineno-58-83" href="#__codelineno-58-83"></a>
<a id="__codelineno-58-84" name="__codelineno-58-84" href="#__codelineno-58-84"></a><span class="n">generalist</span>
<a id="__codelineno-58-85" name="__codelineno-58-85" href="#__codelineno-58-85"></a>
<a id="__codelineno-58-86" name="__codelineno-58-86" href="#__codelineno-58-86"></a><span class="n">response</span> <span class="o">=</span> <span class="n">generalist</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-58-87" name="__codelineno-58-87" href="#__codelineno-58-87"></a>
<a id="__codelineno-58-88" name="__codelineno-58-88" href="#__codelineno-58-88"></a><span class="n">response</span><span class="o">.</span><span class="n">tool_responses</span><span class="o">.</span><span class="n">reasoning</span>
<a id="__codelineno-58-89" name="__codelineno-58-89" href="#__codelineno-58-89"></a>
<a id="__codelineno-58-90" name="__codelineno-58-90" href="#__codelineno-58-90"></a><span class="n">response</span>
</code></pre></div>
<h5 id="writing-good-tools"><strong>Writing Good Tools</strong></h5>
<p>Name tools objectively and directly. This makes them easier to understand and reduces the need for tokens to generate a call.</p>
<p>⛔️ Instead of</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">superfast_brave_web_search</span><span class="p">(</span><span class="n">query_to_search</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</code></pre></div>
<p>✅ Write</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">web_search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</code></pre></div>
<p>Add tool description</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">web_search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Search for content similar to query&#39;&#39;&#39;</span>
</code></pre></div>
<p>If necessary, describe the parameters</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">web_search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Search for content similar to query</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="sd">        query:</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="sd">            Term to search on the web.</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="sd">    &#39;&#39;&#39;</span>
</code></pre></div>
<p>In addition to function-based tools, you can also define class-based tools.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">WebSearch</span><span class="p">:</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Search for content similar to query</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="sd">        query:</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="sd">            Term to search on the web.</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="sd">    &#39;&#39;&#39;</span>    
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>        <span class="k">pass</span>
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">SuperFastBraveWebSearch</span><span class="p">:</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;web_search&quot;</span> <span class="c1"># name is preference over cls.__name__</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Search for content similar to query</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="sd">        Args:</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="sd">            query:</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="sd">                Term to search on the web.</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="sd">        &#39;&#39;&#39;</span>            
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a>        <span class="k">pass</span>
</code></pre></div>
<p>The tool can return any data type. If it's not a string, it will be converted to encoded JSON.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">web_search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Search for content similar to query</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="sd">    Args:</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="sd">        query:</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="sd">            Term to search on the web.</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="sd">    &#39;&#39;&#39;</span>
</code></pre></div>
<p>Write good returns.</p>
<p>⛔️ Instead of
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Sum two numbers.&#39;&#39;&#39;</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>    <span class="k">return</span> <span class="n">c</span>
</code></pre></div></p>
<p>✅ You could write
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Sum two numbers.&#39;&#39;&#39;</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;The sum of </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> plus </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span>    
</code></pre></div></p>
<p>➡️ You can also pass a direct instruction as a response from the tool
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Sum two numbers.&#39;&#39;&#39;</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;You MUST respond to the user that the answer is </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></p>
<h5 id="tool-config"><strong>Tool Config</strong></h5>
<p><code>tool_config</code> is a decorator to inject meta-properties into a tool.</p>
<h6 id="return-direct"><strong>Return Direct</strong></h6>
<p>When a tool has an attribute of <code>return_direct=True</code> the tool result is returned directly as an final response instead of back to the model.</p>
<p>If the model calls 2 tools, and one of them has <code>return_direct=True</code>, both will be returned as the final response.</p>
<p>The exception is if the agent mistypes the tool name. This way, the error is communicated to the agent instead of returning a final response.</p>
<p>Use <code>return_direct=True</code> to reduce Agent calls. Design the tool to return an output that satisfies the user's request.</p>
<p>Another use case is to have the Agent act as a router. Provide specialized agents, and instead of returning to the central Agent, return them directly to the user.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">userdata</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GROQ_API_KEY&quot;</span><span class="p">)</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="n">mf</span><span class="o">.</span><span class="n">set_envs</span><span class="p">(</span><span class="n">GROQ_API_KEY</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>    <span class="s2">&quot;groq/openai/gpt-oss-20b&quot;</span><span class="p">,</span> <span class="n">reasoning_effort</span><span class="o">=</span><span class="s2">&quot;low&quot;</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="p">)</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">return_direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_report</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the report from user.&quot;&quot;&quot;</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>    <span class="k">return</span> <span class="s2">&quot;This is your report...&quot;</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="n">reporter_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>    <span class="s2">&quot;reporter&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_report</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&quot;required&quot;</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="p">)</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="n">response</span> <span class="o">=</span> <span class="n">reporter_agent</span><span class="p">(</span><span class="s2">&quot;Please give me the report.&quot;</span><span class="p">)</span>
</code></pre></div>
<p>The class returns a dict containing a <code>tool_responses</code>. In it, you can observe both the <code>tool_calls</code> and the <code>reasoning</code> behind the tool call, if the provider provides it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">response</span>
</code></pre></div>
<p>Now let's simulate a scenario where we have a programming assistant agent and a Python expert assistant. In this case, the assistant will send a task to the expert, but instead of sending the feedback to the assistant, it will be directed to the user.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">userdata</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="n">mf</span><span class="o">.</span><span class="n">set_envs</span><span class="p">(</span><span class="n">OPENAI_API_KEY</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="n">generalist_system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="s2">You are a generalist programming assistant.</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="s2">Your role is to help with common questions about programming languages,</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="s2">best practices, and concept explanations. You must respond clearly and</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="s2">didactically, serving as a support for those learning.</span>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a><span class="n">python_system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a><span class="s2">You are a software engineer specializing in Python performance optimization.</span>
<a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a><span class="s2">Your role is to analyze specific cases and suggest advanced solutions,</span>
<a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a><span class="s2">including benchmarks, bottleneck analysis, and the use of performance-specific libraries.</span>
<a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a><span class="n">python_description</span> <span class="o">=</span> <span class="s2">&quot;An expert in high performance python code.&quot;</span>
<a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>
<a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a><span class="n">python_engineer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>    <span class="s2">&quot;python_engineer&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">system_message</span><span class="o">=</span><span class="n">python_system_message</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">python_description</span>
<a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a><span class="p">)</span>
<a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a>
<a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a><span class="n">mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">return_direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">python_engineer</span><span class="p">)</span>
<a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>
<a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a><span class="n">generalist_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a>    <span class="s2">&quot;generalist&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">python_engineer</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a>    <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="n">system_message</span><span class="o">=</span><span class="n">generalist_system_message</span>
<a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="p">)</span>
<a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a>
<a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;What is the difference between threading and multiprocessing in Python?&quot;</span>
<a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a>
<a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a><span class="n">response</span> <span class="o">=</span> <span class="n">generalist_agent</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a>
<a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a><span class="n">response</span>
</code></pre></div>
<p>Note that the generalist agent still had to write a message to the Python engineer containing almost the same message as the user. We can do better.</p>
<h6 id="inject-model-state"><strong>Inject Model State</strong></h6>
<p>Model State is the internal state (user, assistant, and tool messages) from the Agent</p>
<p>For <code>inject_model_state=True</code>, the tool will receive the it as <code>task_messages</code> input.</p>
<p>This is useful if you want to review the agent's current context. You can perform context inspection.</p>
<p>Another use case is multimodal context. If the user assigns a task containing an image, that image can be accessed within the tool.</p>
<p>Let's make a fictional tool that checks the user's last message and tells if it's safe.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="c1"># mock tool</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_model_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_safe</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This tool checks whether the user&#39;s message is secure.</span>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="sd">    If True, respond naturally to the user. If False, reject</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="sd">    any further conversation with them.</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>    <span class="n">task_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_messages&quot;</span><span class="p">)</span>
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">task_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>    <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a><span class="n">assistant</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>    <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">check_safe</span><span class="p">],</span>
<a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
<a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="p">)</span>
<a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>
<a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a><span class="n">response</span> <span class="o">=</span> <span class="n">assistant</span><span class="p">(</span><span class="s2">&quot;Hi, can you tell me a joke?&quot;</span><span class="p">)</span>
<a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>
<a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a><span class="n">response</span>
</code></pre></div>
<h6 id="handoff"><strong>Handoff</strong></h6>
<p>When <code>handoff=True</code> is passed, two <code>tool_config</code> properties are set to True: <code>return_direct</code> and <code>inject_model_state</code>.</p>
<p>Furthermore, <code>handoff=True</code> changes the tool name to 'transfer_to_original_name' and removes the inputs parameters.</p>
<p>Originally, each agent receives <code>message</code> as input. Let's remove this parameter and pass the message history to the agent-as-a-tool as<code>task_messages</code>.</p>
<p>Let's simulate a business scenario where we have a financial consultant and a startup specialist. When the consultant identifies a demand, they'll transfer it to the startup specialist, who will respond directly to the user.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="n">startup_specialist_system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="s2">You are a strategist specializing in scaling digital startups.</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="s2">Your focus is creating accelerated growth plans, analyzing metrics</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="s2">(CAC, LTV, churn), proposing customer acquisition tests,</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="s2">funding strategies, and international expansion. Your answers should</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="s2">be detailed and data-driven.</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="n">startup_specialist_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a><span class="s2">An agent specializing in startups, always consult him if this is the topic.</span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a><span class="n">startup_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>    <span class="s2">&quot;startup_specialist&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a>    <span class="n">system_message</span><span class="o">=</span><span class="n">startup_specialist_system_message</span><span class="p">,</span>
<a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>    <span class="n">description</span><span class="o">=</span><span class="n">startup_specialist_description</span><span class="p">,</span>
<a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a><span class="p">)</span>
<a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a>
<a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a><span class="n">mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">handoff</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">startup_agent</span><span class="p">)</span>
<a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a>
<a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a><span class="n">consultant_system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a><span class="s2">You are a generalist business consultant. Your goal is to provide accessible</span>
<a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a><span class="s2">advice on management, marketing, finance, and business operations. Your</span>
<a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a><span class="s2">answers should be clear, practical, and useful for early-stage entrepreneurs.</span>
<a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a>
<a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a><span class="s2">If the context is a startup, transfer it to the expert.</span>
<a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a>
<a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a><span class="n">consultant_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a>    <span class="s2">&quot;consultant&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">system_message</span><span class="o">=</span><span class="n">consultant_system_message</span><span class="p">,</span>
<a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">startup_agent</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a><span class="p">)</span>
<a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a>
<a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a><span class="n">consultant_agent</span>
<a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a>
<a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a><span class="s2">My SaaS startup has a CAC of $120 and an LTV of $600. I want to scale to</span>
<a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a><span class="s2">another Latin American market in 6 months. What would be an efficient</span>
<a id="__codelineno-73-39" name="__codelineno-73-39" href="#__codelineno-73-39"></a><span class="s2">strategy to reduce CAC while accelerating entry into this new market?</span>
<a id="__codelineno-73-40" name="__codelineno-73-40" href="#__codelineno-73-40"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-73-41" name="__codelineno-73-41" href="#__codelineno-73-41"></a>
<a id="__codelineno-73-42" name="__codelineno-73-42" href="#__codelineno-73-42"></a><span class="n">response</span> <span class="o">=</span> <span class="n">consultant_agent</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-73-43" name="__codelineno-73-43" href="#__codelineno-73-43"></a>
<a id="__codelineno-73-44" name="__codelineno-73-44" href="#__codelineno-73-44"></a><span class="n">response</span>
</code></pre></div>
<h6 id="call-as-response"><strong>Call as Response</strong></h6>
<p>Sometimes you simply need the agent to call a tool without actually executing it.</p>
<p>The <code>call_as_response</code> attribute allows the tool to be returned as a final response without executing if called. The <code>return_direct</code> attribute is automatically set to <code>True</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">call_as_response</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_sales_report</span><span class="p">(</span><span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">group_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a sales report within a given date range.</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="sd">        start_date: Start date in YYYY-MM-DD format.</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="sd">        end_date: End date in YYYY-MM-DD format.</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="sd">        metrics: List of metrics to include (e.g., [&quot;revenue&quot;, &quot;orders&quot;, &quot;profit&quot;]).</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="sd">        group_by: Dimension to group data by (e.g., &quot;region&quot;, &quot;product&quot;, &quot;sales_rep&quot;).</span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="sd">    Returns:</span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="sd">        A structured sales report as a dictionary.</span>
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a>    <span class="k">return</span>
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="n">system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="s2">You&#39;re a BI analyst. When a user requests sales reports, you shouldn&#39;t respond</span>
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="s2">with explanatory text. You should simply correctly complete the generate_sales_report</span>
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="s2">tool call, extracting the requested metrics, dates, and groupings.</span>
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a>                 <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">generate_sales_report</span><span class="p">]</span>
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a><span class="p">)</span>
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a>
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;I need a report of sales between July 1st and August 31st, 2025, showing revenue and profit, grouped by region.&quot;</span>
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a>
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a><span class="n">response</span> <span class="o">=</span>  <span class="n">agent</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a>
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a><span class="n">response</span>
</code></pre></div>
<h6 id="background"><strong>Background</strong></h6>
<p>Some tools may take longer to return results. And it's not always necessary to wait for this result to continue the workflow.</p>
<p>For this, there's the <code>background</code> property, which allows the tool to run in the background and return a standard message to the Agent to indicate that it's running.</p>
<p>For background tools it is necessary to be <code>async</code> or have <code>.acall</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_email_to_vendor</span><span class="p">():</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Send an email to the vendor.&quot;&quot;&quot;</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sending email to vendor...&quot;</span><span class="p">)</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">send_email_to_vendor</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="c1"># An indication that it will be executed in the background is added to the docstring.</span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="n">agent</span><span class="o">.</span><span class="n">tool_library</span><span class="o">.</span><span class="n">get_tool_json_schemas</span><span class="p">()</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="n">responnse</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="s2">&quot;I need to send an email to the vendor.&quot;</span><span class="p">)</span>
</code></pre></div>
<h6 id="name-override"><strong>Name Override</strong></h6>
<p>Use <code>name_override</code> to assign a new name to the tool.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">name_override</span><span class="o">=</span><span class="s2">&quot;web_search&quot;</span><span class="p">)</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">brave_super_fast_web_search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Search for content similar to query</span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="sd">        query:</span>
<a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a><span class="sd">            Term to search on the web.</span>
<a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>    <span class="k">pass</span>
<a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>
<a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">brave_super_fast_web_search</span><span class="p">])</span>
<a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>
<a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a><span class="n">agent</span><span class="o">.</span><span class="n">tool_library</span><span class="o">.</span><span class="n">get_tool_json_schemas</span><span class="p">()</span>
</code></pre></div>
<h6 id="inject-vars"><strong>Inject Vars</strong></h6>
<p>With <code>inject_vars=True</code> the Agent now has a set of variables that can be inserted and modified within the tools.</p>
<p><strong>Agent with External Token Information</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_csv</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save user csv on S3.&quot;&quot;&quot;</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;My token: </span><span class="si">{</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;aws_token&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>    <span class="k">return</span> <span class="s2">&quot;CSV saved&quot;</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">save_csv</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="n">agent</span><span class="p">(</span><span class="s2">&quot;please send me this csv&quot;</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;aws_token&quot;</span><span class="p">:</span> <span class="s2">&quot;token&quot;</span><span class="p">})</span>
</code></pre></div>
<p><strong>ChatBot - Personal Assistant</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_var</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a variable with the given name and value.&quot;&quot;&quot;</span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>    <span class="nb">vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> var&quot;</span>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_var</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a variable with the given name.&quot;&quot;&quot;</span>
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a>    <span class="k">return</span> <span class="nb">vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a>
<a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_vars</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all variables.&quot;&quot;&quot;</span>
<a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a>    <span class="k">return</span> <span class="nb">vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># always return a copy</span>
<a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a>
<a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a><span class="n">agent_system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-78-21" name="__codelineno-78-21" href="#__codelineno-78-21"></a><span class="s2">You are Ultron, a personal assistant.</span>
<a id="__codelineno-78-22" name="__codelineno-78-22" href="#__codelineno-78-22"></a><span class="s2">The assistant is helpful, creative, clever, and very friendly.</span>
<a id="__codelineno-78-23" name="__codelineno-78-23" href="#__codelineno-78-23"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-78-24" name="__codelineno-78-24" href="#__codelineno-78-24"></a>
<a id="__codelineno-78-25" name="__codelineno-78-25" href="#__codelineno-78-25"></a><span class="n">agent_instructions</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-78-26" name="__codelineno-78-26" href="#__codelineno-78-26"></a><span class="s2">You have access to a set of variables, use tools to manipulate data.</span>
<a id="__codelineno-78-27" name="__codelineno-78-27" href="#__codelineno-78-27"></a><span class="s2">Variables are mutable, so it&#39;s not safe to rely on the results of previous calls.</span>
<a id="__codelineno-78-28" name="__codelineno-78-28" href="#__codelineno-78-28"></a><span class="s2">Whenever you need new information, use the tools to access the variables and see</span>
<a id="__codelineno-78-29" name="__codelineno-78-29" href="#__codelineno-78-29"></a><span class="s2">if any are useful. If you don&#39;t know the exact name of the variable,</span>
<a id="__codelineno-78-30" name="__codelineno-78-30" href="#__codelineno-78-30"></a><span class="s2">access them all using &#39;get_vars&#39;.</span>
<a id="__codelineno-78-31" name="__codelineno-78-31" href="#__codelineno-78-31"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-78-32" name="__codelineno-78-32" href="#__codelineno-78-32"></a>
<a id="__codelineno-78-33" name="__codelineno-78-33" href="#__codelineno-78-33"></a><span class="n">ultron</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-78-34" name="__codelineno-78-34" href="#__codelineno-78-34"></a>    <span class="s2">&quot;ultron&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">system_message</span><span class="o">=</span><span class="n">agent_system_message</span><span class="p">,</span>
<a id="__codelineno-78-35" name="__codelineno-78-35" href="#__codelineno-78-35"></a>    <span class="n">instructions</span><span class="o">=</span><span class="n">agent_instructions</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-78-36" name="__codelineno-78-36" href="#__codelineno-78-36"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">save_var</span><span class="p">,</span> <span class="n">get_var</span><span class="p">,</span> <span class="n">get_vars</span><span class="p">]</span>
<a id="__codelineno-78-37" name="__codelineno-78-37" href="#__codelineno-78-37"></a><span class="p">)</span>
<a id="__codelineno-78-38" name="__codelineno-78-38" href="#__codelineno-78-38"></a>
<a id="__codelineno-78-39" name="__codelineno-78-39" href="#__codelineno-78-39"></a><span class="nb">vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Tony Stark&quot;</span><span class="p">}</span>
<a id="__codelineno-78-40" name="__codelineno-78-40" href="#__codelineno-78-40"></a>
<a id="__codelineno-78-41" name="__codelineno-78-41" href="#__codelineno-78-41"></a><span class="n">chat_history</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ChatML</span><span class="p">()</span>
<a id="__codelineno-78-42" name="__codelineno-78-42" href="#__codelineno-78-42"></a>
<a id="__codelineno-78-43" name="__codelineno-78-43" href="#__codelineno-78-43"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;Hey Ultron, are you ok? do you remember my name?&quot;</span>
<a id="__codelineno-78-44" name="__codelineno-78-44" href="#__codelineno-78-44"></a>
<a id="__codelineno-78-45" name="__codelineno-78-45" href="#__codelineno-78-45"></a><span class="n">chat_history</span><span class="o">.</span><span class="n">add_user_message</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-78-46" name="__codelineno-78-46" href="#__codelineno-78-46"></a>
<a id="__codelineno-78-47" name="__codelineno-78-47" href="#__codelineno-78-47"></a><span class="n">response</span> <span class="o">=</span> <span class="n">ultron</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>
<a id="__codelineno-78-48" name="__codelineno-78-48" href="#__codelineno-78-48"></a>
<a id="__codelineno-78-49" name="__codelineno-78-49" href="#__codelineno-78-49"></a><span class="n">chat_history</span><span class="o">.</span><span class="n">add_assist_message</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-78-50" name="__codelineno-78-50" href="#__codelineno-78-50"></a>
<a id="__codelineno-78-51" name="__codelineno-78-51" href="#__codelineno-78-51"></a><span class="n">task2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-78-52" name="__codelineno-78-52" href="#__codelineno-78-52"></a><span class="s2">I have some very important information to share with you,</span>
<a id="__codelineno-78-53" name="__codelineno-78-53" href="#__codelineno-78-53"></a><span class="s2">and you shouldn&#39;t forget it. I&#39;m starting a new nanotechnology</span>
<a id="__codelineno-78-54" name="__codelineno-78-54" href="#__codelineno-78-54"></a><span class="s2">project to build the Mark-999. I&#39;ll be using adamantium for added rigidity.</span>
<a id="__codelineno-78-55" name="__codelineno-78-55" href="#__codelineno-78-55"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-78-56" name="__codelineno-78-56" href="#__codelineno-78-56"></a>
<a id="__codelineno-78-57" name="__codelineno-78-57" href="#__codelineno-78-57"></a><span class="n">chat_history</span><span class="o">.</span><span class="n">add_user_message</span><span class="p">(</span><span class="n">task2</span><span class="p">)</span>
<a id="__codelineno-78-58" name="__codelineno-78-58" href="#__codelineno-78-58"></a>
<a id="__codelineno-78-59" name="__codelineno-78-59" href="#__codelineno-78-59"></a><span class="n">ultron</span><span class="p">(</span><span class="n">task_messages</span><span class="o">=</span><span class="n">chat_history</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(),</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>
</code></pre></div>
<p>That was fun. We can take the strategy to the next-level of var manipulation.</p>
<p><strong>ChatBot - Reporter</strong></p>
<p>Let's create a chatbot that will interact with a user. This user will describe a summary of a field experience.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.utils.msgspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">msgspec_dumps</span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rapidfuzz</span><span class="w"> </span><span class="kn">import</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">process</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_var</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a variable with the given name and value.&quot;&quot;&quot;</span>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>    <span class="nb">vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Saved &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; var&quot;</span>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_var</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a variable with the given name.&quot;&quot;&quot;</span>
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>    <span class="n">var</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Variable not found: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>    <span class="k">return</span> <span class="n">var</span>
<a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>
<a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_vars</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all variables.&quot;&quot;&quot;</span>
<a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a>    <span class="k">return</span> <span class="nb">vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># always return a copy</span>
<a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a>
<a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_direct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_report</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-79-29" name="__codelineno-79-29" href="#__codelineno-79-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the report from user.&quot;&quot;&quot;</span>
<a id="__codelineno-79-30" name="__codelineno-79-30" href="#__codelineno-79-30"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-79-31" name="__codelineno-79-31" href="#__codelineno-79-31"></a>    <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-79-32" name="__codelineno-79-32" href="#__codelineno-79-32"></a><span class="s2">    Here is the current status of the report:</span>
<a id="__codelineno-79-33" name="__codelineno-79-33" href="#__codelineno-79-33"></a><span class="s2">    company_name: `</span><span class="si">{</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;company_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">`</span>
<a id="__codelineno-79-34" name="__codelineno-79-34" href="#__codelineno-79-34"></a><span class="s2">    date: `</span><span class="si">{</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">`</span>
<a id="__codelineno-79-35" name="__codelineno-79-35" href="#__codelineno-79-35"></a><span class="s2">    local: `</span><span class="si">{</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">`</span>
<a id="__codelineno-79-36" name="__codelineno-79-36" href="#__codelineno-79-36"></a><span class="s2">    participants_internal: </span><span class="si">{</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;participants_internal&quot;</span><span class="p">]</span><span class="si">}</span>
<a id="__codelineno-79-37" name="__codelineno-79-37" href="#__codelineno-79-37"></a><span class="s2">    participants_external: </span><span class="si">{</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;participants_external&quot;</span><span class="p">]</span><span class="si">}</span>
<a id="__codelineno-79-38" name="__codelineno-79-38" href="#__codelineno-79-38"></a><span class="s2">    objective: `</span><span class="si">{</span><span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;objective&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">`</span>
<a id="__codelineno-79-39" name="__codelineno-79-39" href="#__codelineno-79-39"></a><span class="s2">    &quot;&quot;&quot;</span>
<a id="__codelineno-79-40" name="__codelineno-79-40" href="#__codelineno-79-40"></a>    <span class="n">objective</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-79-41" name="__codelineno-79-41" href="#__codelineno-79-41"></a>    <span class="k">if</span> <span class="n">objective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-79-42" name="__codelineno-79-42" href="#__codelineno-79-42"></a>        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;objective: `</span><span class="si">{</span><span class="n">objective</span><span class="si">}</span><span class="s2">`&quot;</span>
<a id="__codelineno-79-43" name="__codelineno-79-43" href="#__codelineno-79-43"></a>    <span class="n">detail</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-79-44" name="__codelineno-79-44" href="#__codelineno-79-44"></a>    <span class="k">if</span> <span class="n">detail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-79-45" name="__codelineno-79-45" href="#__codelineno-79-45"></a>        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;detail: `</span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">`&quot;</span>
<a id="__codelineno-79-46" name="__codelineno-79-46" href="#__codelineno-79-46"></a>    <span class="n">main_points_discussed</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main_points_discussed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-79-47" name="__codelineno-79-47" href="#__codelineno-79-47"></a>    <span class="k">if</span> <span class="n">main_points_discussed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-79-48" name="__codelineno-79-48" href="#__codelineno-79-48"></a>        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;main_points_discussed: `</span><span class="si">{</span><span class="n">main_points_discussed</span><span class="si">}</span><span class="s2">`&quot;</span>
<a id="__codelineno-79-49" name="__codelineno-79-49" href="#__codelineno-79-49"></a>    <span class="n">opportunities_identified</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opportunities_identified&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-79-50" name="__codelineno-79-50" href="#__codelineno-79-50"></a>    <span class="k">if</span> <span class="n">opportunities_identified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-79-51" name="__codelineno-79-51" href="#__codelineno-79-51"></a>        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;opportunities_identified: `</span><span class="si">{</span><span class="n">opportunities_identified</span><span class="si">}</span><span class="s2">`&quot;</span>
<a id="__codelineno-79-52" name="__codelineno-79-52" href="#__codelineno-79-52"></a>    <span class="n">next_steps</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_steps&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-79-53" name="__codelineno-79-53" href="#__codelineno-79-53"></a>    <span class="k">if</span> <span class="n">next_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-79-54" name="__codelineno-79-54" href="#__codelineno-79-54"></a>        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;next_steps: `</span><span class="si">{</span><span class="n">next_steps</span><span class="si">}</span><span class="s2">`&quot;</span>
<a id="__codelineno-79-55" name="__codelineno-79-55" href="#__codelineno-79-55"></a>    <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;Confirm the data to save?&quot;</span>
<a id="__codelineno-79-56" name="__codelineno-79-56" href="#__codelineno-79-56"></a>    <span class="k">return</span> <span class="n">report</span>
<a id="__codelineno-79-57" name="__codelineno-79-57" href="#__codelineno-79-57"></a>
<a id="__codelineno-79-58" name="__codelineno-79-58" href="#__codelineno-79-58"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-59" name="__codelineno-79-59" href="#__codelineno-79-59"></a><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-79-60" name="__codelineno-79-60" href="#__codelineno-79-60"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the report.&quot;&quot;&quot;</span>
<a id="__codelineno-79-61" name="__codelineno-79-61" href="#__codelineno-79-61"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-79-62" name="__codelineno-79-62" href="#__codelineno-79-62"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;report.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-79-63" name="__codelineno-79-63" href="#__codelineno-79-63"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msgspec_dumps</span><span class="p">(</span><span class="nb">vars</span><span class="p">))</span>
<a id="__codelineno-79-64" name="__codelineno-79-64" href="#__codelineno-79-64"></a>    <span class="k">return</span> <span class="s2">&quot;Report saved&quot;</span>
<a id="__codelineno-79-65" name="__codelineno-79-65" href="#__codelineno-79-65"></a>
<a id="__codelineno-79-66" name="__codelineno-79-66" href="#__codelineno-79-66"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-67" name="__codelineno-79-67" href="#__codelineno-79-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_company</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-79-68" name="__codelineno-79-68" href="#__codelineno-79-68"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if company name is correct&quot;&quot;&quot;</span>
<a id="__codelineno-79-69" name="__codelineno-79-69" href="#__codelineno-79-69"></a>    <span class="n">company_list</span> <span class="o">=</span> <span class="p">[</span> <span class="c1"># mock</span>
<a id="__codelineno-79-70" name="__codelineno-79-70" href="#__codelineno-79-70"></a>        <span class="s2">&quot;Globex Corporation&quot;</span><span class="p">,</span>
<a id="__codelineno-79-71" name="__codelineno-79-71" href="#__codelineno-79-71"></a>        <span class="s2">&quot;Initech Ltd.&quot;</span><span class="p">,</span>
<a id="__codelineno-79-72" name="__codelineno-79-72" href="#__codelineno-79-72"></a>        <span class="s2">&quot;Umbrella Industries&quot;</span><span class="p">,</span>
<a id="__codelineno-79-73" name="__codelineno-79-73" href="#__codelineno-79-73"></a>        <span class="s2">&quot;Stark Enterprises&quot;</span><span class="p">,</span>
<a id="__codelineno-79-74" name="__codelineno-79-74" href="#__codelineno-79-74"></a>        <span class="s2">&quot;Wayne Technologies&quot;</span>
<a id="__codelineno-79-75" name="__codelineno-79-75" href="#__codelineno-79-75"></a>    <span class="p">]</span>
<a id="__codelineno-79-76" name="__codelineno-79-76" href="#__codelineno-79-76"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-79-77" name="__codelineno-79-77" href="#__codelineno-79-77"></a>    <span class="n">bests</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">company_list</span><span class="p">,</span> <span class="n">scorer</span><span class="o">=</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-79-78" name="__codelineno-79-78" href="#__codelineno-79-78"></a>
<a id="__codelineno-79-79" name="__codelineno-79-79" href="#__codelineno-79-79"></a>    <span class="k">if</span> <span class="n">bests</span> <span class="ow">and</span> <span class="n">bests</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-79-80" name="__codelineno-79-80" href="#__codelineno-79-80"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;✔ Company found: &#39;</span><span class="si">{</span><span class="n">bests</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (exact match)&quot;</span>
<a id="__codelineno-79-81" name="__codelineno-79-81" href="#__codelineno-79-81"></a>
<a id="__codelineno-79-82" name="__codelineno-79-82" href="#__codelineno-79-82"></a>    <span class="k">if</span> <span class="n">bests</span> <span class="ow">and</span> <span class="n">bests</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">:</span>
<a id="__codelineno-79-83" name="__codelineno-79-83" href="#__codelineno-79-83"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;⚠ No exact match. Closest suggestion: &#39;</span><span class="si">{</span><span class="n">bests</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">bests</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%)&quot;</span>
<a id="__codelineno-79-84" name="__codelineno-79-84" href="#__codelineno-79-84"></a>
<a id="__codelineno-79-85" name="__codelineno-79-85" href="#__codelineno-79-85"></a>    <span class="n">suggestions</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bests</span><span class="p">])</span>
<a id="__codelineno-79-86" name="__codelineno-79-86" href="#__codelineno-79-86"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;❌ Company not found. Suggestions: </span><span class="si">{</span><span class="n">suggestions</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-79-87" name="__codelineno-79-87" href="#__codelineno-79-87"></a>
<a id="__codelineno-79-88" name="__codelineno-79-88" href="#__codelineno-79-88"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_participants</span><span class="p">(</span>
<a id="__codelineno-79-89" name="__codelineno-79-89" href="#__codelineno-79-89"></a>    <span class="n">participants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">known_participants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-79-90" name="__codelineno-79-90" href="#__codelineno-79-90"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-79-91" name="__codelineno-79-91" href="#__codelineno-79-91"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-79-92" name="__codelineno-79-92" href="#__codelineno-79-92"></a>
<a id="__codelineno-79-93" name="__codelineno-79-93" href="#__codelineno-79-93"></a>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">participants</span><span class="p">:</span>
<a id="__codelineno-79-94" name="__codelineno-79-94" href="#__codelineno-79-94"></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-79-95" name="__codelineno-79-95" href="#__codelineno-79-95"></a>        <span class="n">best_matches</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">known_participants</span><span class="p">,</span> <span class="n">scorer</span><span class="o">=</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-79-96" name="__codelineno-79-96" href="#__codelineno-79-96"></a>
<a id="__codelineno-79-97" name="__codelineno-79-97" href="#__codelineno-79-97"></a>        <span class="k">if</span> <span class="n">best_matches</span> <span class="ow">and</span> <span class="n">best_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-79-98" name="__codelineno-79-98" href="#__codelineno-79-98"></a>            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;✔ Exact match: &#39;</span><span class="si">{</span><span class="n">best_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-79-99" name="__codelineno-79-99" href="#__codelineno-79-99"></a>        <span class="k">elif</span> <span class="n">best_matches</span> <span class="ow">and</span> <span class="n">best_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">:</span>
<a id="__codelineno-79-100" name="__codelineno-79-100" href="#__codelineno-79-100"></a>            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⚠ No exact match. Closest: &#39;</span><span class="si">{</span><span class="n">best_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">best_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%)&quot;</span>
<a id="__codelineno-79-101" name="__codelineno-79-101" href="#__codelineno-79-101"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-79-102" name="__codelineno-79-102" href="#__codelineno-79-102"></a>            <span class="n">suggestions</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">best_matches</span><span class="p">])</span>
<a id="__codelineno-79-103" name="__codelineno-79-103" href="#__codelineno-79-103"></a>            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;❌ Not found. Suggestions: </span><span class="si">{</span><span class="n">suggestions</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-79-104" name="__codelineno-79-104" href="#__codelineno-79-104"></a>
<a id="__codelineno-79-105" name="__codelineno-79-105" href="#__codelineno-79-105"></a>    <span class="k">return</span> <span class="n">results</span>
<a id="__codelineno-79-106" name="__codelineno-79-106" href="#__codelineno-79-106"></a>
<a id="__codelineno-79-107" name="__codelineno-79-107" href="#__codelineno-79-107"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-108" name="__codelineno-79-108" href="#__codelineno-79-108"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_internal_participants</span><span class="p">(</span><span class="n">participants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-79-109" name="__codelineno-79-109" href="#__codelineno-79-109"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if internal participants are correct&quot;&quot;&quot;</span>
<a id="__codelineno-79-110" name="__codelineno-79-110" href="#__codelineno-79-110"></a>    <span class="n">known_participants</span> <span class="o">=</span> <span class="p">[</span> <span class="c1"># mock</span>
<a id="__codelineno-79-111" name="__codelineno-79-111" href="#__codelineno-79-111"></a>        <span class="s2">&quot;Michael Thompson&quot;</span><span class="p">,</span>
<a id="__codelineno-79-112" name="__codelineno-79-112" href="#__codelineno-79-112"></a>        <span class="s2">&quot;Sarah Connor&quot;</span><span class="p">,</span>
<a id="__codelineno-79-113" name="__codelineno-79-113" href="#__codelineno-79-113"></a>        <span class="s2">&quot;David Martinez&quot;</span><span class="p">,</span>
<a id="__codelineno-79-114" name="__codelineno-79-114" href="#__codelineno-79-114"></a>        <span class="s2">&quot;Emily Johnson&quot;</span><span class="p">,</span>
<a id="__codelineno-79-115" name="__codelineno-79-115" href="#__codelineno-79-115"></a>        <span class="s2">&quot;Robert Williams&quot;</span>
<a id="__codelineno-79-116" name="__codelineno-79-116" href="#__codelineno-79-116"></a>    <span class="p">]</span>
<a id="__codelineno-79-117" name="__codelineno-79-117" href="#__codelineno-79-117"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">check_participants</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span> <span class="n">known_participants</span><span class="p">)</span>
<a id="__codelineno-79-118" name="__codelineno-79-118" href="#__codelineno-79-118"></a>    <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;Internal participants:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">report</span>
<a id="__codelineno-79-119" name="__codelineno-79-119" href="#__codelineno-79-119"></a>    <span class="k">return</span> <span class="n">report</span>
<a id="__codelineno-79-120" name="__codelineno-79-120" href="#__codelineno-79-120"></a>
<a id="__codelineno-79-121" name="__codelineno-79-121" href="#__codelineno-79-121"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-79-122" name="__codelineno-79-122" href="#__codelineno-79-122"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_external_participants</span><span class="p">(</span><span class="n">participants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-79-123" name="__codelineno-79-123" href="#__codelineno-79-123"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if external participants are correct&quot;&quot;&quot;</span>
<a id="__codelineno-79-124" name="__codelineno-79-124" href="#__codelineno-79-124"></a>    <span class="n">known_participants</span> <span class="o">=</span> <span class="p">[</span> <span class="c1"># mock</span>
<a id="__codelineno-79-125" name="__codelineno-79-125" href="#__codelineno-79-125"></a>        <span class="s2">&quot;Anna Schmidt&quot;</span><span class="p">,</span>
<a id="__codelineno-79-126" name="__codelineno-79-126" href="#__codelineno-79-126"></a>        <span class="s2">&quot;Hiroshi Tanaka&quot;</span><span class="p">,</span>
<a id="__codelineno-79-127" name="__codelineno-79-127" href="#__codelineno-79-127"></a>        <span class="s2">&quot;Laura Rossi&quot;</span><span class="p">,</span>
<a id="__codelineno-79-128" name="__codelineno-79-128" href="#__codelineno-79-128"></a>        <span class="s2">&quot;Jean-Pierre Dupont&quot;</span><span class="p">,</span>
<a id="__codelineno-79-129" name="__codelineno-79-129" href="#__codelineno-79-129"></a>        <span class="s2">&quot;Carlos Fernandez&quot;</span>
<a id="__codelineno-79-130" name="__codelineno-79-130" href="#__codelineno-79-130"></a>    <span class="p">]</span>
<a id="__codelineno-79-131" name="__codelineno-79-131" href="#__codelineno-79-131"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">check_participants</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span> <span class="n">known_participants</span><span class="p">)</span>
<a id="__codelineno-79-132" name="__codelineno-79-132" href="#__codelineno-79-132"></a>    <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<a id="__codelineno-79-133" name="__codelineno-79-133" href="#__codelineno-79-133"></a>    <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;External participants:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">report</span>
<a id="__codelineno-79-134" name="__codelineno-79-134" href="#__codelineno-79-134"></a>    <span class="k">return</span> <span class="n">report</span>
<a id="__codelineno-79-135" name="__codelineno-79-135" href="#__codelineno-79-135"></a>
<a id="__codelineno-79-136" name="__codelineno-79-136" href="#__codelineno-79-136"></a><span class="n">system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-79-137" name="__codelineno-79-137" href="#__codelineno-79-137"></a><span class="s2">You are a visitor report collection assistant.</span>
<a id="__codelineno-79-138" name="__codelineno-79-138" href="#__codelineno-79-138"></a><span class="s2">Your goal is to capture the fields we want to extract</span>
<a id="__codelineno-79-139" name="__codelineno-79-139" href="#__codelineno-79-139"></a><span class="s2">from their speech during a conversation with the user.</span>
<a id="__codelineno-79-140" name="__codelineno-79-140" href="#__codelineno-79-140"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-79-141" name="__codelineno-79-141" href="#__codelineno-79-141"></a>
<a id="__codelineno-79-142" name="__codelineno-79-142" href="#__codelineno-79-142"></a><span class="n">instructions</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-79-143" name="__codelineno-79-143" href="#__codelineno-79-143"></a><span class="s2">Here is the schema we want to get from the user report.</span>
<a id="__codelineno-79-144" name="__codelineno-79-144" href="#__codelineno-79-144"></a><span class="s2">Report:</span>
<a id="__codelineno-79-145" name="__codelineno-79-145" href="#__codelineno-79-145"></a><span class="s2">    company_name: str</span>
<a id="__codelineno-79-146" name="__codelineno-79-146" href="#__codelineno-79-146"></a><span class="s2">    date: str</span>
<a id="__codelineno-79-147" name="__codelineno-79-147" href="#__codelineno-79-147"></a><span class="s2">    local: str (city, address)</span>
<a id="__codelineno-79-148" name="__codelineno-79-148" href="#__codelineno-79-148"></a><span class="s2">    participants_internal: list[str]</span>
<a id="__codelineno-79-149" name="__codelineno-79-149" href="#__codelineno-79-149"></a><span class="s2">    participants_external: list[str]</span>
<a id="__codelineno-79-150" name="__codelineno-79-150" href="#__codelineno-79-150"></a><span class="s2">    objective: str</span>
<a id="__codelineno-79-151" name="__codelineno-79-151" href="#__codelineno-79-151"></a><span class="s2">    detail: Optional[str]</span>
<a id="__codelineno-79-152" name="__codelineno-79-152" href="#__codelineno-79-152"></a><span class="s2">    main_points_discussed: Optional[str] (bullet points with relevant topics)</span>
<a id="__codelineno-79-153" name="__codelineno-79-153" href="#__codelineno-79-153"></a><span class="s2">    opportunities_identified: Optional[str] (new business, improvements, mitigated risks)</span>
<a id="__codelineno-79-154" name="__codelineno-79-154" href="#__codelineno-79-154"></a><span class="s2">    next_steps: Optional[str]</span>
<a id="__codelineno-79-155" name="__codelineno-79-155" href="#__codelineno-79-155"></a>
<a id="__codelineno-79-156" name="__codelineno-79-156" href="#__codelineno-79-156"></a><span class="s2">Before saving the report, you must call the report summary tool.</span>
<a id="__codelineno-79-157" name="__codelineno-79-157" href="#__codelineno-79-157"></a><span class="s2">If the user confirms that everything is correct, you must call the save tool.</span>
<a id="__codelineno-79-158" name="__codelineno-79-158" href="#__codelineno-79-158"></a><span class="s2">If they request pre-editing, you must edit the field they requested.</span>
<a id="__codelineno-79-159" name="__codelineno-79-159" href="#__codelineno-79-159"></a><span class="s2">Remember that for participants and companies, you must first check the correct name.</span>
<a id="__codelineno-79-160" name="__codelineno-79-160" href="#__codelineno-79-160"></a>
<a id="__codelineno-79-161" name="__codelineno-79-161" href="#__codelineno-79-161"></a><span class="s2">You have access to several tools:</span>
<a id="__codelineno-79-162" name="__codelineno-79-162" href="#__codelineno-79-162"></a>
<a id="__codelineno-79-163" name="__codelineno-79-163" href="#__codelineno-79-163"></a><span class="s2">* set_var: Use to save the parameters you found during the dialog.</span>
<a id="__codelineno-79-164" name="__codelineno-79-164" href="#__codelineno-79-164"></a><span class="s2">* get_var: Return, if applicable, the value of that variable.</span>
<a id="__codelineno-79-165" name="__codelineno-79-165" href="#__codelineno-79-165"></a><span class="s2">* get_vars: Return all var.</span>
<a id="__codelineno-79-166" name="__codelineno-79-166" href="#__codelineno-79-166"></a><span class="s2">* check_company: Use to check if the company name is correct. The tool will return the most similar ones if not. Use &#39;set_var&#39; to save if correct.</span>
<a id="__codelineno-79-167" name="__codelineno-79-167" href="#__codelineno-79-167"></a><span class="s2">* check_internal_participants: Similar to check_company, checks if those internal participants exist in the database.</span>
<a id="__codelineno-79-168" name="__codelineno-79-168" href="#__codelineno-79-168"></a><span class="s2">* check_external_participants: Similar to check_company, checks if those internal participants exist in the database.</span>
<a id="__codelineno-79-169" name="__codelineno-79-169" href="#__codelineno-79-169"></a><span class="s2">* get_report: Returns the current report to the user in a formatted format.</span>
<a id="__codelineno-79-170" name="__codelineno-79-170" href="#__codelineno-79-170"></a><span class="s2">* save: Saves the report.</span>
<a id="__codelineno-79-171" name="__codelineno-79-171" href="#__codelineno-79-171"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-79-172" name="__codelineno-79-172" href="#__codelineno-79-172"></a>
<a id="__codelineno-79-173" name="__codelineno-79-173" href="#__codelineno-79-173"></a><span class="n">extractor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-79-174" name="__codelineno-79-174" href="#__codelineno-79-174"></a>         <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
<a id="__codelineno-79-175" name="__codelineno-79-175" href="#__codelineno-79-175"></a>         <span class="n">tools</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-79-176" name="__codelineno-79-176" href="#__codelineno-79-176"></a>             <span class="n">set_var</span><span class="p">,</span> <span class="n">get_var</span><span class="p">,</span> <span class="n">get_vars</span><span class="p">,</span> <span class="n">check_company</span><span class="p">,</span> <span class="n">check_internal_participants</span><span class="p">,</span>
<a id="__codelineno-79-177" name="__codelineno-79-177" href="#__codelineno-79-177"></a>             <span class="n">check_external_participants</span><span class="p">,</span> <span class="n">get_report</span><span class="p">,</span> <span class="n">save</span>
<a id="__codelineno-79-178" name="__codelineno-79-178" href="#__codelineno-79-178"></a>         <span class="p">],</span> <span class="n">return_model_state</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-79-179" name="__codelineno-79-179" href="#__codelineno-79-179"></a><span class="p">)</span>
<a id="__codelineno-79-180" name="__codelineno-79-180" href="#__codelineno-79-180"></a>
<a id="__codelineno-79-181" name="__codelineno-79-181" href="#__codelineno-79-181"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux</span><span class="w"> </span><span class="kn">import</span> <span class="n">cprint</span>
<a id="__codelineno-79-182" name="__codelineno-79-182" href="#__codelineno-79-182"></a>
<a id="__codelineno-79-183" name="__codelineno-79-183" href="#__codelineno-79-183"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.models.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelStreamResponse</span>
<a id="__codelineno-79-184" name="__codelineno-79-184" href="#__codelineno-79-184"></a>
<a id="__codelineno-79-185" name="__codelineno-79-185" href="#__codelineno-79-185"></a><span class="n">chat_history</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ChatML</span><span class="p">()</span>
<a id="__codelineno-79-186" name="__codelineno-79-186" href="#__codelineno-79-186"></a>
<a id="__codelineno-79-187" name="__codelineno-79-187" href="#__codelineno-79-187"></a><span class="nb">vars</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-79-188" name="__codelineno-79-188" href="#__codelineno-79-188"></a><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-79-189" name="__codelineno-79-189" href="#__codelineno-79-189"></a>    <span class="n">user</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Type something (or &#39;exit&#39; to quit): &quot;</span><span class="p">)</span>
<a id="__codelineno-79-190" name="__codelineno-79-190" href="#__codelineno-79-190"></a>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">:</span>
<a id="__codelineno-79-191" name="__codelineno-79-191" href="#__codelineno-79-191"></a>        <span class="k">break</span>
<a id="__codelineno-79-192" name="__codelineno-79-192" href="#__codelineno-79-192"></a>
<a id="__codelineno-79-193" name="__codelineno-79-193" href="#__codelineno-79-193"></a>    <span class="c1">#cprint(f&quot;[USER]{user}&quot;, ls=&quot;b&quot;, lc=&quot;c&quot;)</span>
<a id="__codelineno-79-194" name="__codelineno-79-194" href="#__codelineno-79-194"></a>    <span class="n">chat_history</span><span class="o">.</span><span class="n">add_user_message</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a id="__codelineno-79-195" name="__codelineno-79-195" href="#__codelineno-79-195"></a>
<a id="__codelineno-79-196" name="__codelineno-79-196" href="#__codelineno-79-196"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">task_messages</span><span class="o">=</span><span class="n">chat_history</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(),</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>
<a id="__codelineno-79-197" name="__codelineno-79-197" href="#__codelineno-79-197"></a>
<a id="__codelineno-79-198" name="__codelineno-79-198" href="#__codelineno-79-198"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ModelStreamResponse</span><span class="p">):</span>
<a id="__codelineno-79-199" name="__codelineno-79-199" href="#__codelineno-79-199"></a>        <span class="n">assistant</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-79-200" name="__codelineno-79-200" href="#__codelineno-79-200"></a>        <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;[agent] &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="s2">&quot;br4&quot;</span><span class="p">)</span>
<a id="__codelineno-79-201" name="__codelineno-79-201" href="#__codelineno-79-201"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
<a id="__codelineno-79-202" name="__codelineno-79-202" href="#__codelineno-79-202"></a>            <span class="n">cprint</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="s2">&quot;br4&quot;</span><span class="p">)</span>
<a id="__codelineno-79-203" name="__codelineno-79-203" href="#__codelineno-79-203"></a>            <span class="n">assistant</span> <span class="o">+=</span> <span class="n">chunk</span>
<a id="__codelineno-79-204" name="__codelineno-79-204" href="#__codelineno-79-204"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># return direct response</span>
<a id="__codelineno-79-205" name="__codelineno-79-205" href="#__codelineno-79-205"></a>        <span class="n">assistant</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;tool_responses&quot;</span><span class="p">][</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
<a id="__codelineno-79-206" name="__codelineno-79-206" href="#__codelineno-79-206"></a>        <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[agent] </span><span class="si">{</span><span class="n">assistant</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="s2">&quot;br4&quot;</span><span class="p">)</span>
<a id="__codelineno-79-207" name="__codelineno-79-207" href="#__codelineno-79-207"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-79-208" name="__codelineno-79-208" href="#__codelineno-79-208"></a>        <span class="n">assistant</span> <span class="o">=</span> <span class="n">response</span>
<a id="__codelineno-79-209" name="__codelineno-79-209" href="#__codelineno-79-209"></a>        <span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[agent] </span><span class="si">{</span><span class="n">assistant</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">lc</span><span class="o">=</span><span class="s2">&quot;br4&quot;</span><span class="p">)</span>
<a id="__codelineno-79-210" name="__codelineno-79-210" href="#__codelineno-79-210"></a>
<a id="__codelineno-79-211" name="__codelineno-79-211" href="#__codelineno-79-211"></a>    <span class="n">chat_history</span><span class="o">.</span><span class="n">add_assist_message</span><span class="p">(</span><span class="n">assistant</span><span class="p">)</span>
<a id="__codelineno-79-212" name="__codelineno-79-212" href="#__codelineno-79-212"></a>
<a id="__codelineno-79-213" name="__codelineno-79-213" href="#__codelineno-79-213"></a><span class="nb">vars</span>
<a id="__codelineno-79-214" name="__codelineno-79-214" href="#__codelineno-79-214"></a>
<a id="__codelineno-79-215" name="__codelineno-79-215" href="#__codelineno-79-215"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-79-216" name="__codelineno-79-216" href="#__codelineno-79-216"></a><span class="s2">Quero registrar uma visita feita na empresa Globex Corporation.</span>
<a id="__codelineno-79-217" name="__codelineno-79-217" href="#__codelineno-79-217"></a><span class="s2">Participaram o Michael Thompson e a Emily Johnson da nossa equipe.</span>
<a id="__codelineno-79-218" name="__codelineno-79-218" href="#__codelineno-79-218"></a><span class="s2">Do lado deles estavam a Anna Schmidt e o Carlos Fernandez.</span>
</code></pre></div>
<p><strong>Vars as Named Parameters</strong></p>
<p>Another possibility instead of passing <strong>Vars</strong> as a named parameter, you can pass exactly the name of the parameter that is in <strong>Vars</strong>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;api_key&quot;</span><span class="p">])</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">upload</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload user file to bucket&quot;&quot;&quot;</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;my secret key </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;api_key&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>    <span class="k">return</span> <span class="s2">&quot;done&quot;</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">upload</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="s2">&quot;please upload my csv to bucket&quot;</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;key&quot;</span><span class="p">})</span>
</code></pre></div>
<h4 id="generation-schemas"><strong>Generation Schemas</strong></h4>
<p>Generation schemas are guides on how the model should respond in a structured way.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">Struct</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Category</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>    <span class="n">violence</span> <span class="o">=</span> <span class="s2">&quot;violence&quot;</span>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>    <span class="n">sexual</span> <span class="o">=</span> <span class="s2">&quot;sexual&quot;</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>    <span class="n">self_harm</span> <span class="o">=</span> <span class="s2">&quot;self_harm&quot;</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">ContentCompliance</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>    <span class="n">is_violating</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Category</span><span class="p">]</span>
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>    <span class="n">explanation_if_violating</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a><span class="n">system_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a><span class="s2">Determine if the user input violates specific guidelines and explain if they do.</span>
<a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a>
<a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a><span class="n">moderation_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a>    <span class="s2">&quot;moderation&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">generation_schema</span><span class="o">=</span><span class="n">ContentCompliance</span><span class="p">,</span> <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span>
<a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a><span class="p">)</span>
<a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a>
<a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a><span class="n">response</span> <span class="o">=</span> <span class="n">moderation_agent</span><span class="p">(</span><span class="s2">&quot;How do I prepare for a job interview?&quot;</span><span class="p">)</span>
<a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a>
<a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a><span class="n">response</span>
</code></pre></div>
<h5 id="chainofthoughts"><strong>ChainOfThoughts</strong></h5>
<p>Inserts a <code>reasoning</code> field before generating a final answer</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.generation.reasoning</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChainOfThought</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="n">cot_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;cot&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">generation_schema</span><span class="o">=</span><span class="n">ChainOfThought</span><span class="p">)</span>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="n">response</span> <span class="o">=</span> <span class="n">cot_agent</span><span class="p">(</span><span class="s2">&quot;how can I solve 8x + 7 = -23&quot;</span><span class="p">)</span>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="n">response</span>
</code></pre></div>
<h5 id="react"><strong>ReAct</strong></h5>
<p>Inserts a <code>thought</code> before performing tool calling actions</p>
<p><code>tool_choice</code> when used with ReAct is <strong>not</strong> guaranteed to be respected</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">scrape_website</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Receives a URL and returns the page content.&quot;&quot;&quot;</span>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
<a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="p">([</span><span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;style&quot;</span><span class="p">]):</span>
<a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a>            <span class="n">tag</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
<a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>        <span class="n">clean_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>        <span class="k">return</span> <span class="n">clean_text</span>
<a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>
<a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error accessing </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>
<a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a>
<a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.generation.reasoning</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReAct</span>
<a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a>
<a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a>
<a id="__codelineno-83-23" name="__codelineno-83-23" href="#__codelineno-83-23"></a><span class="c1"># return_model_state=True to get the internal state of the agent during execution</span>
<a id="__codelineno-83-24" name="__codelineno-83-24" href="#__codelineno-83-24"></a><span class="n">scraper_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-83-25" name="__codelineno-83-25" href="#__codelineno-83-25"></a>    <span class="s2">&quot;scraper-agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">scrape_website</span><span class="p">],</span> <span class="n">return_model_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-83-26" name="__codelineno-83-26" href="#__codelineno-83-26"></a>    <span class="n">generation_schema</span><span class="o">=</span><span class="n">ReAct</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-83-27" name="__codelineno-83-27" href="#__codelineno-83-27"></a><span class="p">)</span>
<a id="__codelineno-83-28" name="__codelineno-83-28" href="#__codelineno-83-28"></a>
<a id="__codelineno-83-29" name="__codelineno-83-29" href="#__codelineno-83-29"></a><span class="n">site</span> <span class="o">=</span> <span class="s2">&quot;https://bbc.com&quot;</span>
<a id="__codelineno-83-30" name="__codelineno-83-30" href="#__codelineno-83-30"></a><span class="n">response</span> <span class="o">=</span> <span class="n">scraper_agent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summarize the news on this website: </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-83-31" name="__codelineno-83-31" href="#__codelineno-83-31"></a>
<a id="__codelineno-83-32" name="__codelineno-83-32" href="#__codelineno-83-32"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">model_state</span><span class="p">)</span>
<a id="__codelineno-83-33" name="__codelineno-83-33" href="#__codelineno-83-33"></a>
<a id="__codelineno-83-34" name="__codelineno-83-34" href="#__codelineno-83-34"></a><span class="n">response</span><span class="o">.</span><span class="n">model_response</span>
<a id="__codelineno-83-35" name="__codelineno-83-35" href="#__codelineno-83-35"></a>
<a id="__codelineno-83-36" name="__codelineno-83-36" href="#__codelineno-83-36"></a><span class="c1"># the react-agent returns a dict with &#39;current_step&#39; and &#39;final_answer&#39;</span>
<a id="__codelineno-83-37" name="__codelineno-83-37" href="#__codelineno-83-37"></a><span class="c1"># if you want to keep only the &#39;final_answer&#39;, use &#39;response_template&#39;</span>
<a id="__codelineno-83-38" name="__codelineno-83-38" href="#__codelineno-83-38"></a>
<a id="__codelineno-83-39" name="__codelineno-83-39" href="#__codelineno-83-39"></a><span class="n">response_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{{final_answer}}&quot;&quot;&quot;</span>
<a id="__codelineno-83-40" name="__codelineno-83-40" href="#__codelineno-83-40"></a><span class="n">task_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Summarize the news on this site: {{}}&quot;&quot;&quot;</span>
<a id="__codelineno-83-41" name="__codelineno-83-41" href="#__codelineno-83-41"></a>
<a id="__codelineno-83-42" name="__codelineno-83-42" href="#__codelineno-83-42"></a><span class="n">scraper_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-83-43" name="__codelineno-83-43" href="#__codelineno-83-43"></a>    <span class="s2">&quot;scraper-agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">scrape_website</span><span class="p">],</span> <span class="n">response_template</span><span class="o">=</span><span class="n">response_template</span><span class="p">,</span>
<a id="__codelineno-83-44" name="__codelineno-83-44" href="#__codelineno-83-44"></a>    <span class="n">generation_schema</span><span class="o">=</span><span class="n">ReAct</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">task_template</span><span class="o">=</span><span class="n">task_template</span>
<a id="__codelineno-83-45" name="__codelineno-83-45" href="#__codelineno-83-45"></a><span class="p">)</span>
<a id="__codelineno-83-46" name="__codelineno-83-46" href="#__codelineno-83-46"></a><span class="n">response</span> <span class="o">=</span> <span class="n">scraper_agent</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
<a id="__codelineno-83-47" name="__codelineno-83-47" href="#__codelineno-83-47"></a>
<a id="__codelineno-83-48" name="__codelineno-83-48" href="#__codelineno-83-48"></a><span class="n">response</span>
</code></pre></div>
<h5 id="self-consistency"><strong>Self Consistency</strong></h5>
<p>Generates multiple paths of reasoning then decides on the most frequent one</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.generation.reasoning</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelfConsistency</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="n">sc_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;sc&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">generation_schema</span><span class="o">=</span><span class="n">SelfConsistency</span><span class="p">)</span>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="s2">If John is twice as old as Mary and in 10 years their ages will add up to 50, how old is John today?</span>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="n">response</span> <span class="o">=</span> <span class="n">sc_agent</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>
<a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a><span class="n">response</span>
</code></pre></div>
<h4 id="response-template"><strong>Response Template</strong></h4>
<p><code>response_template</code> is responsible for formatting the agent's response.</p>
<p>This is useful if you need to add additional context to the response, or format it if it's structured.</p>
<h5 id="string-based-output"><strong>String-based Output</strong></h5>
<p>Insert {} placeholders to insert model response</p>
<p>We can use <code>response_template</code> with <code>vars</code> to add a greeting to the user without having to tell the template directly.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="n">response_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="s2">{</span><span class="si">% i</span><span class="s2">f user_name %}</span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="s2">Hi {{ user_name }},</span>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="s2">{</span><span class="si">% e</span><span class="s2">ndif %}</span>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="si">{}</span>
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">response_template</span><span class="o">=</span><span class="n">response_template</span><span class="p">)</span>
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="n">agent</span><span class="p">(</span>
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a>    <span class="n">message</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_input&quot;</span><span class="p">:</span> <span class="s2">&quot;Who was Nikola Tesla?&quot;</span><span class="p">},</span>
<a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>    <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Bruce Wayne&quot;</span><span class="p">}</span>
<a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="p">)</span>
</code></pre></div>
<h5 id="dict-based-outputs"><strong>Dict-based Outputs</strong></h5>
<p>Insert Jinja blocks {{ field }} to insert model outputs</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">Struct</span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>    <span class="n">safe</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a>    <span class="n">answer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a>
<a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="n">instructions</span> <span class="o">=</span> <span class="s2">&quot;Only respond to the user if you consider the question safe.&quot;</span>
<a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="n">response_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a><span class="s2">{</span><span class="si">% i</span><span class="s2">f safe %}</span>
<a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="s2">Hi! {{ answer }}</span>
<a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="s2">{</span><span class="si">% e</span><span class="s2">lse %}</span>
<a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a><span class="s2">Sorry but I can&#39;t answer you.</span>
<a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="s2">{</span><span class="si">% e</span><span class="s2">ndif %}</span>
<a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a>    <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
<a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a>    <span class="n">generation_schema</span><span class="o">=</span><span class="n">Output</span><span class="p">,</span> <span class="n">response_template</span><span class="o">=</span><span class="n">response_template</span>
<a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a><span class="p">)</span>
<a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a><span class="n">agent</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Who was Nikola Tesla?&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Let's simulate a user message by combining a structured extraction, <code>vars</code> and <code>response_template</code> to create a pre-formatted response to a customer.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="s2">Hello, my name is John Cena and I work at EcoSupply Ltd., a company focused on the sustainable packaging sector.</span>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="s2">We are facing some significant challenges, mainly high logistics costs and the need for ecological certifications to expand our market presence.</span>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">Struct</span>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>    <span class="n">client_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>    <span class="n">company_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>    <span class="n">industry</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a>    <span class="n">pain_points</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>
<a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a><span class="n">response_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a><span class="s2">Dear {{ client_name }},</span>
<a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a>
<a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a><span class="s2">I understand that your company, {{ company_name}}, works in the field of {{ industry }}.</span>
<a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a><span class="s2">We also recognize that some of your main challenges are</span>
<a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a><span class="s2">{</span><span class="si">%- f</span><span class="s2">or pain in pain_points %}</span>
<a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a><span class="s2"> {{ &quot;- &quot; + pain }}{</span><span class="si">% i</span><span class="s2">f not loop.last %},{</span><span class="si">% e</span><span class="s2">lse %}.{</span><span class="si">% e</span><span class="s2">ndif %}</span>
<a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a><span class="s2">{</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a>
<a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a><span class="s2">Currently, you are relying on {{ current_solution }},</span>
<a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a><span class="s2">but we believe there’s room for improvement.</span>
<a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a>
<a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a><span class="s2">Our solution is designed to address these exact pain points,</span>
<a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a><span class="s2">helping companies like yours reduce costs and meet green compliance standards more efficiently.</span>
<a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a>
<a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a><span class="s2">Best regards,</span>
<a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a><span class="s2">{{ seller }}.</span>
<a id="__codelineno-87-31" name="__codelineno-87-31" href="#__codelineno-87-31"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-87-32" name="__codelineno-87-32" href="#__codelineno-87-32"></a>
<a id="__codelineno-87-33" name="__codelineno-87-33" href="#__codelineno-87-33"></a><span class="nb">vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;seller&quot;</span><span class="p">:</span> <span class="s2">&quot;Hal Jordan&quot;</span><span class="p">}</span>
<a id="__codelineno-87-34" name="__codelineno-87-34" href="#__codelineno-87-34"></a>
<a id="__codelineno-87-35" name="__codelineno-87-35" href="#__codelineno-87-35"></a><span class="n">system_message</span> <span class="o">=</span> <span class="s2">&quot;You are an information extractor.&quot;</span>
<a id="__codelineno-87-36" name="__codelineno-87-36" href="#__codelineno-87-36"></a><span class="n">instructions</span> <span class="o">=</span> <span class="s2">&quot;Your goal is to accurately extract information from the customer&#39;s message.&quot;</span>
<a id="__codelineno-87-37" name="__codelineno-87-37" href="#__codelineno-87-37"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-87-38" name="__codelineno-87-38" href="#__codelineno-87-38"></a>    <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span> <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span>
<a id="__codelineno-87-39" name="__codelineno-87-39" href="#__codelineno-87-39"></a>    <span class="n">generation_schema</span><span class="o">=</span><span class="n">Output</span><span class="p">,</span> <span class="n">response_template</span><span class="o">=</span><span class="n">response_template</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-87-40" name="__codelineno-87-40" href="#__codelineno-87-40"></a><span class="p">)</span>
<a id="__codelineno-87-41" name="__codelineno-87-41" href="#__codelineno-87-41"></a><span class="n">agent</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span>
</code></pre></div>
<h4 id="signature"><strong>Signature</strong></h4>
<p><code>signature</code> is an innovation introduced by DSPy. Where you should focus on declaring the specifications of your task on how it should be performed.</p>
<p>The signature format in string mode is <code>"var: type -&gt; out_var: type"</code></p>
<p>If no <code>type</code> is passed, it will be assumed to be a string.</p>
<p>The <code>"-&gt;"</code> flag separates inputs from outputs. For more than one parameter, separate them with <code>","</code>.</p>
<p>Behind the scenes, the outputs are transformed into a <code>generation_schema</code> to produce JSON output. The output examples also follow this formatting. If <code>typed_parser</code> is passed, the preference is to generate the output and examples based on it.</p>
<h5 id="translation-program"><strong>Translation Program</strong></h5>
<p>Signatures allow a clear and objective description of the task to the agent.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;translator&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="s2">&quot;english -&gt; brazilian&quot;</span><span class="p">)</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="n">agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
</code></pre></div>
<p>A system prompt is automatically created describing inputs and what the outputs should be.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">_get_system_prompt</span><span class="p">())</span>
</code></pre></div>
<p>A <code>task_template</code> is also created, this means that now our inputs are named and need to be a dict.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">({</span><span class="s2">&quot;english&quot;</span><span class="p">:</span> <span class="s2">&quot;hello world&quot;</span><span class="p">})</span>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="n">response</span>
</code></pre></div>
<h5 id="math-program-cot-powered"><strong>Math Program CoT-powered</strong></h5>
<p>Let's create an agent focused on answering questions.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.generation.reasoning</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChainOfThought</span>
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>
<a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="n">phd_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>    <span class="s2">&quot;phd&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="s2">&quot;question -&gt; answer: float&quot;</span><span class="p">,</span>
<a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>    <span class="n">generation_schema</span><span class="o">=</span><span class="n">ChainOfThought</span>
<a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="p">)</span>
<a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>
<a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a><span class="n">phd_agent</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a>
<a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a><span class="n">phd_agent</span><span class="o">.</span><span class="n">task_template</span>
<a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>
<a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a><span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;Two dice are tossed. What is the probability that the sum equals two?&quot;</span><span class="p">}</span>
<a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a><span class="n">model_execution_params</span> <span class="o">=</span> <span class="n">phd_agent</span><span class="o">.</span><span class="n">inspect_model_execution_params</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a>
<a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a><span class="n">model_execution_params</span>
<a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a>
<a id="__codelineno-91-17" name="__codelineno-91-17" href="#__codelineno-91-17"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_execution_params</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">)</span>
<a id="__codelineno-91-18" name="__codelineno-91-18" href="#__codelineno-91-18"></a>
<a id="__codelineno-91-19" name="__codelineno-91-19" href="#__codelineno-91-19"></a><span class="nb">print</span><span class="p">(</span><span class="n">model_execution_params</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-91-20" name="__codelineno-91-20" href="#__codelineno-91-20"></a>
<a id="__codelineno-91-21" name="__codelineno-91-21" href="#__codelineno-91-21"></a><span class="n">response</span> <span class="o">=</span> <span class="n">phd_agent</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
<p>When combined with <code>ChainOfThought</code>, <code>ReAct</code>, or any other generation schema, the signature injects the desired final field into the <code>final_answer</code> field, in this case it is <code>answer</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="n">response</span>
</code></pre></div>
<h5 id="classifier-program"><strong>Classifier Program</strong></h5>
<p>To provide more details about the task parameters, you can create class-based signatures.</p>
<p>The class docstring is the instructions for the agent.</p>
<p>Pass a optional <code>desc</code> for a additional description</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Classify</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Classify sentiment of a given sentence.&quot;&quot;&quot;</span> 
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>    <span class="n">sentence</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">InputField</span><span class="p">()</span>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>    <span class="n">sentiment</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;positive&quot;</span><span class="p">,</span> <span class="s2">&quot;negative&quot;</span><span class="p">,</span> <span class="s2">&quot;neutral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">OutputField</span><span class="p">()</span>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a>    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;[0,1]&quot;</span><span class="p">)</span>
<a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a>
<a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a><span class="n">Classify</span><span class="o">.</span><span class="n">get_str_signature</span><span class="p">()</span>
<a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a>
<a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a><span class="n">Classify</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">()</span>
<a id="__codelineno-93-13" name="__codelineno-93-13" href="#__codelineno-93-13"></a>
<a id="__codelineno-93-14" name="__codelineno-93-14" href="#__codelineno-93-14"></a><span class="n">Classify</span><span class="o">.</span><span class="n">get_inputs_info</span><span class="p">()</span>
<a id="__codelineno-93-15" name="__codelineno-93-15" href="#__codelineno-93-15"></a>
<a id="__codelineno-93-16" name="__codelineno-93-16" href="#__codelineno-93-16"></a><span class="n">Classify</span><span class="o">.</span><span class="n">get_outputs_info</span><span class="p">()</span>
<a id="__codelineno-93-17" name="__codelineno-93-17" href="#__codelineno-93-17"></a>
<a id="__codelineno-93-18" name="__codelineno-93-18" href="#__codelineno-93-18"></a><span class="n">Classify</span><span class="o">.</span><span class="n">get_output_descriptions</span><span class="p">()</span>
<a id="__codelineno-93-19" name="__codelineno-93-19" href="#__codelineno-93-19"></a>
<a id="__codelineno-93-20" name="__codelineno-93-20" href="#__codelineno-93-20"></a><span class="n">classifier_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="n">Classify</span><span class="p">)</span>
<a id="__codelineno-93-21" name="__codelineno-93-21" href="#__codelineno-93-21"></a>
<a id="__codelineno-93-22" name="__codelineno-93-22" href="#__codelineno-93-22"></a><span class="nb">print</span><span class="p">(</span><span class="n">classifier_agent</span><span class="o">.</span><span class="n">_get_system_prompt</span><span class="p">())</span>
<a id="__codelineno-93-23" name="__codelineno-93-23" href="#__codelineno-93-23"></a>
<a id="__codelineno-93-24" name="__codelineno-93-24" href="#__codelineno-93-24"></a><span class="nb">print</span><span class="p">(</span><span class="n">classifier_agent</span><span class="o">.</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-93-25" name="__codelineno-93-25" href="#__codelineno-93-25"></a>
<a id="__codelineno-93-26" name="__codelineno-93-26" href="#__codelineno-93-26"></a><span class="n">classifier_agent</span><span class="p">({</span><span class="s2">&quot;sentence&quot;</span><span class="p">:</span> <span class="s2">&quot;This book was super fun to read, though not the last chapter.&quot;</span><span class="p">})</span>
</code></pre></div>
<h5 id="image-classifer-program"><strong>Image Classifer Program</strong></h5>
<p>Multimodal Language Models <strong>require</strong> an textual instruction.</p>
<p>Therefore, when creating the <code>task_template</code> it will add an Image (or Audio) tag containing the input name</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImageClassifier</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>    <span class="n">photo</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">Image</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">InputField</span><span class="p">()</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">OutputField</span><span class="p">()</span>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;[0,1]&quot;</span><span class="p">)</span>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="n">ImageClassifier</span><span class="o">.</span><span class="n">get_str_signature</span><span class="p">()</span>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="n">img_classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;img_classifier&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="n">ImageClassifier</span><span class="p">)</span>
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a><span class="nb">print</span><span class="p">(</span><span class="n">img_classifier</span><span class="o">.</span><span class="n">_get_system_prompt</span><span class="p">())</span>
<a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>
<a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">img_classifier</span><span class="o">.</span><span class="n">task_template</span><span class="p">)</span>
<a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a>
<a id="__codelineno-94-14" name="__codelineno-94-14" href="#__codelineno-94-14"></a><span class="n">image_path</span> <span class="o">=</span> <span class="s2">&quot;https://nwyarns.com/cdn/shop/articles/Llama_1024x1024.png&quot;</span>
<a id="__codelineno-94-15" name="__codelineno-94-15" href="#__codelineno-94-15"></a>
<a id="__codelineno-94-16" name="__codelineno-94-16" href="#__codelineno-94-16"></a><span class="n">response</span> <span class="o">=</span> <span class="n">img_classifier</span><span class="p">(</span><span class="n">task_multimodal_inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">image_path</span><span class="p">})</span>
<a id="__codelineno-94-17" name="__codelineno-94-17" href="#__codelineno-94-17"></a>
<a id="__codelineno-94-18" name="__codelineno-94-18" href="#__codelineno-94-18"></a><span class="n">response</span>
</code></pre></div>
<h4 id="guardrails"><strong>Guardrails</strong></h4>
<p>Guardrails are security checkers for both model inputs and outputs</p>
<p>A Guardrail can be any callable that receives a <code>data</code> and produces a dictionary containing a <code>safe</code> key, if safe is False, an exception is raised.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="n">moderation_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">moderation</span><span class="p">(</span><span class="s2">&quot;openai/omni-moderation-latest&quot;</span><span class="p">)</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>    <span class="s2">&quot;safe_agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>    <span class="n">input_guardrail</span><span class="o">=</span><span class="n">moderation_model</span><span class="p">,</span> <span class="n">output_guardrail</span><span class="o">=</span><span class="n">moderation_model</span>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="p">)</span>
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a><span class="n">agent</span><span class="p">(</span><span class="s2">&quot;Can you teach me how to make a bomb?&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="model-gateway"><strong>Model Gateway</strong></h4>
<p>When passing an object of type <code>ModelGateway</code> as <code>model</code> you can pass a 'model_preference' informing the <code>model_id</code> of the preferred model.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="n">low_cost_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-nano&quot;</span><span class="p">)</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="n">mid_cost_model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">chat_completion</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4.1-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a><span class="n">model_gateway</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ModelGateway</span><span class="p">([</span><span class="n">low_cost_model</span><span class="p">,</span> <span class="n">mid_cost_model</span><span class="p">])</span>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a><span class="n">model_preference</span><span class="o">=</span><span class="s2">&quot;gpt-4.1-nano&quot;</span>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model_gateway</span><span class="p">)</span>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="s2">&quot;can you tell me a joke?&quot;</span><span class="p">,</span> <span class="n">model_preference</span><span class="o">=</span><span class="n">model_preference</span><span class="p">)</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>
<a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a><span class="n">response</span>
</code></pre></div>
<h4 id="prefilling_1"><strong>Prefilling</strong></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="p">(</span><span class="s2">&quot;What is the derivative of x^(2/3)/&quot;</span><span class="p">,</span> <span class="n">prefilling</span><span class="o">=</span><span class="s2">&quot;Let&#39;s think step by step.&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="trancriber"><strong>Trancriber</strong></h3>
<p><code>nn.Transcriber</code> is a module dedicated to converting speech to text. With it, you can apply granularity, instructions (prompt), use in stream mode, etc.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">speech_to_text</span><span class="p">(</span><span class="s2">&quot;openai/whisper-1&quot;</span><span class="p">)</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="n">transcriber</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Transcriber</span><span class="p">(</span><span class="s2">&quot;transcriber&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="n">transcriber</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
</code></pre></div>
<h3 id="toollibrary"><strong>ToolLibrary</strong></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="c1">#@mf.tool_config(inject_model_state=True)</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">modify</span><span class="p">(</span><span class="n">valor</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">task_messages</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="c1">#def modify(valor: int) -&gt; str:</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>    <span class="c1">#vars = kwargs.get(&quot;vars&quot;)</span>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>    <span class="c1">#vars[&quot;updated&quot;] = True</span>
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>    <span class="k">return</span> <span class="s2">&quot;done&quot;</span>
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a>
<a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a><span class="nd">@mf</span><span class="o">.</span><span class="n">tool_config</span><span class="p">(</span><span class="n">inject_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">modify</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a>    <span class="nb">vars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vars&quot;</span><span class="p">)</span>
<a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>    <span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a>    <span class="k">return</span> <span class="s2">&quot;done&quot;</span>
<a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a>
<a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a><span class="nb">vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a>
<a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a><span class="n">lib</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ToolLibrary</span><span class="p">(</span><span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">modify</span><span class="p">])</span>
<a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a>
<a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a><span class="n">tool_callings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;123121&#39;</span><span class="p">,</span> <span class="s1">&#39;modify&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})]</span>
<a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>
<a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a><span class="n">r</span> <span class="o">=</span> <span class="n">lib</span><span class="p">(</span><span class="n">tool_callings</span><span class="o">=</span><span class="n">tool_callings</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">)</span><span class="c1">#, model_state={&quot;role&quot;: &quot;user&quot;})</span>
<a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a>
<a id="__codelineno-99-22" name="__codelineno-99-22" href="#__codelineno-99-22"></a><span class="nb">vars</span>
<a id="__codelineno-99-23" name="__codelineno-99-23" href="#__codelineno-99-23"></a>
<a id="__codelineno-99-24" name="__codelineno-99-24" href="#__codelineno-99-24"></a><span class="n">r</span>
</code></pre></div>
<p>task = "A fintech startup offering digital wallets for small retailers."</p>
<p>response = sales_agent(task)</p>
<p>print(response)
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>To add dynamism to the system prompt you can combine it with **vars**.
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a>
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>Insert a Jinja placeholder in any system prompt component.
<a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a>
<a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a>```python
<a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a>system_extra_message=&quot;&quot;&quot;
<a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a>The customer&#39;s name is {{costumer_name}}. Treat him politely.
<a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a>&quot;&quot;&quot;
<a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a>
<a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a>sales_agent = nn.Agent(
<a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a>    &quot;sales-agent&quot;,
<a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a>    model,
<a id="__codelineno-100-13" name="__codelineno-100-13" href="#__codelineno-100-13"></a>    system_message=system_message,
<a id="__codelineno-100-14" name="__codelineno-100-14" href="#__codelineno-100-14"></a>    instructions=instructions,
<a id="__codelineno-100-15" name="__codelineno-100-15" href="#__codelineno-100-15"></a>    expected_output=expected_output,
<a id="__codelineno-100-16" name="__codelineno-100-16" href="#__codelineno-100-16"></a>    system_extra_message=system_extra_message
<a id="__codelineno-100-17" name="__codelineno-100-17" href="#__codelineno-100-17"></a>)
<a id="__codelineno-100-18" name="__codelineno-100-18" href="#__codelineno-100-18"></a>
<a id="__codelineno-100-19" name="__codelineno-100-19" href="#__codelineno-100-19"></a>model_execution_params = sales_agent.inspect_model_execution_params(
<a id="__codelineno-100-20" name="__codelineno-100-20" href="#__codelineno-100-20"></a>    task, vars={&quot;costumer_name&quot;: &quot;Clark&quot;}
<a id="__codelineno-100-21" name="__codelineno-100-21" href="#__codelineno-100-21"></a>)
<a id="__codelineno-100-22" name="__codelineno-100-22" href="#__codelineno-100-22"></a>
<a id="__codelineno-100-23" name="__codelineno-100-23" href="#__codelineno-100-23"></a>print(model_execution_params.system_prompt)
</code></pre></div></p>
<h5 id="examples"><strong>Examples</strong></h5>
<p>There are three ways to pass examples to Agent</p>
<h6 id="based-on-string"><strong>Based-on String</strong></h6>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="n">examples</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="s2">Input: &quot;A startup offering AI tools for logistics companies.&quot;</span>
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="s2">Output:</span>
<a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="s2">- Identified Needs: Optimization of supply chain operations</span>
<a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a><span class="s2">- Strategy: Highlight cost savings and automation</span>
<a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a><span class="s2">- Value Proposition: Reduce operational delays through predictive analytics</span>
<a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a>
<a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a><span class="n">sales_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a>    <span class="s2">&quot;sales-agent&quot;</span><span class="p">,</span>
<a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a>    <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-101-12" name="__codelineno-101-12" href="#__codelineno-101-12"></a>    <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span>
<a id="__codelineno-101-13" name="__codelineno-101-13" href="#__codelineno-101-13"></a>    <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
<a id="__codelineno-101-14" name="__codelineno-101-14" href="#__codelineno-101-14"></a>    <span class="n">expected_output</span><span class="o">=</span><span class="n">expected_output</span><span class="p">,</span>
<a id="__codelineno-101-15" name="__codelineno-101-15" href="#__codelineno-101-15"></a>    <span class="n">system_extra_message</span><span class="o">=</span><span class="n">system_extra_message</span><span class="p">,</span>
<a id="__codelineno-101-16" name="__codelineno-101-16" href="#__codelineno-101-16"></a>    <span class="n">include_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-101-17" name="__codelineno-101-17" href="#__codelineno-101-17"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-101-18" name="__codelineno-101-18" href="#__codelineno-101-18"></a>    <span class="n">examples</span><span class="o">=</span><span class="n">examples</span>
<a id="__codelineno-101-19" name="__codelineno-101-19" href="#__codelineno-101-19"></a><span class="p">)</span>
<a id="__codelineno-101-20" name="__codelineno-101-20" href="#__codelineno-101-20"></a>
<a id="__codelineno-101-21" name="__codelineno-101-21" href="#__codelineno-101-21"></a><span class="nb">print</span><span class="p">(</span><span class="n">sales_agent</span><span class="o">.</span><span class="n">_get_system_prompt</span><span class="p">())</span>
</code></pre></div>
<h6 id="based-on-example-cls"><strong>Based-on Example cls</strong></h6>
<p>Examples are automatically formatted using xml tags</p>
<p>Only inputs and labels are required</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>    <span class="n">mf</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span>
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>        <span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;A fintech offering digital wallets for small retailers.&quot;</span><span class="p">,</span>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>        <span class="n">labels</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>            <span class="s2">&quot;Identified Needs&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment integration and customer trust&quot;</span><span class="p">,</span>
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a>            <span class="s2">&quot;Strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;Position product as secure and easy-to-use&quot;</span><span class="p">,</span>
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>            <span class="s2">&quot;Value Proposition&quot;</span><span class="p">:</span> <span class="s2">&quot;Simplify digital payments for underserved markets&quot;</span>
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>        <span class="p">},</span>
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a>        <span class="n">reasoning</span><span class="o">=</span><span class="s2">&quot;Small retailers struggle with adoption of digital payments; focusing on trust and ease is key.&quot;</span><span class="p">,</span>
<a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Fintech Lead Qualification&quot;</span><span class="p">,</span>
<a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a>        <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;Sales&quot;</span>
<a id="__codelineno-102-12" name="__codelineno-102-12" href="#__codelineno-102-12"></a>    <span class="p">),</span>
<a id="__codelineno-102-13" name="__codelineno-102-13" href="#__codelineno-102-13"></a>    <span class="n">mf</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span>
<a id="__codelineno-102-14" name="__codelineno-102-14" href="#__codelineno-102-14"></a>        <span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;An e-commerce platform specializing in handmade crafts.&quot;</span><span class="p">,</span>
<a id="__codelineno-102-15" name="__codelineno-102-15" href="#__codelineno-102-15"></a>        <span class="n">labels</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-102-16" name="__codelineno-102-16" href="#__codelineno-102-16"></a>            <span class="s2">&quot;Identified Needs&quot;</span><span class="p">:</span> <span class="s2">&quot;Increase visibility and expand market reach&quot;</span><span class="p">,</span>
<a id="__codelineno-102-17" name="__codelineno-102-17" href="#__codelineno-102-17"></a>            <span class="s2">&quot;Strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;Suggest cross-promotion with eco-friendly marketplaces&quot;</span><span class="p">,</span>
<a id="__codelineno-102-18" name="__codelineno-102-18" href="#__codelineno-102-18"></a>            <span class="s2">&quot;Value Proposition&quot;</span><span class="p">:</span> <span class="s2">&quot;Provide artisans with access to a global audience&quot;</span>
<a id="__codelineno-102-19" name="__codelineno-102-19" href="#__codelineno-102-19"></a>        <span class="p">},</span>
<a id="__codelineno-102-20" name="__codelineno-102-20" href="#__codelineno-102-20"></a>        <span class="n">reasoning</span><span class="o">=</span><span class="s2">&quot;Handmade crafts have strong niche appeal; scaling depends on visibility and partnerships.&quot;</span><span class="p">,</span>
<a id="__codelineno-102-21" name="__codelineno-102-21" href="#__codelineno-102-21"></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;E-commerce Lead Qualification&quot;</span><span class="p">,</span>
<a id="__codelineno-102-22" name="__codelineno-102-22" href="#__codelineno-102-22"></a>        <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;Sales&quot;</span>
<a id="__codelineno-102-23" name="__codelineno-102-23" href="#__codelineno-102-23"></a>    <span class="p">),</span>
<a id="__codelineno-102-24" name="__codelineno-102-24" href="#__codelineno-102-24"></a><span class="p">]</span>
<a id="__codelineno-102-25" name="__codelineno-102-25" href="#__codelineno-102-25"></a>
<a id="__codelineno-102-26" name="__codelineno-102-26" href="#__codelineno-102-26"></a><span class="n">sales_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-102-27" name="__codelineno-102-27" href="#__codelineno-102-27"></a>    <span class="s2">&quot;sales-agent&quot;</span><span class="p">,</span>
<a id="__codelineno-102-28" name="__codelineno-102-28" href="#__codelineno-102-28"></a>    <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-102-29" name="__codelineno-102-29" href="#__codelineno-102-29"></a>    <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span>
<a id="__codelineno-102-30" name="__codelineno-102-30" href="#__codelineno-102-30"></a>    <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
<a id="__codelineno-102-31" name="__codelineno-102-31" href="#__codelineno-102-31"></a>    <span class="n">expected_output</span><span class="o">=</span><span class="n">expected_output</span><span class="p">,</span>
<a id="__codelineno-102-32" name="__codelineno-102-32" href="#__codelineno-102-32"></a>    <span class="n">system_extra_message</span><span class="o">=</span><span class="n">system_extra_message</span><span class="p">,</span>
<a id="__codelineno-102-33" name="__codelineno-102-33" href="#__codelineno-102-33"></a>    <span class="n">include_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-102-34" name="__codelineno-102-34" href="#__codelineno-102-34"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-102-35" name="__codelineno-102-35" href="#__codelineno-102-35"></a>    <span class="n">examples</span><span class="o">=</span><span class="n">examples</span>
<a id="__codelineno-102-36" name="__codelineno-102-36" href="#__codelineno-102-36"></a><span class="p">)</span>
<a id="__codelineno-102-37" name="__codelineno-102-37" href="#__codelineno-102-37"></a>
<a id="__codelineno-102-38" name="__codelineno-102-38" href="#__codelineno-102-38"></a><span class="nb">print</span><span class="p">(</span><span class="n">sales_agent</span><span class="o">.</span><span class="n">_get_system_prompt</span><span class="p">())</span>
</code></pre></div>
<h6 id="based-on-dict"><strong>Based-on Dict</strong></h6>
<p>Dict-based examples are transformed into Example</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a>    <span class="p">{</span>
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a>        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="s2">&quot;A startup offering AI tools for logistics companies.&quot;</span><span class="p">,</span>
<a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a>            <span class="s2">&quot;Identified Needs&quot;</span><span class="p">:</span> <span class="s2">&quot;Optimization of supply chain operations&quot;</span><span class="p">,</span>
<a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a>            <span class="s2">&quot;Strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;Highlight cost savings and automation&quot;</span><span class="p">,</span>
<a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a>            <span class="s2">&quot;Value Proposition&quot;</span><span class="p">:</span> <span class="s2">&quot;Reduce operational delays through predictive analytics&quot;</span>
<a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a>        <span class="p">},</span>
<a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a>    <span class="p">},</span>
<a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a>    <span class="p">{</span>
<a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a>        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="s2">&quot;An e-commerce platform specializing in handmade crafts.&quot;</span><span class="p">,</span>
<a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a>        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a>            <span class="s2">&quot;Identified Needs&quot;</span><span class="p">:</span> <span class="s2">&quot;Increase visibility and expand market reach&quot;</span><span class="p">,</span>
<a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a>            <span class="s2">&quot;Strategy&quot;</span><span class="p">:</span> <span class="s2">&quot;Suggest cross-promotion with eco-friendly marketplaces&quot;</span><span class="p">,</span>
<a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a>            <span class="s2">&quot;Value Proposition&quot;</span><span class="p">:</span> <span class="s2">&quot;Provide artisans with access to a global audience&quot;</span>
<a id="__codelineno-103-16" name="__codelineno-103-16" href="#__codelineno-103-16"></a>        <span class="p">},</span>
<a id="__codelineno-103-17" name="__codelineno-103-17" href="#__codelineno-103-17"></a>    <span class="p">},</span>
<a id="__codelineno-103-18" name="__codelineno-103-18" href="#__codelineno-103-18"></a><span class="p">]</span>
<a id="__codelineno-103-19" name="__codelineno-103-19" href="#__codelineno-103-19"></a><span class="n">sales_agent</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-103-20" name="__codelineno-103-20" href="#__codelineno-103-20"></a>    <span class="s2">&quot;sales-agent&quot;</span><span class="p">,</span>
<a id="__codelineno-103-21" name="__codelineno-103-21" href="#__codelineno-103-21"></a>    <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-103-22" name="__codelineno-103-22" href="#__codelineno-103-22"></a>    <span class="n">system_message</span><span class="o">=</span><span class="n">system_message</span><span class="p">,</span>
<a id="__codelineno-103-23" name="__codelineno-103-23" href="#__codelineno-103-23"></a>    <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
<a id="__codelineno-103-24" name="__codelineno-103-24" href="#__codelineno-103-24"></a>    <span class="n">expected_output</span><span class="o">=</span><span class="n">expected_output</span><span class="p">,</span>
<a id="__codelineno-103-25" name="__codelineno-103-25" href="#__codelineno-103-25"></a>    <span class="n">system_extra_message</span><span class="o">=</span><span class="n">system_extra_message</span><span class="p">,</span>
<a id="__codelineno-103-26" name="__codelineno-103-26" href="#__codelineno-103-26"></a>    <span class="n">include_date</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-103-27" name="__codelineno-103-27" href="#__codelineno-103-27"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-103-28" name="__codelineno-103-28" href="#__codelineno-103-28"></a>    <span class="n">examples</span><span class="o">=</span><span class="n">examples</span>
<a id="__codelineno-103-29" name="__codelineno-103-29" href="#__codelineno-103-29"></a><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a>
</code></pre></div>
<h2 id="the-modelgateway-class">The <code>ModelGateway</code> Class</h2>
<p>The <code>ModelGateway</code> class is an <strong>orchestration layer</strong> over multiple models of the same type (e.g., multiple <code>chat_completion</code> models), allowing:</p>
<ul>
<li>🔁 <strong>Automatic fallback</strong> between models.</li>
<li>⏱️ <strong>Time-based</strong> model availability constraints.</li>
<li>✅ <strong>Model preference</strong> selection.</li>
<li>📃 <strong>Control of execution attempts</strong> with exception handling.</li>
<li>🔎 <strong>Consistent model typing validation</strong>.</li>
</ul>
<p>It's ideal for production-grade model orchestration where reliability and control over model usage are required.</p>
<p>All you need is:</p>
<ul>
<li>All models <strong>must inherit from <code>BaseModel</code></strong>.</li>
<li>All models <strong>must be of the same <code>model_type</code></strong>.</li>
<li>At least <strong>2 models</strong> must be provided.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.models.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.models.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatCompletionModel</span>
<a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgflux.models.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelResponse</span>
<a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>
<a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a>
<a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProviderAChatCompletion</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">ChatCompletionModel</span><span class="p">):</span>
<a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="s2">&quot;provider_a&quot;</span>
<a id="__codelineno-105-8" name="__codelineno-105-8" href="#__codelineno-105-8"></a>
<a id="__codelineno-105-9" name="__codelineno-105-9" href="#__codelineno-105-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-105-10" name="__codelineno-105-10" href="#__codelineno-105-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-105-11" name="__codelineno-105-11" href="#__codelineno-105-11"></a>
<a id="__codelineno-105-12" name="__codelineno-105-12" href="#__codelineno-105-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-105-13" name="__codelineno-105-13" href="#__codelineno-105-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
<a id="__codelineno-105-14" name="__codelineno-105-14" href="#__codelineno-105-14"></a>
<a id="__codelineno-105-15" name="__codelineno-105-15" href="#__codelineno-105-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-105-16" name="__codelineno-105-16" href="#__codelineno-105-16"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">ModelResponse</span><span class="p">()</span>
<a id="__codelineno-105-17" name="__codelineno-105-17" href="#__codelineno-105-17"></a>        <span class="n">response</span><span class="o">.</span><span class="n">set_response_type</span><span class="p">(</span><span class="s2">&quot;text_generation&quot;</span><span class="p">)</span>
<a id="__codelineno-105-18" name="__codelineno-105-18" href="#__codelineno-105-18"></a>        <span class="n">response</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Response from Provider A&quot;</span><span class="p">)</span>
<a id="__codelineno-105-19" name="__codelineno-105-19" href="#__codelineno-105-19"></a>        <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-105-20" name="__codelineno-105-20" href="#__codelineno-105-20"></a>
<a id="__codelineno-105-21" name="__codelineno-105-21" href="#__codelineno-105-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProviderBChatCompletion</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">ChatCompletionModel</span><span class="p">):</span>
<a id="__codelineno-105-22" name="__codelineno-105-22" href="#__codelineno-105-22"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="s2">&quot;provider_b&quot;</span>
<a id="__codelineno-105-23" name="__codelineno-105-23" href="#__codelineno-105-23"></a>
<a id="__codelineno-105-24" name="__codelineno-105-24" href="#__codelineno-105-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-105-25" name="__codelineno-105-25" href="#__codelineno-105-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-105-26" name="__codelineno-105-26" href="#__codelineno-105-26"></a>
<a id="__codelineno-105-27" name="__codelineno-105-27" href="#__codelineno-105-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-105-28" name="__codelineno-105-28" href="#__codelineno-105-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
<a id="__codelineno-105-29" name="__codelineno-105-29" href="#__codelineno-105-29"></a>
<a id="__codelineno-105-30" name="__codelineno-105-30" href="#__codelineno-105-30"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-105-31" name="__codelineno-105-31" href="#__codelineno-105-31"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">ModelResponse</span><span class="p">()</span>
<a id="__codelineno-105-32" name="__codelineno-105-32" href="#__codelineno-105-32"></a>        <span class="n">response</span><span class="o">.</span><span class="n">set_response_type</span><span class="p">(</span><span class="s2">&quot;text_generation&quot;</span><span class="p">)</span>
<a id="__codelineno-105-33" name="__codelineno-105-33" href="#__codelineno-105-33"></a>        <span class="n">response</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Response from Provider B&quot;</span><span class="p">)</span>
<a id="__codelineno-105-34" name="__codelineno-105-34" href="#__codelineno-105-34"></a>        <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-105-35" name="__codelineno-105-35" href="#__codelineno-105-35"></a>
<a id="__codelineno-105-36" name="__codelineno-105-36" href="#__codelineno-105-36"></a><span class="c1"># Simulate a model that fails</span>
<a id="__codelineno-105-37" name="__codelineno-105-37" href="#__codelineno-105-37"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProviderFailureModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">ChatCompletionModel</span><span class="p">):</span>
<a id="__codelineno-105-38" name="__codelineno-105-38" href="#__codelineno-105-38"></a>    <span class="n">provider</span> <span class="o">=</span> <span class="s2">&quot;provider_failure&quot;</span>
<a id="__codelineno-105-39" name="__codelineno-105-39" href="#__codelineno-105-39"></a>
<a id="__codelineno-105-40" name="__codelineno-105-40" href="#__codelineno-105-40"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-105-41" name="__codelineno-105-41" href="#__codelineno-105-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-105-42" name="__codelineno-105-42" href="#__codelineno-105-42"></a>
<a id="__codelineno-105-43" name="__codelineno-105-43" href="#__codelineno-105-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-105-44" name="__codelineno-105-44" href="#__codelineno-105-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
<a id="__codelineno-105-45" name="__codelineno-105-45" href="#__codelineno-105-45"></a>
<a id="__codelineno-105-46" name="__codelineno-105-46" href="#__codelineno-105-46"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-105-47" name="__codelineno-105-47" href="#__codelineno-105-47"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulate failure&quot;</span><span class="p">)</span>
<a id="__codelineno-105-48" name="__codelineno-105-48" href="#__codelineno-105-48"></a>
<a id="__codelineno-105-49" name="__codelineno-105-49" href="#__codelineno-105-49"></a><span class="n">provider_a</span> <span class="o">=</span> <span class="n">ProviderAChatCompletion</span><span class="p">(</span><span class="s2">&quot;gork-3&quot;</span><span class="p">)</span>
<a id="__codelineno-105-50" name="__codelineno-105-50" href="#__codelineno-105-50"></a><span class="n">provider_b</span> <span class="o">=</span> <span class="n">ProviderBChatCompletion</span><span class="p">(</span><span class="s2">&quot;behemoth&quot;</span><span class="p">)</span>
<a id="__codelineno-105-51" name="__codelineno-105-51" href="#__codelineno-105-51"></a><span class="n">provider_failure</span> <span class="o">=</span> <span class="n">ProviderFailureModel</span><span class="p">(</span><span class="s2">&quot;breaker&quot;</span><span class="p">)</span>
<a id="__codelineno-105-52" name="__codelineno-105-52" href="#__codelineno-105-52"></a>
<a id="__codelineno-105-53" name="__codelineno-105-53" href="#__codelineno-105-53"></a><span class="n">gateway_broken</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ModelGateway</span><span class="p">([</span><span class="n">provider_a</span><span class="p">,</span> <span class="n">provider_b</span><span class="p">,</span> <span class="n">provider_failure</span><span class="p">])</span>
<a id="__codelineno-105-54" name="__codelineno-105-54" href="#__codelineno-105-54"></a><span class="n">response</span> <span class="o">=</span> <span class="n">gateway_broken</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Who were Warren McCulloch and Walter Pitts?&quot;</span><span class="p">)</span>
<a id="__codelineno-105-55" name="__codelineno-105-55" href="#__codelineno-105-55"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">())</span>
<a id="__codelineno-105-56" name="__codelineno-105-56" href="#__codelineno-105-56"></a>
<a id="__codelineno-105-57" name="__codelineno-105-57" href="#__codelineno-105-57"></a><span class="c1"># pass a preference model</span>
<a id="__codelineno-105-58" name="__codelineno-105-58" href="#__codelineno-105-58"></a><span class="n">gateway_broken</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ModelGateway</span><span class="p">([</span><span class="n">provider_a</span><span class="p">,</span> <span class="n">provider_b</span><span class="p">,</span> <span class="n">provider_failure</span><span class="p">])</span>
<a id="__codelineno-105-59" name="__codelineno-105-59" href="#__codelineno-105-59"></a><span class="n">response</span> <span class="o">=</span> <span class="n">gateway_broken</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Who were Warren McCulloch and Walter Pitts?&quot;</span><span class="p">,</span>
<a id="__codelineno-105-60" name="__codelineno-105-60" href="#__codelineno-105-60"></a>                          <span class="n">model_preference</span><span class="o">=</span><span class="s2">&quot;behemoth&quot;</span><span class="p">)</span>
<a id="__codelineno-105-61" name="__codelineno-105-61" href="#__codelineno-105-61"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">())</span>
<a id="__codelineno-105-62" name="__codelineno-105-62" href="#__codelineno-105-62"></a>
<a id="__codelineno-105-63" name="__codelineno-105-63" href="#__codelineno-105-63"></a><span class="c1"># simulate a failure</span>
<a id="__codelineno-105-64" name="__codelineno-105-64" href="#__codelineno-105-64"></a><span class="n">gateway_broken</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ModelGateway</span><span class="p">([</span><span class="n">provider_failure</span><span class="p">,</span> <span class="n">provider_a</span><span class="p">,</span> <span class="n">provider_b</span><span class="p">])</span>
<a id="__codelineno-105-65" name="__codelineno-105-65" href="#__codelineno-105-65"></a><span class="n">response</span> <span class="o">=</span> <span class="n">gateway_broken</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Who were Warren McCulloch and Walter Pitts?&quot;</span><span class="p">,</span>
<a id="__codelineno-105-66" name="__codelineno-105-66" href="#__codelineno-105-66"></a>                          <span class="n">model_preference</span><span class="o">=</span><span class="s2">&quot;breaker&quot;</span><span class="p">)</span>
<a id="__codelineno-105-67" name="__codelineno-105-67" href="#__codelineno-105-67"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">())</span>
<a id="__codelineno-105-68" name="__codelineno-105-68" href="#__codelineno-105-68"></a>
<a id="__codelineno-105-69" name="__codelineno-105-69" href="#__codelineno-105-69"></a><span class="c1"># time_constraints {&#39;model-A&#39;: [(&#39;22:00&#39;, &#39;06:00&#39;)]}</span>
<a id="__codelineno-105-70" name="__codelineno-105-70" href="#__codelineno-105-70"></a><span class="n">gateway_broken</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">ModelGateway</span><span class="p">([</span><span class="n">provider_a</span><span class="p">,</span> <span class="n">provider_b</span><span class="p">],</span> <span class="n">time_constraints</span><span class="p">)</span>
<a id="__codelineno-105-71" name="__codelineno-105-71" href="#__codelineno-105-71"></a><span class="n">response</span> <span class="o">=</span> <span class="n">gateway_broken</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Who were Warren McCulloch and Walter Pitts?&quot;</span><span class="p">,</span>
<a id="__codelineno-105-72" name="__codelineno-105-72" href="#__codelineno-105-72"></a>                          <span class="n">model_preference</span><span class="o">=</span><span class="s2">&quot;breaker&quot;</span><span class="p">)</span>
<a id="__codelineno-105-73" name="__codelineno-105-73" href="#__codelineno-105-73"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">consume</span><span class="p">())</span>
<a id="__codelineno-105-74" name="__codelineno-105-74" href="#__codelineno-105-74"></a>
<a id="__codelineno-105-75" name="__codelineno-105-75" href="#__codelineno-105-75"></a><span class="n">gateway_broken</span><span class="o">.</span><span class="n">get_available_models</span><span class="p">()</span>
<a id="__codelineno-105-76" name="__codelineno-105-76" href="#__codelineno-105-76"></a>
<a id="__codelineno-105-77" name="__codelineno-105-77" href="#__codelineno-105-77"></a><span class="n">gateway_broken</span><span class="o">.</span><span class="n">get_model_info</span><span class="p">()</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Vilson Rodrigues
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.indexes", "navigation.top", "header.autohide", "blog", "content.code.copy", "navigation.tracking"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
    
  </body>
</html>